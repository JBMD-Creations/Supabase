<!DOCTYPE html>
<!--
    HD Flowsheet & QA Tracker
    Version: 1.9.16
    Date: January 5, 2026

    CHANGELOG:
    v1.9.16 - Floating Navigation Sidebar
        - NEW: Floating navigation sidebar on the left side of the page
        - Quick access to all main tabs (Pt Charting, Operations, Reports)
        - Sub-tabs indented under each main tab (Checklists, Labs under Operations; End of Shift under Reports)
        - Toggle button to collapse/expand the sidebar
        - Remembers collapsed state across sessions
        - Automatically syncs with main navigation tabs
        - Smooth scroll to top when navigating
    v1.9.12 - Wheelchair Weight Calculation for TCH Patients
        - NEW: Wheelchair weight calculation sub-section in Weight & UF Management (TCH patients only)
        - Dual-column layout: PRE Weight (arrival) and POST Weight (end of treatment)
        - Add custom equipment items (wheelchair, sling, cushion, etc.) with individual weights
        - Shared equipment list with independent checkboxes per column (uncheck items removed during treatment)
        - Each column has: measured weight input, equipment toggles, calculated actual weight
        - "Use as Pre/Post Weight" buttons auto-fill the respective weight fields
        - Copy buttons for clipboard access to calculated weights
        - Equipment profiles persist by patient initials across sessions
        - Collapsible section, expanded by default for TCH patients
    v1.9.11 - Theme-Aware Snippet Sections & Default Collapsed Sections
        - Pre Dialysis, Post Dialysis, and Treatment Time Documentation sections now use theme colors
        - Removed hardcoded blue/orange backgrounds that clashed with selected themes
        - Assignment and Treatment Orders sections now collapsed by default for new patients
        - Reduces visual clutter while keeping sections easily expandable
    v1.9.10 - Patient Chart Section Reordering
        - Drag and drop reordering for patient chart toggle sections
        - Expand All / Collapse All buttons in Quick View header
        - Section order is saved and persists across sessions
        - Drag handle (⋮⋮) on each section header for easy reordering
    v1.9.9 - Operations Checklist Enhancements
        - Drag and drop reordering for checklist items
        - URL link support: Add URLs to checklist items with "Open Link" button
        - Folders: Organize checklist items into collapsible folders (e.g., TCH, East B Side, East A Side)
        - Add/edit/delete folders with custom names
        - Folder dropdown when adding items, or drag items between folders
        - Item editor modal for adding/editing items with URL
    v1.9.8 - Operations Tab with Editable Checklists
        - New top-level navigation: Pt Charting / Operations tabs
        - Operations page with user-editable checklists for morning/end of shift routines
        - Create multiple checklists for different positions
        - Add/edit/delete checklist items without code changes
        - Daily progress tracking with automatic reset
        - Data persistence: localStorage + server save/load + JSON export/import
        - Checklists survive app updates (stored in localStorage, not code)
    v1.9.7 - Quick Notes Enhancements
        - Added click-to-copy on timestamp log entries
        - New snippets: Midodrine, 100 ml bolus, BP drop > 20, Cramping, UF goal increase
    v1.9.6 - QA Checklist 5-Column Grid Layout
        - Reorganized QA Checklist into horizontal 5-column grid
        - Created new "Misc" toggle box with 30 Min Check, Abx/IDPN, STAT Labs, Labs Prep
        - All 5 boxes (Pre Check, Meds, Misc, Hosp, Missed) now side-by-side
        - Compact layout saves vertical space
    v1.9.5 - Misc To-Do List Feature
        - Added Misc To-Do List section to each patient chart in QA Checklist
        - Add custom to-dos with input field or pre-configured snippet buttons
        - Snippets: Access assessment chart, Foot check, Monthly/Daily progress note, Notify MD/NP, PHN Call
        - Each to-do has timestamp and checkbox for completion
        - Separate To Do and Complete sections
        - Chart cannot be closed until all to-dos are complete
        - Red exclamation mark on patient tab when incomplete to-dos exist
    v1.9.3 - Chart Closed Feature
        - Added Chart Closed checkbox in QA Checklist (outlined box on right side)
        - When checked, patient tab and flowchart turn green
        - Closed charts automatically move to the right in the tab row
    v1.9.2 - Patient Tab Display Updates
        - Show hospital name instead of status pills when patient is hospitalized
        - Show missed tx type instead of status pills when patient has missed tx
    v1.9.0 - QA Checklist Section Reorder  
        - MOVED: QA Checklist (Pre Check, 30 Min, Meds, etc.) now above Assignment section
        - Order: At a Glance → Tech Check (Missing Items) → QA Checklist → Assignment → Treatment Orders...
    
    v1.8.9 - Tech Check Toggle Expansion
        - CHANGED: Clicking tech check badge now toggles an expanded view below the pod tab
        - Shows missing items constantly visible when expanded (no tooltip)
        - Click again to collapse
        - Same small font styling
    
    v1.8.8 - Tooltip Fix
        - FIXED: Tech check tooltip now appears below badge (not clipped by header)
        - FIXED: Increased z-index for proper layering
    
    v1.8.7 - Tech Check Section
        - NEW: "Tech Check" collapsible section above Assignment
        - NEW: 4 category cards: Main Flowsheet, Dialysis Treatment, Dialysis Meds, Post Dialysis
        - NEW: 8 checkable items to flag missing chart items
        - NEW: Red alert badge on tech's pod tab shows count of missing items
        - NEW: Tooltip on hover shows which patients have which missing items
        - IMPROVED: Checked items highlight red to indicate issues
    
    v1.8.6 - Bug Fix
        - FIXED: "updateSummaryDashboard is not defined" error when switching shifts
    
    v1.8.5 - Smart Shift Assignment
        - NEW: Unassigned patients appear in ALL shift tabs (yellow highlight)
        - NEW: "Unassigned" badge shows on patients without a tech
        - NEW: Assigning a tech automatically sets patient's shift to current tab
        - NEW: Patient counts on shift tabs update dynamically
        - IMPROVED: Single import for all shifts - assign via Quick Assign
        - IMPROVED: No need to import multiple times for different shifts
    
    v1.8.4 - Multi-Shift Support
        - NEW: Shift selector in Import modal (1st, 2nd, 3rd with multi-select)
        - NEW: Shift tabs in main UI header (when multiple shifts selected)
        - NEW: Shift tabs in Quick Assign modal for per-shift tech assignments
        - NEW: Patients filtered by current shift throughout app
        - NEW: Summary dashboard shows stats for current shift only
        - NEW: TCH section added (Chairs 1-5)
        - IMPROVED: Settings button moved to left of header for better access
    
    v1.8.3 - Theme Selector with 6 Color Schemes
        - NEW: Theme selector in Settings modal
        - NEW: 6 professional color themes:
            * Clinical Blue - Classic medical/healthcare
            * Slate Professional - Modern, neutral
            * Sage Medical - Calming green tones
            * Warm Neutral - Soft, approachable
            * Dark Mode - Easy on eyes, modern
            * Navy Professional - Corporate, trustworthy
        - NEW: Theme persists via localStorage
        - IMPROVED: All major UI elements now use theme variables
        - IMPROVED: Quick Chart modal follows theme
    
    v1.8.2 - Quick Chart Modal on Patient Tabs
        - NEW: Quick Chart button (⚡) appears on hover over patient tabs
        - NEW: Quick Chart modal with key editable fields:
            * Weights: Dry, Pre, Goal UF, Post
            * Times: Start Time, End Time
            * Checklist: Pre Check, 30 Min, Meds, Abx/IDPN, STAT Labs, Missed Tx, Whiteboard, Labs Prep, ETT Signed
        - NEW: Red/green field indicators for empty/filled
        - NEW: Changes sync back to main flowsheet on save
    
    v1.8.1 - Vertical Floating Buttons + Quick Notes
        - CHANGED: Floating buttons now stack vertically (top-right)
        - NEW: Quick Notes button (orange) for per-patient notes
        - NEW: Quick Notes modal with auto-save per patient
        - ORDER: Charting → Quick Assign → Quick Notes
    
    v1.8.0 - Pod-Based Navigation with Enhanced Patient Tabs
        - NEW: Pod tabs - group patients by assigned technician
        - NEW: Two-tier navigation: Pod tabs → Patient tabs
        - NEW: Enhanced patient tabs with full status visibility:
            * Pre/Meds/30m/Post completion badges (green=done, red=pending)
            * Time remaining and estimated end time
            * Alert icons with hover tooltips (⚖️ Weight, ⏱️ Time Short, ✍️ ETT)
        - NEW: Chair number displayed prominently in tab header
        - IMPROVED: Cleaner, more compact tab design
        - IMPROVED: Quick visual scan of entire pod's status
    
    v1.7.4 - Sticky Header for Patient Tabs & Assignment Info
        - NEW: Combined assignment info bar + patient tabs into sticky header
        - NEW: Header stays visible at top while scrolling through flowsheet
        - NEW: Purple gradient background matches app theme
        - IMPROVED: Always see which patient you're working on
        - IMPROVED: Quick tab switching without scrolling back up
    
    v1.7.3 - Visual Field Status Indicators on Patient Flowsheet
        - NEW: Key editable fields show RED border/background when empty
        - NEW: Key editable fields show GREEN border/background when filled
        - FIELDS: Pre Weight, Goal UF, Post Weight, Start Time, End Time
        - IMPROVED: Easy visual scan to see what's missing at a glance
        - NOTE: Quick Assign modal keeps normal styling (per user feedback)
    
    v1.7.1 - Bulk Assignment Grid View
        - NEW: "Quick Assign" floating button (green, top-right)
        - NEW: Grid/table view modal showing all patients at once
        - NEW: Inline tech and chair dropdowns for each patient
        - NEW: Pod auto-fills when tech is selected
        - NEW: "Quick Fill" section to bulk-assign selected patients
        - NEW: Select tech + starting chair → auto-increments chairs
        - NEW: Select All / Clear All patient selection buttons
        - NEW: Stats footer showing selected and assigned counts
        - NEW: Save All Changes button applies all assignments at once
        - IMPROVED: Much faster workflow for daily shift setup
    
    v1.6.7 - Critical Bug Fixes
        - FIX: Settings button now visible (purple/blue color instead of transparent white)
        - FIX: Import modal hidden on page load (prevents rendering issues)
        - FIX: Section selector renders properly on page load
        - RESOLVED: "Select Section" box now shows 4 radio buttons (B1, B2, A1, A2)
        - RESOLVED: Settings gear icon (⚙️) now visible in header
    
    v1.6.6 - Clear All Techs Button
        - NEW: "Clear All Techs" button in settings modal for daily tech resets
        - FEATURE: Confirmation dialog before clearing to prevent accidents
        - ENHANCED: Quick daily setup for changing technician schedules
    
    v1.6.5 - Added Info Box to Settings Modal
        - NEW: Blue info box at bottom of settings modal explaining tech-pod assignment
        - FIXED: Info box styling and positioning
    
    v1.6.4 - Section Selection & Tech-Pod Management (Clean Rebuild)
        - NEW: Settings modal (⚙️) for managing technicians with pod assignments
        - NEW: Section selection (B1, B2, A1, A2) in import modal
        - NEW: Each tech assigned to ONE pod - selecting tech auto-fills pod
        - NEW: Chair filtering by section (B1: 1-5,16-20 | B2: 6-15)
        - ENHANCED: localStorage persistence for techs and section selection
        
    v1.6.2 - Two-Row Tab Layout Fix
        - FIXED: Patient tabs now use two-row layout (name on top, indicators on bottom)
        - FIXED: No more horizontal scrolling or overlapping badges
        - ENHANCED: All status info visible at a glance
        - IMPROVED: Clean, readable tab interface with proper spacing
        
    v1.6.1 - Weight/UF Management, Countdown Timer, Additional Snippets
        - NEW: Weight & UF Management category in drawer with auto-calc fields
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD Flowsheet & QA Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ========== THEME CSS VARIABLES ========== */
        :root {
            /* Default Theme: Clinical Blue */
            --theme-primary: #0284c7;
            --theme-primary-dark: #0369a1;
            --theme-primary-light: #bae6fd;
            --theme-primary-bg: #f0f9ff;
            --theme-accent: #22c55e;
            --theme-accent-light: #dcfce7;
            --theme-accent-bg: #f0fdf4;
            --theme-text: #0c4a6e;
            --theme-text-light: #64748b;
            --theme-border: #7dd3fc;
            --theme-bg: #ffffff;
            --theme-bg-alt: #f8fafc;
            --theme-header-gradient: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            --theme-body-gradient: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }
        
        /* Theme: Slate Professional */
        [data-theme="slate"] {
            --theme-primary: #475569;
            --theme-primary-dark: #334155;
            --theme-primary-light: #cbd5e1;
            --theme-primary-bg: #f8fafc;
            --theme-accent: #0d9488;
            --theme-accent-light: #ccfbf1;
            --theme-accent-bg: #f0fdfa;
            --theme-text: #1e293b;
            --theme-text-light: #64748b;
            --theme-border: #cbd5e1;
            --theme-bg: #ffffff;
            --theme-bg-alt: #f8fafc;
            --theme-header-gradient: linear-gradient(135deg, #475569 0%, #334155 100%);
            --theme-body-gradient: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        
        /* Theme: Warm Neutral */
        [data-theme="warm"] {
            --theme-primary: #a8a29e;
            --theme-primary-dark: #78716c;
            --theme-primary-light: #d6d3d1;
            --theme-primary-bg: #fafaf9;
            --theme-accent: #65a30d;
            --theme-accent-light: #ecfccb;
            --theme-accent-bg: #f7fee7;
            --theme-text: #44403c;
            --theme-text-light: #78716c;
            --theme-border: #d6d3d1;
            --theme-bg: #ffffff;
            --theme-bg-alt: #fafaf9;
            --theme-header-gradient: linear-gradient(135deg, #a8a29e 0%, #78716c 100%);
            --theme-body-gradient: linear-gradient(135deg, #d6d3d1 0%, #a8a29e 100%);
        }
        
        /* Theme: Navy Professional */
        [data-theme="navy"] {
            --theme-primary: #2563eb;
            --theme-primary-dark: #1e3a5f;
            --theme-primary-light: #bfdbfe;
            --theme-primary-bg: #eff6ff;
            --theme-accent: #059669;
            --theme-accent-light: #d1fae5;
            --theme-accent-bg: #ecfdf5;
            --theme-text: #1e3a5f;
            --theme-text-light: #64748b;
            --theme-border: #93c5fd;
            --theme-bg: #ffffff;
            --theme-bg-alt: #f8fafc;
            --theme-header-gradient: linear-gradient(135deg, #2563eb 0%, #1e3a5f 100%);
            --theme-body-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        /* Theme: Clinical Blue (explicit) */
        [data-theme="clinical-blue"] {
            --theme-primary: #0284c7;
            --theme-primary-dark: #0369a1;
            --theme-primary-light: #bae6fd;
            --theme-primary-bg: #f0f9ff;
            --theme-accent: #22c55e;
            --theme-accent-light: #dcfce7;
            --theme-accent-bg: #f0fdf4;
            --theme-text: #0c4a6e;
            --theme-text-light: #64748b;
            --theme-border: #7dd3fc;
            --theme-bg: #ffffff;
            --theme-bg-alt: #f8fafc;
            --theme-header-gradient: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            --theme-body-gradient: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        }

        /* Theme: Ultra-Light Clinical */
        [data-theme="ultra-light"] {
            --theme-primary: #2a7de1;
            --theme-primary-dark: #1c5ab0;
            --theme-primary-light: #eef6fc;
            --theme-primary-bg: #f4f8fb;
            --theme-accent: #2a7de1;
            --theme-accent-light: #eef6fc;
            --theme-accent-bg: #f4f8fb;
            --theme-text: #2c3e50;
            --theme-text-light: #546e7a;
            --theme-border: #2a7de1;
            --theme-bg: #ffffff;
            --theme-bg-alt: #f4f8fb;
            --theme-header-gradient: linear-gradient(135deg, #2a7de1 0%, #1c5ab0 100%);
            --theme-body-gradient: linear-gradient(135deg, #f4f8fb 0%, #eef6fc 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--theme-body-gradient);
            min-height: 100vh;
            padding: 15px;
            transition: background 0.3s ease;
        }
        
        /* ========== TOP-LEVEL NAVIGATION ========== */
        .top-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 6px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .top-nav-tab {
            flex: 1;
            padding: 12px 24px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            background: rgba(255, 255, 255, 0.85);
            color: #667eea;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            opacity: 1;
        }
        .top-nav-tab:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .top-nav-tab.active {
            background: white;
            color: var(--theme-primary);
            opacity: 1;
            border: 2px solid var(--theme-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* ========== OPERATIONS PAGE STYLES ========== */
        .operations-page {
            display: none;
        }
        .operations-page.active {
            display: block;
        }
        .pt-charting-page {
            display: none;
        }
        .pt-charting-page.active {
            display: block;
        }

        /* ========== REPORTS PAGE STYLES ========== */
        .reports-page {
            display: none;
        }
        .reports-page.active {
            display: block;
        }
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .reports-title {
            color: white;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .reports-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .reports-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.85);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s;
        }
        .reports-tab:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .reports-tab.active {
            background: white;
            color: var(--theme-primary);
            border: 2px solid var(--theme-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .eosr-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .eosr-section {
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .eosr-section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .eosr-section-content {
            padding: 16px;
        }
        .eosr-entry {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .eosr-entry:last-child {
            margin-bottom: 0;
        }
        .eosr-entry-header {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .eosr-entry-text {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        .eosr-entry-text:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .eosr-empty {
            text-align: center;
            color: #9ca3af;
            padding: 20px;
            font-style: italic;
        }
        .eosr-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .eosr-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .eosr-btn-refresh {
            background: #3b82f6;
            color: white;
        }
        .eosr-btn-refresh:hover {
            background: #2563eb;
        }
        .eosr-btn-copy {
            background: #10b981;
            color: white;
        }
        .eosr-btn-copy:hover {
            background: #059669;
        }
        .eosr-patient-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        .eosr-bullet-placeholder {
            color: #6b7280;
            padding: 8px 0;
            font-size: 16px;
        }
        .eosr-patient-name {
            font-weight: 700;
        }
        .eosr-alert-text {
            font-weight: 700;
            color: #dc2626;
        }
        .eosr-entry-display {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .eosr-entry-display:last-child {
            border-bottom: none;
        }

        .ops-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .ops-title {
            color: white;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .ops-actions {
            display: flex;
            gap: 10px;
        }
        .ops-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ops-btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        .ops-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .ops-btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .ops-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Operations Sub-Tabs (Checklists / Labs) */
        .ops-sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .ops-sub-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.85);
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            cursor: pointer;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s;
        }
        .ops-sub-tab:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(102, 126, 234, 0.5);
        }
        .ops-sub-tab.active {
            background: white;
            color: var(--theme-primary);
            border: 2px solid var(--theme-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .ops-sub-content {
            display: none;
        }
        .ops-sub-content.active {
            display: block;
        }

        /* Labs Section Styles */
        .labs-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .labs-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .labs-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #1e293b;
        }
        .labs-copy-all-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .labs-copy-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .labs-refresh-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .labs-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .labs-input-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .labs-input-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr auto;
            gap: 12px;
            align-items: end;
        }
        .labs-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .labs-input-group label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }
        .labs-input-group input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .labs-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .labs-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            height: fit-content;
        }
        .labs-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .labs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .labs-entry {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .labs-entry-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .labs-entry-main {
            font-weight: 600;
            color: #1e293b;
        }
        .labs-entry-time {
            font-size: 12px;
            color: #6b7280;
        }
        .labs-entry-actions {
            display: flex;
            gap: 8px;
        }
        .labs-copy-btn {
            padding: 6px 14px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .labs-copy-btn:hover {
            background: #2563eb;
        }
        .labs-delete-btn {
            padding: 6px 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .labs-delete-btn:hover {
            background: #dc2626;
        }
        .labs-empty {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
            font-style: italic;
        }
        .labs-entry-synced {
            border-left: 3px solid #10b981;
        }
        .labs-synced-badge {
            display: inline-block;
            background: #d1fae5;
            color: #059669;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
        }

        /* Snippet Manager Styles */
        .snippets-manager-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .snippets-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .snippets-manager-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }
        .snippets-manager-actions {
            display: flex;
            gap: 10px;
        }
        .snippet-config-tabs-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            overflow-x: auto;
        }
        .snippet-config-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }
        .snippet-config-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .snippet-config-tab:hover {
            border-color: var(--theme-primary);
            background: #f8fafc;
        }
        .snippet-config-tab.active {
            background: var(--theme-primary);
            border-color: var(--theme-primary);
            color: white;
        }
        .snippet-config-tab.dragging {
            opacity: 0.5;
        }
        .snippet-config-tab.drag-over-left {
            border-left: 3px solid #10b981;
        }
        .snippet-config-tab.drag-over-right {
            border-right: 3px solid #10b981;
        }
        .snippet-config-tab-name {
            font-weight: 600;
        }
        .snippet-config-tab-edit {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .snippet-config-tab-edit:hover {
            opacity: 1;
        }
        .snippet-config-tab.active .snippet-config-tab-edit {
            opacity: 0.9;
        }
        .snippet-config-tab-add {
            padding: 10px 16px;
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-config-tab-add:hover {
            border-color: var(--theme-primary);
            color: var(--theme-primary);
        }
        .snippet-config-content {
            min-height: 300px;
        }
        .snippet-config-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }
        .snippet-config-empty-icon {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .snippet-config-empty-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            max-width: 400px;
        }
        .snippet-sections-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .snippet-sections-header h4 {
            margin: 0;
            font-size: 1.1em;
            color: #374151;
        }
        .snippet-sections-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .snippet-section-empty {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
            font-style: italic;
        }
        .snippet-section-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .snippet-section-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e5e7eb;
        }
        .snippet-section-card-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .snippet-section-icon {
            font-size: 1.4em;
        }
        .snippet-section-name {
            font-weight: 700;
            font-size: 1.1em;
            color: #1e293b;
        }
        .snippet-section-count {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .snippet-section-card-actions {
            display: flex;
            gap: 8px;
        }
        .snippet-section-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-section-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .snippet-section-btn-danger {
            color: #dc2626;
        }
        .snippet-section-btn-danger:hover {
            background: #fef2f2;
            border-color: #fca5a5;
        }
        .snippet-section-card-body {
            padding: 16px 20px;
        }
        .snippet-items-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .snippet-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            gap: 12px;
        }
        .snippet-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .snippet-item-content {
            flex: 1;
            min-width: 0;
        }
        .snippet-item-text {
            font-size: 14px;
            color: #374151;
            margin-bottom: 8px;
            word-break: break-word;
        }
        .snippet-item-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .snippet-tag {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #4338ca;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
        }
        .snippet-item-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .snippet-item-btn {
            padding: 6px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-item-btn:hover {
            background: #e5e7eb;
        }
        .snippet-item-btn-danger:hover {
            background: #fef2f2;
            border-color: #fca5a5;
        }
        .snippet-add-btn {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-add-btn:hover {
            border-color: var(--theme-primary);
            color: var(--theme-primary);
            background: #f8fafc;
        }

        /* Snippet Modal Styles */
        .snippet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .snippet-modal.open {
            display: flex;
        }
        .snippet-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        .snippet-modal-wide {
            max-width: 600px;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .snippet-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px 16px 0 0;
        }
        .snippet-modal-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e293b;
        }
        .snippet-modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #6b7280;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            transition: color 0.2s;
        }
        .snippet-modal-close:hover {
            color: #ef4444;
        }
        .snippet-modal-body {
            padding: 24px;
        }
        .snippet-modal-field {
            margin-bottom: 20px;
        }
        .snippet-modal-field:last-child {
            margin-bottom: 0;
        }
        .snippet-modal-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .snippet-modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .snippet-modal-input:focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .snippet-modal-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .snippet-modal-textarea:focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .snippet-tag-suggestions-container {
            margin-top: 12px;
        }
        .snippet-tag-suggestions-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .snippet-tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 100px;
            overflow-y: auto;
        }
        .snippet-tag-suggestion {
            display: inline-block;
            padding: 4px 10px;
            background: #f3f4f6;
            color: #4b5563;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-tag-suggestion:hover {
            background: #e0e7ff;
            color: #4338ca;
        }
        .snippet-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 0 0 16px 16px;
        }
        .snippet-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .snippet-modal-cancel {
            background: #f3f4f6;
            color: #4b5563;
        }
        .snippet-modal-cancel:hover {
            background: #e5e7eb;
        }
        .snippet-modal-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .snippet-modal-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .snippet-modal-delete {
            background: #fef2f2;
            color: #dc2626;
            margin-right: auto;
        }
        .snippet-modal-delete:hover {
            background: #fee2e2;
        }

        /* Drawer Tag Filter Styles */
        .drawer-tags-filter {
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        .drawer-tags-filter-title {
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .drawer-tags-filter-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .drawer-tag-filter {
            display: inline-block;
            padding: 4px 10px;
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            font-size: 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .drawer-tag-filter:hover {
            border-color: var(--theme-primary);
            color: var(--theme-primary);
        }
        .drawer-tag-filter.active {
            background: var(--theme-primary);
            border-color: var(--theme-primary);
            color: white;
        }
        .drawer-tag-clear {
            font-size: 11px;
            color: #94a3b8;
            cursor: pointer;
            margin-left: 8px;
        }
        .drawer-tag-clear:hover {
            color: #ef4444;
        }

        /* Checklist Tabs */
        .checklist-tabs-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .checklist-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .checklist-tab {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #374151;
        }
        .checklist-tab:hover {
            border-color: var(--theme-primary);
            background: var(--theme-primary-bg);
        }
        .checklist-tab.active {
            border-color: var(--theme-primary);
            background: var(--theme-primary);
            color: white;
        }
        .checklist-tab-add {
            padding: 12px 20px;
            border: 2px dashed #10b981;
            background: #ecfdf5;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #059669;
            transition: all 0.2s;
        }
        .checklist-tab-add:hover {
            background: #d1fae5;
        }

        /* Checklist Content */
        .checklist-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .checklist-title {
            font-size: 1.4em;
            font-weight: 700;
            color: #1e293b;
        }
        .checklist-position {
            font-size: 0.9em;
            color: #64748b;
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 20px;
        }
        .checklist-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .checklist-progress-bar {
            width: 150px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .checklist-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: width 0.3s;
        }
        .checklist-progress-text {
            font-weight: 600;
            color: #374151;
        }

        /* Checklist Items */
        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .checklist-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .checklist-item.completed {
            background: #ecfdf5;
            border-color: #bbf7d0;
        }
        .checklist-item.completed .checklist-item-text {
            text-decoration: line-through;
            color: #6b7280;
        }
        .checklist-item-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
        .checklist-item-text {
            flex: 1;
            font-size: 1em;
            color: #1e293b;
        }
        .checklist-item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .checklist-item:hover .checklist-item-actions {
            opacity: 1;
        }
        .checklist-item-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .checklist-item-edit {
            background: #e0e7ff;
            color: #4338ca;
        }
        .checklist-item-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        /* Drag and Drop Styles */
        .checklist-item {
            transition: transform 0.15s ease, box-shadow 0.15s ease, margin 0.15s ease;
            position: relative;
        }
        .checklist-item.dragging {
            opacity: 0.7;
            background: #dbeafe;
            border: 2px dashed #3b82f6;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            z-index: 1000;
        }
        .checklist-item.drag-over-top {
            margin-top: 45px;
        }
        .checklist-item.drag-over-top::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        .checklist-item.drag-over-bottom {
            margin-bottom: 45px;
        }
        .checklist-item.drag-over-bottom::after {
            content: '';
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        .checklist-item-drag-handle {
            cursor: grab;
            color: #9ca3af;
            padding: 0 5px;
            font-size: 1.2em;
            transition: color 0.15s ease;
        }
        .checklist-item-drag-handle:hover {
            color: #3b82f6;
        }
        .checklist-item-drag-handle:active {
            cursor: grabbing;
        }
        /* Move buttons */
        .checklist-item-move-btns {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-right: 4px;
        }
        .checklist-move-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 3px;
            cursor: pointer;
            padding: 1px 5px;
            font-size: 10px;
            line-height: 1;
            color: #6b7280;
            transition: all 0.15s ease;
        }
        .checklist-move-btn:hover {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .checklist-move-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* URL Link Styles */
        .checklist-item-link {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.85em;
            padding: 3px 8px;
            background: #eff6ff;
            border-radius: 4px;
            text-decoration: none;
            margin-left: 8px;
        }
        .checklist-item-link:hover {
            background: #dbeafe;
            color: #2563eb;
        }

        /* Folder Tabs Styles */
        .folder-tabs-container {
            margin-bottom: 20px;
        }
        .folder-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 0;
            flex-wrap: wrap;
        }
        .folder-tab {
            padding: 10px 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            top: 2px;
        }
        .folder-tab:hover {
            background: #f3f4f6;
            color: #374151;
        }
        .folder-tab.active {
            background: white;
            color: #2563eb;
            border-color: #2563eb;
            border-bottom: 2px solid white;
            font-weight: 600;
        }
        .folder-tab-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .folder-tab-progress {
            font-size: 0.85em;
            color: #9ca3af;
            margin-left: 4px;
        }
        .folder-tab.active .folder-tab-progress {
            color: #2563eb;
        }
        .folder-tab-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .folder-tab:hover .folder-tab-actions {
            opacity: 1;
        }
        .folder-tab-btn {
            padding: 2px 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .folder-tab-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        .folder-content {
            padding: 15px;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
        .folder-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .checklist-uncategorized {
            margin-bottom: 20px;
        }
        .checklist-uncategorized-title {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        /* Folder Management */
        .folder-add-btn {
            padding: 8px 16px;
            background: #f3e8ff;
            color: #7c3aed;
            border: 2px dashed #c4b5fd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .folder-add-btn:hover {
            background: #ede9fe;
            border-color: #a78bfa;
        }

        /* Item Edit Modal enhancements */
        .item-edit-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        .item-edit-row label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }
        .item-edit-row input, .item-edit-row select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }
        .item-edit-row input:focus, .item-edit-row select:focus {
            border-color: var(--theme-primary);
            outline: none;
        }

        /* Add Item Section */
        .checklist-add-item {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e5e7eb;
        }
        .checklist-add-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }
        .checklist-add-input:focus {
            border-color: var(--theme-primary);
            outline: none;
        }
        .checklist-add-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .checklist-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Checklist Empty State */
        .checklist-empty {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .checklist-empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .checklist-empty-text {
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        /* Checklist Editor Modal */
        .checklist-editor-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .checklist-editor-modal.active {
            display: flex;
        }
        .checklist-editor {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .checklist-editor-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--theme-primary) 0%, var(--theme-primary-dark) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .checklist-editor-title {
            font-size: 1.3em;
            font-weight: 700;
        }
        .checklist-editor-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
        }
        .checklist-editor-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .checklist-editor-field {
            margin-bottom: 20px;
        }
        .checklist-editor-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .checklist-editor-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }
        .checklist-editor-input:focus {
            border-color: var(--theme-primary);
            outline: none;
        }
        .checklist-editor-footer {
            padding: 15px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .checklist-editor-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .checklist-editor-cancel {
            background: #f3f4f6;
            color: #374151;
        }
        .checklist-editor-save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .checklist-editor-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            margin-right: auto;
        }

        .container { max-width: 1600px; margin: 0 auto; }
        h1 {
            text-align: center; color: white; margin-bottom: 8px;
            font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .version {
            text-align: center; color: white; font-size: 0.8em;
            margin-bottom: 15px; opacity: 0.9;
        }
        
        /* Import Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-overlay.hidden { display: none; }
        .modal {
            background: white; border-radius: 12px; padding: 30px;
            max-width: 800px; width: 90%; max-height: 80vh;
            overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal h2 { color: var(--theme-primary); margin-bottom: 20px; font-size: 1.5em; }
        .import-section {
            margin-bottom: 25px; padding: 20px;
            background: #f8f9fa; border-radius: 8px;
        }
        .import-section h3 { color: #495057; margin-bottom: 15px; font-size: 1.1em; }
        .file-upload { display: flex; flex-direction: column; gap: 10px; }
        .file-input-wrapper { position: relative; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        .file-input-label {
            display: block; padding: 12px 20px; background: #667eea;
            color: white; border-radius: 6px; cursor: pointer;
            text-align: center; font-weight: 600; transition: all 0.2s;
        }
        .file-input-label:hover { background: #5568d3; transform: translateY(-2px); }
        .file-name { font-size: 0.9em; color: #6c757d; padding: 8px; }
        .patient-selector { margin-top: 20px; }
        .patient-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .patient-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: default;
            transition: all 0.2s;
            min-width: 280px;
        }
        .patient-item.selected {
            background: #f0f9ff;
            border-color: #3b82f6;
        }
        .patient-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .patient-item input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            cursor: pointer; 
        }
        .patient-initials { 
            font-weight: 700; 
            color: #495057; 
            font-size: 1.1em; 
        }
        .assignment-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .assignment-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #64748b;
        }
        .assignment-select, .assignment-input {
            padding: 8px 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
        }
        .assignment-select:disabled, .assignment-input:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }
        .assignment-select:focus, .assignment-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .patient-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .select-all-btn {
            padding: 8px 16px; background: #28a745; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; margin-bottom: 15px; transition: all 0.2s;
        }
        .select-all-btn:hover { background: #218838; }
        .import-actions {
            display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;
        }
        .btn-import, .btn-skip {
            padding: 12px 30px; border: none; border-radius: 6px;
            font-size: 1.1em; font-weight: 700; cursor: pointer; transition: all 0.2s;
        }
        .btn-import { background: var(--theme-primary); color: white; }
        .btn-import:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-import:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .btn-skip { background: #6c757d; color: white; }
        .btn-skip:hover { background: #5a6268; }
        .import-note {
            background: #d1ecf1; border-left: 4px solid #0c5460;
            padding: 12px; border-radius: 4px; margin-top: 15px;
            font-size: 0.9em; color: #0c5460;
        }
        
        /* Main App */
        .main-app { display: none; }
        .main-app.active { display: block; }
        .import-btn-header {
            background: white; border-radius: 8px;
            padding: 12px; margin-bottom: 12px; text-align: center;
        }
        .btn-reimport {
            padding: 10px 20px; background: #5B9BD5; color: white;
            border: none; border-radius: 6px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-reimport:hover { background: #4A8BC5; transform: translateY(-2px); }
        
        .summary-dashboard {
            background: white; border-radius: 8px; padding: 12px;
            margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .summary-title { font-size: 1em; font-weight: 700; color: var(--theme-primary); margin-bottom: 10px; }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;
        }
        .summary-card {
            background: var(--theme-header-gradient);
            color: white; padding: 12px; border-radius: 8px; text-align: center;
        }
        .summary-label { font-size: 0.8em; opacity: 0.9; margin-bottom: 5px; }
        .summary-value { font-size: 1.6em; font-weight: 700; }
        .summary-card.alert { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .summary-card.success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        
        /* Sticky Header Container */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--theme-header-gradient);
            margin: -15px -15px 15px -15px;
            padding: 12px 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: background 0.3s ease;
        }
        
        /* Pod Tabs Row */
        .pod-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 5px;
        }
        .pod-tabs::-webkit-scrollbar { height: 6px; }
        .pod-tabs::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .pod-tabs::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
        
        .pod-tab {
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 8px 16px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        .pod-tab:hover {
            background: rgba(255,255,255,0.25);
        }
        .pod-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
        }
        .pod-tab .tech-name {
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0.85;
        }
        .pod-tab.active .tech-name {
            color: #64748b;
        }
        .pod-tab .patient-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }
        .pod-tab.active .patient-count {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        /* Patient Tabs Container */
        .patient-tabs-container {
            background: white;
            padding: 10px 12px;
            border-radius: 0 8px 0 0;
            margin-top: -2px;
        }
        .patient-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .patient-tabs::-webkit-scrollbar { height: 6px; }
        .patient-tabs::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .patient-tabs::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Enhanced Patient Tab */
        .patient-tab {
            background: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            min-width: 170px;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
            overflow: hidden;
            flex-shrink: 0;
        }
        .patient-tab:hover {
            border-color: #c7d2fe;
            background: #f9fafb;
        }
        .patient-tab.active {
            background: var(--theme-header-gradient);
            border-color: var(--theme-primary);
            color: white;
        }
        
        .patient-tab .tab-header {
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .patient-tab.active .tab-header {
            border-bottom-color: rgba(255,255,255,0.2);
        }
        .patient-tab .patient-name {
            font-weight: 700;
            font-size: 0.95em;
        }
        .patient-tab .chair-badge {
            font-size: 0.75em;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            background: #dbeafe;
            color: #1e40af;
        }
        .patient-tab.active .chair-badge {
            background: rgba(255,255,255,0.25);
            color: white;
        }
        
        .patient-tab .tab-body {
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .patient-tab .tab-row {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .patient-tab .tab-row.time-row {
            border-top: 1px dashed #e5e7eb;
            padding-top: 5px;
            margin-top: 2px;
        }
        .patient-tab.active .tab-row.time-row {
            border-top-color: rgba(255,255,255,0.2);
        }
        .patient-tab .tab-row.alerts-row {
            border-top: 1px dashed #e5e7eb;
            padding-top: 5px;
            margin-top: 2px;
        }
        .patient-tab.active .tab-row.alerts-row {
            border-top-color: rgba(255,255,255,0.2);
        }
        
        /* Status badges */
        .patient-tab .status-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .patient-tab .status-badge.complete {
            background: #d1fae5;
            color: #065f46;
        }
        .patient-tab .status-badge.pending {
            background: #fee2e2;
            color: #991b1b;
        }
        .patient-tab.active .status-badge.complete {
            background: rgba(16, 185, 129, 0.4);
            color: white;
        }
        .patient-tab.active .status-badge.pending {
            background: rgba(239, 68, 68, 0.4);
            color: white;
        }
        
        /* Time info badges */
        .patient-tab .time-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            background: #e0e7ff;
            color: #4338ca;
        }
        .patient-tab.active .time-badge {
            background: rgba(99, 102, 241, 0.3);
            color: white;
        }

        /* Hospital name badge */
        .patient-tab .hospital-name-badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            background: #dbeafe;
            color: #1e40af;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .patient-tab.active .hospital-name-badge {
            background: rgba(59, 130, 246, 0.4);
            color: white;
        }

        /* Missed tx badge */
        .patient-tab .missed-tx-badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
            white-space: nowrap;
        }
        .patient-tab.active .missed-tx-badge {
            background: rgba(245, 158, 11, 0.4);
            color: white;
        }

        /* Alert badges with tooltips */
        .patient-tab .alert-badge {
            font-size: 0.8em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            background: #fee2e2;
            color: #991b1b;
            position: relative;
            cursor: help;
        }
        .patient-tab.active .alert-badge {
            background: rgba(239, 68, 68, 0.4);
            color: white;
        }
        .patient-tab .alert-badge:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 200;
            margin-bottom: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-weight: 500;
        }
        .patient-tab .alert-badge:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
            margin-bottom: -7px;
            z-index: 200;
        }
        
        /* Tab Contents spacing */
        #tabContents {
            margin-top: 5px;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .patient-card {
            background: white; border-radius: 8px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .at-a-glance {
            background: var(--theme-primary-bg);
            border-radius: 6px; padding: 12px; margin-bottom: 15px;
            border-left: 4px solid var(--theme-primary);
        }
        .glance-title {
            font-size: 1.1em; font-weight: 700; color: var(--theme-primary);
            margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
        }
        .glance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px;
        }
        .glance-item {
            background: white; padding: 8px; border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .glance-label { font-size: 0.75em; color: #6c757d; margin-bottom: 3px; }
        .glance-value { font-size: 1em; font-weight: 700; color: #495057; }
        .glance-value.alert { color: #dc3545; }
        
        /* Collapsible Section Styles */
        .collapsible-section {
            margin-bottom: 15px;
        }
        
        .section-header {
            background: var(--theme-header-gradient);
            color: white; padding: 10px 15px; border-radius: 6px;
            font-size: 1em; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .section-header:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        
        .section-header .toggle-icon {
            margin-left: auto;
            font-size: 1.2em;
            transition: transform 0.3s;
        }
        
        .section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .section-content {
            max-height: 5000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }
        
        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        /* Draggable Section Styles */
        .collapsible-section.dragging {
            opacity: 0.5;
            background: #dbeafe;
            border-radius: 8px;
        }
        .collapsible-section.drag-over {
            border-top: 3px solid #3b82f6;
        }
        .section-drag-handle {
            cursor: grab;
            color: rgba(255,255,255,0.7);
            padding: 0 5px;
            font-size: 1em;
            margin-right: 5px;
        }
        .section-drag-handle:active {
            cursor: grabbing;
        }
        .sections-container {
            min-height: 50px;
        }

        /* Expand/Collapse All Icons */
        .glance-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        .glance-action-btn {
            background: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--theme-primary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .glance-action-btn:hover {
            background: var(--theme-primary);
            color: white;
        }
        
        /* Tech Check Section */
        .tech-check-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding-top: 12px;
        }
        .tech-check-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
        }
        .tech-check-title {
            font-weight: 700;
            font-size: 0.9em;
            color: #334155;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0;
        }
        .tech-check-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .tech-check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .tech-check-item:hover {
            background: #e2e8f0;
        }
        .tech-check-item.checked {
            background: #fef2f2;
            border: 1px solid #fca5a5;
        }
        .tech-check-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #ef4444;
        }
        .tech-check-item label {
            font-size: 0.85em;
            color: #475569;
            cursor: pointer;
            flex: 1;
        }
        .tech-check-item.checked label {
            color: #dc2626;
            font-weight: 600;
        }
        
        /* Tech Check Alert Badge on Pod Tab */
        .tech-check-alert {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #ef4444;
            color: white;
            font-size: 0.75em;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 9px;
            margin-left: 6px;
            cursor: pointer;
            position: relative;
        }
        .tech-check-alert:hover {
            transform: scale(1.1);
        }
        
        /* Expanded tech check details below pod tab */
        .pod-tab-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .tech-check-expanded {
            display: none;
            background: #1e293b;
            color: white;
            padding: 6px 10px;
            border-radius: 0 0 8px 8px;
            font-size: 0.75em;
            font-weight: 400;
            margin-top: -2px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .tech-check-expanded.visible {
            display: block;
        }
        .tech-check-expanded-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 0;
            white-space: nowrap;
        }
        .tech-check-expanded-item::before {
            content: '⚠️';
            font-size: 0.85em;
        }
        
        .field-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px; padding-top: 12px;
        }
        .field-group { display: flex; flex-direction: column; }
        .field-label {
            font-size: 0.8em; font-weight: 600; color: #495057; margin-bottom: 5px;
        }
        .field-input {
            padding: 8px 10px; border: 2px solid #dee2e6;
            border-radius: 4px; font-size: 0.9em; transition: all 0.2s;
        }
        .field-input:focus { outline: none; border-color: var(--theme-primary); }
        
        /* Editable field status indicators - RED when empty, GREEN when filled */
        .field-input.editable-required {
            border-color: #fca5a5;
            background-color: #fef2f2;
        }
        .field-input.editable-required:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
        }
        .field-input.editable-filled {
            border-color: #86efac;
            background-color: #f0fdf4;
        }
        .field-input.editable-filled:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }
        
        /* Locked field styles */
        .field-input:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #ced4da;
        }
        
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.5); }
        input[type="time"]::-webkit-datetime-edit-ampm-field { display: none; }
        input[type="time"] { -webkit-appearance: textfield; }
        
        .calculated-field { background: #e7f3ff; font-weight: 600; cursor: not-allowed; }
        .calculated-field.warning { background: #fff3cd; color: #856404; }
        .calculated-field.danger { background: #f8d7da; color: #721c24; }
        .calculated-field.success { background: #d4edda; color: #155724; }

        .click-to-copy {
            cursor: pointer !important;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
            border: 2px solid #3b82f6 !important;
            transition: all 0.2s ease;
        }
        .click-to-copy:hover {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%) !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .click-to-copy:active {
            transform: scale(0.98);
        }
        .click-to-copy-label {
            color: #1e40af !important;
        }
        .click-to-copy-hint {
            font-size: 0.7em;
            color: #3b82f6;
            margin-left: 5px;
        }
        
        .alert-box {
            background: #f8d7da; border: 2px solid #dc3545;
            border-radius: 6px; padding: 10px; margin-top: 10px;
        }
        .alert-box h4 { color: #721c24; margin-bottom: 8px; font-size: 0.95em; }

        /* Wheelchair Weight Calculation Section */
        .wheelchair-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        .wheelchair-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .wheelchair-header h4 {
            margin: 0;
            color: #92400e;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .wheelchair-header .toggle-icon {
            color: #92400e;
            font-size: 0.9em;
            transition: transform 0.2s;
        }
        .wheelchair-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .wheelchair-content {
            display: block;
        }
        .wheelchair-content.collapsed {
            display: none;
        }

        /* Equipment Items Section (shared, at top) */
        .wheelchair-items-section {
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .wheelchair-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .wheelchair-items-header h5 {
            margin: 0;
            color: #92400e;
            font-size: 0.95em;
            font-weight: 600;
        }
        .wheelchair-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.8);
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #f59e0b;
        }
        .wheelchair-item input[type="text"] {
            flex: 2;
            padding: 6px 10px;
            border: 1px solid #d97706;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .wheelchair-item input[type="number"] {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #d97706;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .wheelchair-item .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .wheelchair-item .remove-btn:hover {
            background: #dc2626;
        }
        .add-item-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .add-item-btn:hover {
            background: #059669;
        }

        /* Pre/Post Calculation Columns */
        .wheelchair-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .wheelchair-column {
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            padding: 12px;
            border: 2px solid transparent;
        }
        .wheelchair-column.pre-column {
            border-color: #3b82f6;
        }
        .wheelchair-column.post-column {
            border-color: #8b5cf6;
        }
        .wheelchair-column h5 {
            margin: 0 0 12px 0;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .wheelchair-column.pre-column h5 {
            color: #1d4ed8;
        }
        .wheelchair-column.post-column h5 {
            color: #6d28d9;
        }
        .wheelchair-measured-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .wheelchair-measured-row label {
            font-weight: 600;
            color: #92400e;
            font-size: 0.85em;
        }
        .wheelchair-measured-row input {
            width: 100px;
            padding: 6px 10px;
            border: 2px solid #f59e0b;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
        }

        /* Equipment checkboxes in each column */
        .wheelchair-equipment-checks {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
        }
        .wheelchair-equipment-check {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.85em;
            color: #92400e;
        }
        .wheelchair-equipment-check input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .wheelchair-equipment-check .item-weight {
            margin-left: auto;
            font-weight: 600;
            color: #d97706;
        }
        .wheelchair-equipment-check.unchecked {
            opacity: 0.5;
            text-decoration: line-through;
        }

        /* Results row */
        .wheelchair-result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-top: 1px dashed #f59e0b;
            margin-top: 8px;
        }
        .wheelchair-result-row label {
            font-size: 0.8em;
            color: #92400e;
            font-weight: 600;
        }
        .wheelchair-result-row input {
            width: 80px;
            padding: 6px 8px;
            border: 2px solid #f59e0b;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
        }
        .wheelchair-result-row input.calculated {
            background: #fef9c3;
        }
        .wheelchair-result-row.actual-row input {
            background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
            border-color: #22c55e;
            font-size: 1em;
            width: 90px;
        }

        /* Action buttons */
        .wheelchair-column-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }
        .use-weight-btn {
            flex: 1;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
        }
        .use-weight-btn.pre-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        .use-weight-btn.pre-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        .use-weight-btn.post-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        .use-weight-btn.post-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }
        .use-weight-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .copy-weight-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .copy-weight-btn:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }

        .checkbox-group {
            display: flex; align-items: center; gap: 6px; margin: 5px 0;
            position: relative; z-index: 1;
        }
        .checkbox-group input[type="checkbox"] { 
            width: 16px; height: 16px; cursor: pointer; 
            position: relative; z-index: 2;
        }
        .checkbox-group label { 
            font-size: 0.85em; cursor: pointer; 
            user-select: none;
        }
        
        .qa-section {
            background: #f8f9fa; border-radius: 6px; padding: 15px;
        }
        .qa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;
        }

        /* 5-Column QA Grid */
        .qa-boxes-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        @media (max-width: 1200px) {
            .qa-boxes-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 768px) {
            .qa-boxes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Enhanced QA Checklist Styles */
        .qa-main-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 0;
        }
        .qa-main-item.expanded {
            border-color: #3b82f6;
        }
        .qa-main-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        .qa-main-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .qa-sub-items {
            display: none;
            margin-top: 10px;
            padding-left: 26px;
            border-top: 1px solid #e5e7eb;
            padding-top: 10px;
        }
        .qa-main-item.expanded .qa-sub-items {
            display: block;
        }
        .qa-sub-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .qa-sub-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .qa-sub-item input[type="text"] {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .qa-checkmark {
            color: #10b981;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Hospitalization background */
        .patient-hospitalized {
            background: #e0f2fe !important;
        }
        .patient-hospitalized .section-header {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%) !important;
        }

        /* Missed Tx yellow background */
        .patient-missed-tx {
            background: #fef9c3 !important;
        }
        .patient-missed-tx .section-header {
            background: linear-gradient(135deg, #facc15 0%, #eab308 100%) !important;
        }

        /* Tab status colors */
        .status-badge.yellow {
            background: #fef08a !important;
            color: #854d0e !important;
        }
        .patient-tab.hospitalized {
            background: linear-gradient(135deg, #7dd3fc 0%, #38bdf8 100%) !important;
        }
        .patient-tab.missed-tx {
            background: linear-gradient(135deg, #fde047 0%, #facc15 100%) !important;
        }

        /* Chart Closed styling */
        .chart-closed-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #d1d5db;
        }
        .chart-closed-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border: 3px solid #10b981;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chart-closed-checkbox:hover {
            background: #ecfdf5;
        }
        .chart-closed-checkbox.checked {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .chart-closed-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .chart-closed-label {
            font-weight: 700;
            font-size: 1em;
        }
        .chart-closed-checkmark {
            display: none;
            font-size: 1.2em;
            font-weight: bold;
        }
        .chart-closed-checkbox.checked .chart-closed-checkmark {
            display: inline;
        }
        .chart-closed-checkbox.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        .chart-closed-checkbox.disabled:hover {
            background: #f3f4f6;
        }

        /* Patient tab chart closed (green) */
        .patient-tab.chart-closed {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%) !important;
            border-color: #059669 !important;
        }
        .patient-tab.chart-closed .status-badge,
        .patient-tab.chart-closed .hospital-name-badge,
        .patient-tab.chart-closed .missed-tx-badge {
            background: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
        }

        /* Patient card chart closed (green) */
        .patient-card.chart-closed {
            background: #ecfdf5 !important;
            border-color: #10b981 !important;
        }
        .patient-card.chart-closed .section-header {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%) !important;
        }

        /* Misc To-Do List Styles */
        .misc-todo-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .misc-todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .misc-todo-header.collapsed {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .misc-todo-header.collapsed span:first-child {
            transform: rotate(-90deg);
        }
        .misc-todo-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }
        .misc-todo-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        .misc-todo-title {
            font-weight: 700;
            font-size: 1.1em;
            color: #1e293b;
        }
        .misc-todo-add-section {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .misc-todo-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .misc-todo-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .misc-todo-input:focus {
            border-color: #6366f1;
            outline: none;
        }
        .misc-todo-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .misc-todo-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .misc-todo-snippets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .misc-todo-snippet-btn {
            padding: 6px 12px;
            background: #e0e7ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .misc-todo-snippet-btn:hover {
            background: #c7d2fe;
            transform: translateY(-1px);
        }
        .misc-todo-list {
            margin-bottom: 15px;
        }
        .misc-todo-list-header {
            font-weight: 600;
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .misc-todo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: all 0.2s;
        }
        .misc-todo-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .misc-todo-item.completed {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        .misc-todo-item.completed .misc-todo-text {
            text-decoration: line-through;
            color: #6b7280;
        }
        .misc-todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .misc-todo-text {
            flex: 1;
            font-size: 0.95em;
        }
        .misc-todo-timestamp {
            font-size: 0.8em;
            color: #94a3b8;
        }
        .misc-todo-delete {
            padding: 4px 8px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }
        .misc-todo-delete:hover {
            opacity: 1;
            background: #fecaca;
        }
        .misc-todo-empty {
            color: #94a3b8;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        .incomplete-todos-badge {
            color: #dc2626;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Labs Section Styles */
        .labs-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .labs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .labs-header.collapsed {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .labs-header.collapsed span:first-child {
            transform: rotate(-90deg);
        }
        .labs-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
        }
        .labs-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        .labs-title {
            font-weight: 700;
            font-size: 1.1em;
            color: #1e293b;
        }
        .labs-add-section {
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .labs-snippets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .labs-snippet-btn {
            padding: 6px 12px;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .labs-snippet-btn:hover {
            background: #fde68a;
            transform: translateY(-1px);
        }
        .labs-list {
            margin-bottom: 15px;
        }
        .labs-list-header {
            font-weight: 600;
            font-size: 0.9em;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .labs-item {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: #fef9c3;
            border: 2px solid #fcd34d;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .labs-item.all-complete {
            background: #dcfce7;
            border-color: #86efac;
        }
        .labs-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .labs-item-name {
            font-weight: 600;
            font-size: 1em;
            color: #1e293b;
            flex: 1;
        }
        .labs-item-timestamp {
            font-size: 0.8em;
            color: #64748b;
        }
        .labs-item-delete {
            padding: 4px 8px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }
        .labs-item-delete:hover {
            opacity: 1;
            background: #fecaca;
        }
        .labs-item-body {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        .labs-item-left {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 15px;
            border-right: 2px solid rgba(0,0,0,0.15);
        }
        .labs-main-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #16a34a;
        }
        .labs-item-right {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px 15px;
            align-items: center;
        }
        .labs-sub-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            color: #374151;
            cursor: pointer;
        }
        .labs-sub-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #16a34a;
        }
        .labs-sub-checkbox.checked {
            color: #16a34a;
            text-decoration: line-through;
        }
        .labs-result-input {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            flex-basis: 100%;
            margin-top: 5px;
        }
        .labs-result-input input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .labs-result-input input[type="text"]:focus {
            outline: none;
            border-color: #6366f1;
        }
        .labs-empty {
            color: #94a3b8;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        .incomplete-labs-badge {
            color: #dc2626;
            font-weight: bold;
            margin-left: 5px;
        }
        .labs-complete-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #16a34a;
            font-weight: 600;
        }
        .labs-complete-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #16a34a;
        }
        /* Expandable Completed Labs */
        .labs-item-completed {
            background: #dcfce7;
            border-color: #86efac;
            cursor: pointer;
        }
        .labs-item-completed .labs-item-header {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .labs-item-completed.expanded .labs-item-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 10px;
            padding-bottom: 10px;
        }
        .labs-item-completed .labs-expand-icon {
            font-size: 0.8em;
            color: #64748b;
            transition: transform 0.2s;
        }
        .labs-item-completed.expanded .labs-expand-icon {
            transform: rotate(180deg);
        }
        .labs-item-completed .labs-item-details {
            display: none;
            flex-direction: column;
            gap: 8px;
            padding-top: 10px;
        }
        .labs-item-completed.expanded .labs-item-details {
            display: flex;
        }
        .labs-detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.85em;
            color: #374151;
        }
        .labs-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .labs-detail-item.checked {
            color: #16a34a;
        }
        .labs-detail-result {
            background: #f0fdf4;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 600;
            color: #166534;
        }
        /* Grid container for Misc ToDo and Labs */
        .todo-labs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        @media (max-width: 1200px) {
            .todo-labs-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 8px 16px; border: none; border-radius: 4px;
            font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--theme-primary); color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; transform: translateY(-2px); }
        
        select {
            padding: 8px 10px; border: 2px solid #dee2e6;
            border-radius: 4px; font-size: 0.9em;
            background: white; cursor: pointer;
        }
        
        select:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        /* UF Documentation Snippet Styles */
        .snippet-sections-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .snippet-section {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-border);
            border-radius: 8px;
            padding: 15px;
            flex: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .snippet-section.completed {
            opacity: 0.6;
            max-height: 80px;
            overflow: hidden;
        }
        
        .snippet-section.completed .snippet-content {
            display: none;
        }
        
        .snippet-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .complete-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Time Documentation Snippet Styles */
        .time-snippet-section {
            background: var(--theme-primary-bg);
            border: 2px solid var(--theme-border);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        
        .snippet-section h3 {
            color: #495057;
            font-size: 0.95em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .snippet-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            min-height: 60px;
            font-size: 0.85em;
            line-height: 1.6;
            color: #2d3748;
        }
        
        .snippet-box.empty {
            color: #a0aec0;
            font-style: italic;
        }
        
        .snippet-option {
            display: inline-block;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            color: #2d3748;
            user-select: none;
            white-space: nowrap;
        }
        
        .snippet-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .snippet-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .snippet-option.selected {
            border-color: #667eea;
            background: #edf2f7;
            font-weight: 600;
        }
        
        .snippet-input-group {
            display: none;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .snippet-input-group.show {
            display: flex;
        }
        
        .snippet-input {
            flex: 1;
            min-width: 100px;
            padding: 6px 10px;
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .snippet-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .copy-snippet-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .copy-snippet-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .copy-snippet-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .clear-snippet-btn {
            padding: 6px 12px;
            background: #ed8936;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }
        
        .clear-snippet-btn:hover {
            background: #dd6b20;
        }
        
        .copy-feedback {
            text-align: center;
            color: #48bb78;
            font-weight: 600;
            margin-top: 8px;
            font-size: 0.85em;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .copy-feedback.show {
            opacity: 1;
        }
        
        .uf-result-highlight {
            font-weight: 700;
            color: #e53e3e;
        }
        
        /* Floating Buttons Container */
        .floating-buttons {
            position: fixed;
            right: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }
        
        .floating-btn {
            background: #5B9BD5;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(91, 155, 213, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .floating-btn:hover {
            background: #4A8BC5;
            transform: translateX(-3px);
            box-shadow: 0 6px 16px rgba(91, 155, 213, 0.5);
        }

        /* Bottom Center Floating Button */
        .floating-btn-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #5B9BD5;
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(91, 155, 213, 0.5);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .floating-btn-bottom:hover {
            background: #4A8BC5;
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 8px 25px rgba(91, 155, 213, 0.6);
        }

        /* Timestamp Modal */
        .timestamp-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .timestamp-modal-overlay.active {
            display: flex;
        }

        .timestamp-modal {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .timestamp-modal-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timestamp-modal-title {
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timestamp-modal-time {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 4px;
        }

        .timestamp-modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timestamp-modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .timestamp-modal-body {
            padding: 25px;
            max-height: calc(90vh - 200px);
            overflow-y: auto;
        }

        .timestamp-section-title {
            font-weight: 700;
            color: #374151;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .timestamp-patient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .timestamp-patient-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .timestamp-patient-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .timestamp-patient-btn.selected {
            border-color: #3b82f6;
            background: #3b82f6;
            color: white;
        }

        .timestamp-patient-chair {
            font-weight: 700;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .timestamp-patient-name {
            font-size: 0.8em;
            color: #6b7280;
        }

        .timestamp-patient-btn.selected .timestamp-patient-name {
            color: rgba(255,255,255,0.9);
        }

        .timestamp-event-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        }

        .timestamp-event-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 14px 12px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .timestamp-event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .timestamp-event-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .timestamp-log-section {
            border-top: 2px solid #e5e7eb;
            padding-top: 20px;
        }

        .timestamp-log-list {
            background: #f9fafb;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .timestamp-log-item {
            display: grid;
            grid-template-columns: 80px 1fr 120px 30px 40px;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            gap: 10px;
            transition: background 0.3s;
        }

        .timestamp-log-item:hover {
            background: #f0f9ff;
        }

        .timestamp-log-item:last-child {
            border-bottom: none;
        }

        .timestamp-log-time {
            font-weight: 700;
            color: #dc2626;
            font-size: 0.9em;
        }

        .timestamp-log-patient {
            font-size: 0.9em;
            color: #374151;
        }

        .timestamp-log-event {
            font-size: 0.85em;
            font-weight: 600;
            color: #f59e0b;
            text-align: right;
        }

        .timestamp-copy-icon {
            font-size: 0.9em;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .timestamp-log-item:hover .timestamp-copy-icon {
            opacity: 1;
        }

        .timestamp-log-delete {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px;
            border-radius: 4px;
        }

        .timestamp-log-delete:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .timestamp-log-empty {
            text-align: center;
            padding: 30px;
            color: #9ca3af;
            font-style: italic;
        }

        .timestamp-selected-display {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #1e40af;
            display: none;
        }

        .timestamp-selected-display.active {
            display: block;
        }

        /* Legacy support - redirect to new classes */
        .drawer-toggle-btn {
            display: none;
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .drawer-overlay.open {
            display: block;
            opacity: 1;
        }
        
        .drawer-panel {
            position: fixed;
            right: -500px;
            top: 0;
            height: 100%;
            width: 480px;
            max-width: 90vw;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            overflow-y: auto;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .drawer-panel.open {
            right: 0;
        }
        
        .drawer-header {
            background: var(--theme-header-gradient);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .drawer-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drawer-title {
            font-size: 1.3em;
            font-weight: 700;
        }
        
        .drawer-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .drawer-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .drawer-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Charting Snippet Builder Styles (inside drawer) */
        .snippet-category {
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }
        
        .snippet-category-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .snippet-category-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        
        .snippet-category-header.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .snippet-category-body {
            padding: 15px;
            display: none;
        }
        
        .snippet-category-body.open {
            display: block;
        }
        
        .snippet-builder-option {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        
        .snippet-builder-option:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .snippet-builder-option.selected {
            border-color: #667eea;
            background: #e6fffa;
            font-weight: 600;
        }
        
        .snippet-slider-group {
            margin: 15px 0;
        }
        
        .snippet-slider-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
            margin-bottom: 8px;
            display: block;
        }
        
        .snippet-slider {
            width: 100%;
            margin: 10px 0;
        }
        
        .snippet-slider-value {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .generated-snippet-display {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .generated-snippet-title {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .generated-snippet-text {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
            font-size: 0.9em;
            color: #1e293b;
            line-height: 1.6;
            min-height: 60px;
        }
        
        .generated-snippet-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .drawer-btn-primary {
            flex: 1;
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .drawer-btn-primary:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .drawer-btn-secondary {
            padding: 10px 16px;
            background: #e2e8f0;
            color: #495057;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .drawer-btn-secondary:hover {
            background: #cbd5e0;
        }
        
        /* Countdown Timer & Status Indicators */
        .countdown-display {
            display: inline-block;
            padding: 3px 8px;
            background: #10b981;
            color: white;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1em;
            white-space: nowrap;
        }
        
        .countdown-display.warning {
            background: #f59e0b;
            animation: pulse-warning 1.5s infinite;
        }
        
        .countdown-display.critical {
            background: #ef4444;
            animation: pulse-critical 0.8s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes pulse-critical {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .status-indicator {
            display: inline-block;
            padding: 3px 8px;
            background: #fef3c7;
            color: #78350f;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-indicator.missing {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-indicator.complete {
            background: #d1fae5;
            color: #065f46;
        }
        
        .locked-calc-field {
            background: #f3f4f6 !important;
            cursor: not-allowed;
            font-weight: 700;
            color: #4b5563;
        }
        
        @media (max-width: 768px) {
            .field-grid { grid-template-columns: repeat(2, 1fr); }
            .glance-grid { grid-template-columns: repeat(2, 1fr); }
            .patient-list { grid-template-columns: 1fr; }
            
            .drawer-panel {
                width: 100vw;
                right: -100vw;
            }
            
            .drawer-toggle-btn {
                right: 10px;
                top: 10px;
                padding: 10px 16px;
                font-size: 0.85em;
            }
        }
        
        /* ========== V1.6.4 NEW FEATURES CSS ========== */
        
        /* Settings Button */
        .settings-btn {
            background: var(--theme-primary);
            border: 2px solid var(--theme-primary-dark);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .settings-btn:hover {
            background: var(--theme-primary-dark);
            transform: rotate(90deg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        /* Bulk Assign Modal */
        .bulk-assign-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .bulk-assign-overlay.active {
            display: flex;
        }
        .bulk-assign-modal {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .bulk-assign-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bulk-assign-title {
            font-size: 1.4em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bulk-assign-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bulk-assign-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Quick Fill Section */
        .quick-fill-section {
            background: #f0fdf4;
            border-bottom: 2px solid #bbf7d0;
            padding: 15px 20px;
        }
        .quick-fill-title {
            font-weight: 700;
            color: #166534;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        .quick-fill-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .quick-fill-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quick-fill-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #374151;
        }
        .quick-fill-select {
            padding: 8px 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
            min-width: 150px;
        }
        .quick-fill-select:focus {
            border-color: #10b981;
            outline: none;
        }
        .quick-fill-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        .quick-fill-btn.primary {
            background: #10b981;
            color: white;
        }
        .quick-fill-btn.primary:hover {
            background: #059669;
        }
        .quick-fill-btn.secondary {
            background: #6b7280;
            color: white;
        }
        .quick-fill-btn.secondary:hover {
            background: #4b5563;
        }
        
        /* Patient Table */
        .bulk-assign-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .patient-table {
            width: 100%;
            border-collapse: collapse;
        }
        .patient-table th {
            background: #f3f4f6;
            padding: 12px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 0.85em;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .patient-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .patient-table tr:hover {
            background: #f9fafb;
        }
        .patient-table tr.selected {
            background: #ecfdf5;
        }
        .patient-table input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .patient-table .patient-name {
            font-weight: 700;
            color: #1f2937;
        }
        .patient-table select {
            padding: 6px 10px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85em;
            width: 100%;
            max-width: 180px;
            transition: all 0.2s ease;
        }
        .patient-table select:focus {
            border-color: #10b981;
            outline: none;
        }
        .patient-table .pod-cell {
            color: #059669;
            font-weight: 600;
            font-size: 0.9em;
        }
        .patient-table .pod-cell.empty {
            color: #9ca3af;
            font-style: italic;
        }
        
        /* Unassigned patient styling */
        .patient-table tr.unassigned-row {
            background: #fef3c7;
        }
        .patient-table tr.unassigned-row:hover {
            background: #fde68a;
        }
        .unassigned-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            font-size: 0.7em;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Bulk Assign Footer */
        .bulk-assign-footer {
            background: #f9fafb;
            padding: 15px 20px;
            border-top: 2px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bulk-assign-stats {
            font-size: 0.9em;
            color: #6b7280;
        }
        .bulk-assign-stats strong {
            color: #10b981;
        }
        .bulk-assign-actions {
            display: flex;
            gap: 10px;
        }
        .btn-save-all {
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-save-all:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        .btn-cancel-bulk {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-cancel-bulk:hover {
            background: #4b5563;
        }
        
        /* Quick Notes Modal */
        .quick-notes-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .quick-notes-overlay.active {
            display: flex;
        }
        .quick-notes-modal {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .quick-notes-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-notes-title {
            font-size: 1.3em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quick-notes-patient {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 4px;
        }
        .quick-notes-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-notes-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .quick-notes-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        .quick-notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }
        .quick-notes-textarea:focus {
            outline: none;
            border-color: #f59e0b;
        }
        .quick-notes-footer {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 2px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-notes-hint {
            font-size: 0.85em;
            color: #6b7280;
        }
        .quick-notes-save {
            padding: 10px 20px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-notes-save:hover {
            background: #d97706;
        }
        
        /* Quick Chart Modal */
        .quick-chart-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .quick-chart-overlay.active {
            display: flex;
        }
        .quick-chart-modal {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow-x: hidden;
        }
        .quick-chart-header {
            background: var(--theme-header-gradient);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quick-chart-title {
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quick-chart-patient {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 2px;
        }
        .quick-chart-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-chart-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .quick-chart-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .quick-chart-section {
            margin-bottom: 20px;
        }
        .quick-chart-section-title {
            font-weight: 700;
            font-size: 0.85em;
            color: var(--theme-primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--theme-primary-light);
        }
        .quick-chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .quick-chart-grid.four-col {
            grid-template-columns: repeat(3, 1fr);
        }
        .quick-chart-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .quick-chart-label {
            font-size: 0.75em;
            font-weight: 600;
            color: var(--theme-text-light);
        }
        .quick-chart-input {
            padding: 8px 10px;
            border: 2px solid var(--theme-border);
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s;
            background: var(--theme-bg);
            color: var(--theme-text);
        }
        .quick-chart-input:focus {
            outline: none;
            border-color: var(--theme-primary);
        }
        .quick-chart-input.filled {
            border-color: var(--theme-accent);
            background: var(--theme-accent-bg);
        }
        .quick-chart-input.empty {
            border-color: #fca5a5;
            background: #fef2f2;
        }
        .quick-chart-checks {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .quick-chart-check {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .quick-chart-check:hover {
            background: #e5e7eb;
        }
        .quick-chart-check.checked {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .quick-chart-check input {
            width: 16px;
            height: 16px;
            accent-color: #10b981;
        }
        .quick-chart-footer {
            padding: 15px 20px;
            background: #f9fafb;
            border-top: 2px solid #e5e7eb;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .quick-chart-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-chart-btn.cancel {
            background: #6b7280;
            color: white;
        }
        .quick-chart-btn.cancel:hover {
            background: #4b5563;
        }
        .quick-chart-btn.save {
            background: var(--theme-header-gradient);
            color: white;
        }
        .quick-chart-btn.save:hover {
            filter: brightness(1.1);
        }
        
        /* Quick Chart button on patient tab */
        .quick-chart-tab-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--theme-primary);
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            font-size: 0.7em;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .patient-tab:hover .quick-chart-tab-btn {
            opacity: 1;
        }
        .quick-chart-tab-btn:hover {
            background: rgba(124, 58, 237, 1);
            transform: scale(1.1);
        }
        .patient-tab {
            position: relative;
        }
        
        /* Theme Selector Styles */
        .theme-selector-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .theme-selector-title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--theme-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .theme-option {
            border: 3px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .theme-option:hover {
            border-color: var(--theme-primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .theme-option.active {
            border-color: var(--theme-primary);
            background: var(--theme-primary-bg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .theme-preview {
            height: 40px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .theme-option-name {
            font-size: 0.85em;
            font-weight: 600;
            color: #374151;
        }
        [data-theme="dark"] .theme-option-name {
            color: #e2e8f0;
        }
        [data-theme="dark"] .theme-option {
            border-color: #475569;
            background: #1e293b;
        }
        [data-theme="dark"] .theme-option:hover {
            border-color: #64748b;
        }
        [data-theme="dark"] .theme-option.active {
            border-color: var(--theme-primary);
            background: var(--theme-bg-alt);
        }
        
        /* Settings Modal */
        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .settings-modal-overlay.active {
            display: flex;
        }
        .settings-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--theme-primary);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #94a3b8;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        .modal-close:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        .btn-clear-all {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #fecaca;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-clear-all:hover {
            background: #fecaca;
            border-color: #dc2626;
            transform: translateY(-1px);
        }
        .tech-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 25px;
        }
        .tech-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
        }
        .tech-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .tech-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.05em;
        }
        .tech-pod {
            font-size: 0.85em;
            color: #4338ca;
            background: #e0e7ff;
            padding: 3px 10px;
            border-radius: 12px;
            display: inline-block;
            width: fit-content;
            font-weight: 600;
        }
        .tech-actions {
            display: flex;
            gap: 8px;
        }
        .btn-icon {
            background: white;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1.1em;
        }
        .btn-icon.delete:hover {
            background: #fee2e2;
            border-color: #fecaca;
            color: #dc2626;
        }
        .add-tech-section {
            background: #f0fdf4;
            border: 2px solid #86efac;
            border-radius: 10px;
            padding: 20px;
        }
        .add-tech-title {
            font-weight: 700;
            color: #065f46;
            margin-bottom: 15px;
        }
        .add-tech-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .form-row {
            display: flex;
            gap: 10px;
        }
        .add-tech-input, .edit-tech-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        .add-tech-select, .edit-tech-select {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
        }
        .btn-add, .btn-save {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-add:hover, .btn-save:hover {
            background: #059669;
        }
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }
        .tech-item.editing {
            background: #fef3c7;
            border-color: #fbbf24;
        }
        
        /* Info Box */
        .info-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .info-box-title {
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 12px;
            font-size: 1.05em;
        }
        .info-box ul {
            margin-left: 20px;
            color: #1e40af;
        }
        .info-box li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .info-box strong {
            font-weight: 700;
        }
        
        /* Section Selector */
        .section-selector {
            background: white;
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e2e8f0;
        }
        .section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #475569;
            margin-bottom: 15px;
        }
        .section-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .section-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--theme-bg-alt);
            border: 2px solid var(--theme-border);
            border-radius: 10px;
            cursor: pointer;
        }
        .section-option:hover {
            border-color: var(--theme-primary);
            background: var(--theme-primary-bg);
        }
        .section-option.selected {
            background: var(--theme-primary-bg);
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }
        .section-radio {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--theme-primary);
        }
        .section-label {
            font-weight: 700;
            color: var(--theme-text);
            font-size: 1.05em;
        }
        .section-option.selected .section-label {
            color: var(--theme-primary-dark);
        }
        .section-info {
            font-size: 0.85em;
            color: var(--theme-text-light);
            margin-left: 5px;
        }
        
        /* Shift Selector in Import Modal */
        .shift-divider {
            border-top: 2px solid var(--theme-border);
            margin: 20px 0;
            padding-top: 20px;
        }
        .shift-selector-title {
            font-size: 1em;
            font-weight: 700;
            color: var(--theme-text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shift-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .shift-checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--theme-bg-alt);
            border: 2px solid var(--theme-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .shift-checkbox-option:hover {
            border-color: var(--theme-primary);
            background: var(--theme-primary-bg);
        }
        .shift-checkbox-option.selected {
            background: var(--theme-accent-bg);
            border-color: var(--theme-accent);
        }
        .shift-checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--theme-accent);
        }
        .shift-checkbox-label {
            font-weight: 700;
            color: var(--theme-text);
            font-size: 1em;
        }
        .shift-checkbox-option.selected .shift-checkbox-label {
            color: var(--theme-accent);
        }
        
        /* Shift Tabs in Main UI */
        .shift-tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            align-items: center;
        }
        .shift-tabs-container #shiftTabs {
            display: flex;
            gap: 8px;
        }
        .shift-tabs-label {
            color: rgba(255,255,255,0.8);
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }
        .shift-tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .shift-tab:hover {
            background: rgba(255,255,255,0.3);
        }
        .shift-tab.active {
            background: white;
            color: var(--theme-primary);
            border-color: white;
        }
        .shift-tab .shift-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 6px;
        }
        .shift-tab.active .shift-count {
            background: var(--theme-primary-light);
            color: var(--theme-primary-dark);
        }
        
        /* Shift tabs in Quick Assign Modal */
        .bulk-assign-shift-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }
        .bulk-assign-shift-tab {
            padding: 10px 20px;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bulk-assign-shift-tab:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }
        .bulk-assign-shift-tab.active {
            background: var(--theme-header-gradient);
            border-color: var(--theme-primary);
            color: white;
        }
        
        /* Auto-filled Pod */
        .auto-filled {
            background: #d1fae5 !important;
            border-color: #10b981 !important;
            font-weight: 600;
            color: #065f46;
        }
        .auto-label {
            font-size: 0.75em;
            color: #10b981;
            margin-top: 3px;
            font-weight: 600;
        }
        
        /* Assignment Info Bar */
        .assignment-info-bar {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e2e8f0;
            gap: 20px;
            flex-wrap: wrap;
        }
        .assignment-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .assignment-info-label {
            font-size: 0.9em;
            font-weight: 600;
            color: #64748b;
        }
        .assignment-info-value {
            font-size: 0.95em;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 20px;
            border: 2px solid;
        }
        .assignment-info-value.section {
            background: #fef3c7;
            color: #78350f;
            border-color: #fde68a;
        }
        .assignment-info-value.tech {
            background: #dbeafe;
            color: #1e40af;
            border-color: #93c5fd;
        }
        .assignment-info-value.pod {
            background: #e0e7ff;
            color: #4338ca;
            border-color: #c7d2fe;
        }
        .assignment-info-value.chair {
            background: #d1fae5;
            color: #065f46;
            border-color: #86efac;
        }

        /* ========== FLOATING NAVIGATION SIDEBAR ========== */
        .floating-nav-wrapper {
            position: fixed;
            left: 0;
            top: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        .floating-nav-wrapper.collapsed {
            transform: translateX(-100%);
        }
        .floating-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 6px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0 16px 0 0;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
        }
        .floating-nav::-webkit-scrollbar {
            width: 4px;
        }
        .floating-nav::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }
        .floating-nav-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .floating-nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            cursor: pointer;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 120px;
        }
        .floating-nav-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: var(--theme-primary, #667eea);
            transform: translateX(3px);
        }
        .floating-nav-btn.active {
            background: var(--theme-primary, #667eea);
            color: white;
            border-color: var(--theme-primary, #667eea);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        .floating-nav-sub {
            margin-left: 16px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 500;
            min-width: 100px;
            border-width: 1px;
            background: rgba(248, 250, 252, 0.9);
        }
        .floating-nav-sub:hover {
            background: rgba(102, 126, 234, 0.08);
        }
        .floating-nav-sub.active {
            background: rgba(102, 126, 234, 0.15);
            color: var(--theme-primary, #667eea);
            border-color: var(--theme-primary, #667eea);
            font-weight: 600;
        }
        .floating-nav-divider {
            height: 1px;
            background: rgba(102, 126, 234, 0.2);
            margin: 6px 8px;
        }
        .floating-nav-toggle {
            width: 100%;
            height: 32px;
            background: var(--theme-primary, #667eea);
            border: none;
            border-radius: 0 0 12px 0;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        .floating-nav-toggle:hover {
            background: var(--theme-secondary, #764ba2);
        }
        .floating-nav-toggle .arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .floating-nav-expand-btn {
            position: fixed;
            left: 0;
            top: 20px;
            z-index: 9998;
            width: 36px;
            height: 36px;
            background: var(--theme-primary, #667eea);
            border: none;
            border-radius: 0 8px 8px 0;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .floating-nav-expand-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .floating-nav-expand-btn:hover {
            width: 40px;
            background: var(--theme-secondary, #764ba2);
        }
        @media (max-width: 768px) {
            .floating-nav {
                padding: 8px 4px;
            }
            .floating-nav-btn {
                padding: 8px 10px;
                font-size: 11px;
                min-width: 100px;
            }
            .floating-nav-sub {
                margin-left: 12px;
                padding: 6px 10px;
                font-size: 10px;
            }
        }

        /* Universal Save Button Styles */
        .floating-nav-save-section {
            margin-top: auto;
            padding-top: 10px;
            border-top: 2px solid rgba(102, 126, 234, 0.2);
        }
        .universal-save-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        .universal-save-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
        }
        .universal-save-btn:active {
            transform: translateY(0);
        }
        .universal-save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .universal-save-status {
            font-size: 10px;
            text-align: center;
            padding: 4px 0;
            color: #64748b;
            min-height: 18px;
        }
        .universal-save-status.success {
            color: #10b981;
        }
        .universal-save-status.error {
            color: #ef4444;
        }
        .auto-save-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            background: rgba(248, 250, 252, 0.9);
            border-radius: 6px;
            margin-top: 6px;
        }
        .auto-save-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #64748b;
        }
        .auto-save-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s ease;
        }
        .auto-save-indicator.active {
            background: #10b981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
        }
        .auto-save-indicator.flash {
            animation: saveFlash 1s ease;
        }
        @keyframes saveFlash {
            0%, 100% { box-shadow: 0 0 6px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 16px rgba(16, 185, 129, 1); background: #34d399; }
        }
        .auto-save-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            background: #d1d5db;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .auto-save-toggle:checked {
            background: #10b981;
        }
        .auto-save-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .auto-save-toggle:checked::before {
            transform: translateX(16px);
        }
        .auto-save-countdown {
            font-size: 10px;
            color: #94a3b8;
            text-align: center;
            padding: 2px 0;
        }
        /* Warning state when auto-save is off */
        .floating-nav-save-section.auto-save-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 10px 8px;
            animation: warningPulse 2s ease-in-out infinite;
        }
        @keyframes warningPulse {
            0%, 100% { border-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.3); }
            50% { border-color: #f87171; box-shadow: 0 0 16px rgba(239, 68, 68, 0.5); }
        }
        .floating-nav-save-section.auto-save-warning .auto-save-countdown {
            color: #ef4444;
            font-weight: 600;
        }
        .floating-nav-save-section.auto-save-warning .auto-save-indicator {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Floating Navigation Sidebar -->
    <div class="floating-nav-wrapper" id="floatingNavWrapper">
        <nav class="floating-nav" id="floatingNav">
            <!-- Pt Charting Section -->
            <div class="floating-nav-section">
                <button class="floating-nav-btn active" onclick="floatingNavTo('charting')" id="floatNavCharting">
                    📋 Pt Charting
                </button>
            </div>

            <div class="floating-nav-divider"></div>

            <!-- Operations Section -->
            <div class="floating-nav-section">
                <button class="floating-nav-btn" onclick="floatingNavTo('operations')" id="floatNavOperations">
                    ⚙️ Operations
                </button>
                <button class="floating-nav-btn floating-nav-sub" onclick="floatingNavTo('operations', 'checklists')" id="floatNavChecklists">
                    📋 Checklists
                </button>
                <button class="floating-nav-btn floating-nav-sub" onclick="floatingNavTo('operations', 'labs')" id="floatNavLabs">
                    🧪 Labs
                </button>
                <button class="floating-nav-btn floating-nav-sub" onclick="floatingNavTo('operations', 'snippets')" id="floatNavSnippets">
                    ✂️ Snippets
                </button>
            </div>

            <div class="floating-nav-divider"></div>

            <!-- Reports Section -->
            <div class="floating-nav-section">
                <button class="floating-nav-btn" onclick="floatingNavTo('reports')" id="floatNavReports">
                    📊 Reports
                </button>
                <button class="floating-nav-btn floating-nav-sub" onclick="floatingNavTo('reports', 'eosr')" id="floatNavEOSR">
                    📋 End of Shift
                </button>
            </div>

            <!-- Universal Save Section -->
            <div class="floating-nav-save-section auto-save-warning" id="saveSection">
                <button class="universal-save-btn" id="universalSaveBtn" onclick="saveAll()">
                    💾 Save All
                </button>
                <div class="universal-save-status" id="universalSaveStatus"></div>
                <div class="auto-save-container">
                    <div class="auto-save-label">
                        <span class="auto-save-indicator" id="autoSaveIndicator"></span>
                        Auto-save
                    </div>
                    <input type="checkbox" class="auto-save-toggle" id="autoSaveToggle" onchange="toggleAutoSave()">
                </div>
                <div class="auto-save-countdown" id="autoSaveCountdown">Auto-save in 60s</div>
                <button class="refresh-app-btn" id="refreshAppBtn" onclick="refreshApp()" title="Save data, clear cache, and reload app with latest code">
                    🔄 Refresh App
                </button>
            </div>
        </nav>
        <button class="floating-nav-toggle" onclick="toggleFloatingNav()" id="floatingNavToggle" title="Hide Navigation">
            <span class="arrow">▲</span> Hide
        </button>
    </div>
    <button class="floating-nav-expand-btn" onclick="toggleFloatingNav()" id="floatingNavExpandBtn" title="Show Navigation">
        ▶
    </button>

    <div class="container">
        <!-- Import Modal -->
        <div class="modal-overlay hidden" id="importModal">
            <div class="modal">
                <h2>📥 Import Patient Orders</h2>
                
                <!-- Section Selector -->
                <div class="section-selector" style="margin-bottom: 25px;">
                    <div class="section-title">🏥 Select Section</div>
                    <div class="section-options" id="sectionOptions">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Shift Selector -->
                <div class="shift-divider">
                    <div class="shift-selector-title">⏰ Select Shift(s) You're Working</div>
                    <div class="shift-options" id="shiftOptions">
                        <label class="shift-checkbox-option selected" data-shift="1st">
                            <input type="checkbox" checked onchange="toggleShiftSelection('1st', this.checked)">
                            <span class="shift-checkbox-label">1st Shift</span>
                        </label>
                        <label class="shift-checkbox-option" data-shift="2nd">
                            <input type="checkbox" onchange="toggleShiftSelection('2nd', this.checked)">
                            <span class="shift-checkbox-label">2nd Shift</span>
                        </label>
                        <label class="shift-checkbox-option" data-shift="3rd">
                            <input type="checkbox" onchange="toggleShiftSelection('3rd', this.checked)">
                            <span class="shift-checkbox-label">3rd Shift</span>
                        </label>
                    </div>
                </div>
                
                <div class="import-section">
                    <h3>Step 1: Upload Excel File</h3>
                    <div class="file-upload">
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                            <label for="fileInput" class="file-input-label">
                                📁 Choose Excel File
                            </label>
                        </div>
                        <div class="file-name" id="fileName">No file selected</div>
                    </div>
                </div>

                <div class="import-section" id="patientSelectorSection" style="display: none;">
                    <h3>Step 2: Select Patients to Import</h3>
                    <p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
                        Select which patients you want to add to today's flowsheet:
                    </p>
                    <button class="select-all-btn" onclick="toggleSelectAll()">✓ Select All</button>
                    <div class="patient-list" id="patientList"></div>
                </div>

                <div class="import-note">
                    <strong>🔒 HIPAA Compliance:</strong> Patient names are displayed as initials only for privacy protection.
                </div>

                <div class="import-actions">
                    <button class="btn-skip" onclick="skipImport()">Skip Import</button>
                    <button class="btn-import" id="importBtn" onclick="importSelectedPatients()" disabled>
                        Import Selected Patients
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div class="main-app" id="mainApp">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button class="settings-btn" onclick="openSettingsModal()" title="Settings">⚙️</button>
                    <div>
                        <h1 style="margin-bottom: 5px;">🏥 HD Flowsheet & QA Tracker</h1>
                        <div class="version">Version 1.9.16</div>
                    </div>
                </div>
            </div>

            <!-- Top-Level Navigation -->
            <div class="top-nav">
                <button class="top-nav-tab active" onclick="switchTopNav('charting')" id="topNavCharting">📋 Pt Charting</button>
                <button class="top-nav-tab" onclick="switchTopNav('operations')" id="topNavOperations">⚙️ Operations</button>
                <button class="top-nav-tab" onclick="switchTopNav('reports')" id="topNavReports">📊 Reports</button>
            </div>

            <!-- Patient Charting Page -->
            <div class="pt-charting-page active" id="ptChartingPage">

            <!-- Re-import Button & Data Management -->
            <div class="import-btn-header">
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center;">
                    <button class="btn-reimport" onclick="showImportModal()">
                        📥 Import/Re-import Patient Orders
                    </button>
                    <button class="btn-reimport" onclick="loadFromServer()">
                        📂 Load from Server
                    </button>
                    <button class="btn-reimport" onclick="exportToFile()">
                        📥 Export to File
                    </button>
                    <button class="btn-reimport" onclick="document.getElementById('importFileHeader').click()">
                        📤 Import from File
                    </button>
                    <input type="file" id="importFileHeader" accept=".json" style="display: none;" onchange="importFromFile(event)">
                </div>
            </div>

            <!-- Summary Dashboard -->
            <div class="summary-dashboard">
                <div class="summary-title">📊 Shift Overview</div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">Total Patients</div>
                        <div class="summary-value" id="totalPatients">0</div>
                    </div>
                    <div class="summary-card alert">
                        <div class="summary-label">Time Alerts</div>
                        <div class="summary-value" id="timeAlerts">0</div>
                    </div>
                    <div class="summary-card alert">
                        <div class="summary-label">Weight Alerts</div>
                        <div class="summary-value" id="weightAlerts">0</div>
                    </div>
                    <div class="summary-card success">
                        <div class="summary-label">Complete</div>
                        <div class="summary-value" id="completionRate">0/0</div>
                    </div>
                </div>
            </div>

            <!-- Sticky Header with Shift Tabs + Pod Tabs + Patient Tabs -->
            <div class="sticky-header" id="stickyHeader">
                <!-- Shift Tabs -->
                <div class="shift-tabs-container" id="shiftTabsContainer" style="display: none;">
                    <span class="shift-tabs-label">Shift:</span>
                    <div id="shiftTabs"></div>
                </div>
                
                <!-- Pod Tabs -->
                <div class="pod-tabs" id="podTabs"></div>
                
                <!-- Patient Tabs Container -->
                <div class="patient-tabs-container" id="patientTabsContainer" style="display: none;">
                    <div class="patient-tabs" id="patientTabs"></div>
                </div>
            </div>

            <!-- Tab Contents -->
            <div id="tabContents"></div>

            </div><!-- End pt-charting-page -->

            <!-- Operations Page -->
            <div class="operations-page" id="operationsPage">
                <div class="ops-header">
                    <h2 class="ops-title">⚙️ Operations</h2>
                    <div class="ops-actions" id="opsChecklistActions">
                        <button class="ops-btn ops-btn-primary" onclick="openChecklistEditor()">+ New Checklist</button>
                        <button class="ops-btn" style="background: #f3f4f6; color: #374151;" onclick="exportOpsData()">📥 Export JSON</button>
                        <button class="ops-btn" style="background: #f3f4f6; color: #374151;" onclick="document.getElementById('opsImportFile').click()">📤 Import JSON</button>
                        <input type="file" id="opsImportFile" accept=".json" style="display: none;" onchange="importOpsData(event)">
                    </div>
                </div>

                <!-- Operations Sub-Tabs -->
                <div class="ops-sub-tabs">
                    <button class="ops-sub-tab active" onclick="switchOpsSubTab('checklists')" id="opsSubTabChecklists">📋 Checklists</button>
                    <button class="ops-sub-tab" onclick="switchOpsSubTab('labs')" id="opsSubTabLabs">🧪 Labs</button>
                    <button class="ops-sub-tab" onclick="switchOpsSubTab('snippets')" id="opsSubTabSnippets">✂️ Snippets</button>
                </div>

                <!-- Checklists Sub-Content -->
                <div class="ops-sub-content active" id="opsChecklistsContent">
                    <!-- Checklist Tabs -->
                    <div class="checklist-tabs-container">
                        <div class="checklist-tabs" id="checklistTabs">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Checklist Content -->
                    <div class="checklist-content" id="checklistContent">
                        <div class="checklist-empty">
                            <div class="checklist-empty-icon">📋</div>
                            <div class="checklist-empty-text">No checklists yet. Create your first checklist to get started!</div>
                            <button class="ops-btn ops-btn-primary" onclick="openChecklistEditor()">+ Create Checklist</button>
                        </div>
                    </div>
                </div>

                <!-- Labs Sub-Content -->
                <div class="ops-sub-content" id="opsLabsContent">
                    <div class="labs-container">
                        <div class="labs-header-actions">
                            <h3 class="labs-title">🧪 Lab Results</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="labs-refresh-btn" onclick="refreshLabsList()">🔄 Refresh</button>
                                <button class="labs-copy-all-btn" onclick="copyAllLabs()">📋 Copy All</button>
                            </div>
                        </div>

                        <!-- Add Lab Input Section -->
                        <div class="labs-input-section">
                            <div class="labs-input-row">
                                <div class="labs-input-group">
                                    <label>Patient Name / Initials</label>
                                    <input type="text" id="labPatientName" placeholder="e.g., J.D. or John Doe">
                                </div>
                                <div class="labs-input-group">
                                    <label>Lab & Result</label>
                                    <input type="text" id="labResult" placeholder="e.g., K+ 4.5 mEq/L">
                                </div>
                                <div class="labs-input-group">
                                    <label>Date/Time (Phoenix AZ)</label>
                                    <input type="text" id="labDateTime">
                                </div>
                                <button class="labs-add-btn" onclick="addLabEntry()">+ Add Lab</button>
                            </div>
                        </div>

                        <!-- Labs List -->
                        <div class="labs-list" id="labsList">
                            <div class="labs-empty">No lab entries yet. Add a lab result above to get started.</div>
                        </div>
                    </div>
                </div>

                <!-- Snippets Sub-Content -->
                <div class="ops-sub-content" id="opsSnippetsContent">
                    <div class="snippets-manager-container">
                        <!-- Snippet Manager Header -->
                        <div class="snippets-manager-header">
                            <h3 class="snippets-manager-title">✂️ Snippet Manager</h3>
                            <div class="snippets-manager-actions">
                                <button class="ops-btn ops-btn-primary" onclick="openSnippetConfigEditor()">+ New Configuration</button>
                                <button class="ops-btn" style="background: #f3f4f6; color: #374151;" onclick="exportSnippetData()">📥 Export</button>
                                <button class="ops-btn" style="background: #f3f4f6; color: #374151;" onclick="document.getElementById('snippetImportFile').click()">📤 Import</button>
                                <input type="file" id="snippetImportFile" accept=".json" style="display: none;" onchange="importSnippetData(event)">
                            </div>
                        </div>

                        <!-- Draggable Configuration Tabs -->
                        <div class="snippet-config-tabs-container">
                            <div class="snippet-config-tabs" id="snippetConfigTabs">
                                <!-- Populated by JS -->
                            </div>
                            <button class="snippet-config-tab-add" onclick="openSnippetConfigEditor()">+ Add</button>
                        </div>

                        <!-- Active Configuration Content -->
                        <div class="snippet-config-content" id="snippetConfigContent">
                            <div class="snippet-config-empty">
                                <div class="snippet-config-empty-icon">✂️</div>
                                <div class="snippet-config-empty-text">No snippet configurations yet. Create your first configuration to get started!</div>
                                <button class="ops-btn ops-btn-primary" onclick="openSnippetConfigEditor()">+ Create Configuration</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End operations-page -->

            <!-- Reports Page -->
            <div class="reports-page" id="reportsPage">
                <div class="reports-header">
                    <h2 class="reports-title">📊 Reports</h2>
                </div>

                <!-- Reports Tabs -->
                <div class="reports-tabs">
                    <button class="reports-tab active" onclick="switchReportTab('eosr')" id="reportTabEOSR">📋 End of Shift Report</button>
                </div>

                <!-- End of Shift Report Content -->
                <div id="eosrContent" class="eosr-container">
                    <div class="eosr-actions" style="margin-top: 0; margin-bottom: 20px;">
                        <button class="eosr-btn eosr-btn-refresh" onclick="refreshEOSR()">🔄 Refresh Report</button>
                        <button class="eosr-btn eosr-btn-copy" onclick="copyEOSRToClipboard()">📋 Copy All to Clipboard</button>
                    </div>

                    <!-- Treatments Complete Without Issue Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Treatments Complete Without Issue</span>
                            <span class="eosr-section-count" id="eosrCompleteCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrCompleteContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- COVID-19 Presumptive Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>COVID-19 Presumptive</span>
                            <span class="eosr-section-count" id="eosrCovidCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrCovidContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Patients leaving over/under 1.5 kg of dry weight Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Patients leaving over/under 1.5 kg of dry weight</span>
                            <span class="eosr-section-count" id="eosrWeightCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrWeightContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Early Termination Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Early Termination</span>
                            <span class="eosr-section-count" id="eosrEarlyTermCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrEarlyTermContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Missed treatments Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Missed treatments</span>
                            <span class="eosr-section-count" id="eosrMissedCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrMissedContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Medications Rescheduled Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Medications Rescheduled</span>
                            <span class="eosr-section-count" id="eosrMedsCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrMedsContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- STAT Labs Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>STAT Labs (please see separate email)</span>
                            <span class="eosr-section-count" id="eosrStatLabsCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrStatLabsContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Patients sent out to ED/Hospital Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Patients sent out to ED/Hospital</span>
                            <span class="eosr-section-count" id="eosrSentOutCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrSentOutContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Hospitalization Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Hospitalization</span>
                            <span class="eosr-section-count" id="eosrHospCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrHospContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Welfare Check Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Welfare Check</span>
                            <span class="eosr-section-count" id="eosrWelfareCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrWelfareContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- New Patients Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>New Patients</span>
                            <span class="eosr-section-count" id="eosrNewPtsCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrNewPtsContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- MIDAS Report Created Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>MIDAS Report Created</span>
                            <span class="eosr-section-count" id="eosrMidasCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrMidasContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Access Complications Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>Access Complications Documented in Renvio</span>
                            <span class="eosr-section-count" id="eosrAccessCount">0 patients</span>
                        </div>
                        <div class="eosr-section-content" id="eosrAccessContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>

                    <!-- Disinfection Logs Section -->
                    <div class="eosr-section">
                        <div class="eosr-section-header">
                            <span>All Disinfection Logs completed and signed off? Yes/No N/A</span>
                            <span class="eosr-section-count" id="eosrDisinfectCount"></span>
                        </div>
                        <div class="eosr-section-content" id="eosrDisinfectContent">
                            <div class="eosr-bullet-placeholder">•</div>
                        </div>
                    </div>
                </div>
            </div><!-- End reports-page -->

        </div><!-- End mainApp -->
    </div><!-- End container -->

    <!-- Checklist Editor Modal -->
    <div class="checklist-editor-modal" id="checklistEditorModal">
        <div class="checklist-editor">
            <div class="checklist-editor-header">
                <span class="checklist-editor-title" id="checklistEditorTitle">New Checklist</span>
                <button class="checklist-editor-close" onclick="closeChecklistEditor()">×</button>
            </div>
            <div class="checklist-editor-body">
                <div class="checklist-editor-field">
                    <label class="checklist-editor-label">Checklist Name</label>
                    <input type="text" class="checklist-editor-input" id="checklistNameInput" placeholder="e.g., Morning Routine">
                </div>
                <div class="checklist-editor-field">
                    <label class="checklist-editor-label">Position</label>
                    <input type="text" class="checklist-editor-input" id="checklistPositionInput" placeholder="e.g., PCT, RN, CHN">
                </div>
            </div>
            <div class="checklist-editor-footer">
                <button class="checklist-editor-btn checklist-editor-delete" id="checklistDeleteBtn" style="display: none;" onclick="deleteChecklist()">🗑️ Delete</button>
                <button class="checklist-editor-btn checklist-editor-cancel" onclick="closeChecklistEditor()">Cancel</button>
                <button class="checklist-editor-btn checklist-editor-save" onclick="saveChecklist()">Save</button>
            </div>
        </div>
    </div>

    <!-- Snippet Configuration Modal -->
    <div class="snippet-modal" id="snippetConfigModal">
        <div class="snippet-modal-content">
            <div class="snippet-modal-header">
                <span class="snippet-modal-title" id="snippetConfigModalTitle">New Configuration</span>
                <button class="snippet-modal-close" onclick="closeSnippetConfigEditor()">×</button>
            </div>
            <div class="snippet-modal-body">
                <div class="snippet-modal-field">
                    <label class="snippet-modal-label">Configuration Name</label>
                    <input type="text" class="snippet-modal-input" id="snippetConfigNameInput" placeholder="e.g., Default, Custom, Clinical">
                </div>
            </div>
            <div class="snippet-modal-footer">
                <button class="snippet-modal-btn snippet-modal-delete" id="snippetConfigDeleteBtn" style="display: none;" onclick="deleteSnippetConfig()">🗑️ Delete</button>
                <button class="snippet-modal-btn snippet-modal-cancel" onclick="closeSnippetConfigEditor()">Cancel</button>
                <button class="snippet-modal-btn snippet-modal-save" onclick="saveSnippetConfig()">Save</button>
            </div>
        </div>
    </div>

    <!-- Snippet Section Modal -->
    <div class="snippet-modal" id="snippetSectionModal">
        <div class="snippet-modal-content">
            <div class="snippet-modal-header">
                <span class="snippet-modal-title" id="snippetSectionModalTitle">New Section</span>
                <button class="snippet-modal-close" onclick="closeSectionEditor()">×</button>
            </div>
            <div class="snippet-modal-body">
                <div class="snippet-modal-field">
                    <label class="snippet-modal-label">Section Name</label>
                    <input type="text" class="snippet-modal-input" id="snippetSectionNameInput" placeholder="e.g., Hypertension Management">
                </div>
                <div class="snippet-modal-field">
                    <label class="snippet-modal-label">Icon (emoji)</label>
                    <input type="text" class="snippet-modal-input" id="snippetSectionIconInput" placeholder="e.g., 🔴, 💉, ⚖️" maxlength="4">
                </div>
            </div>
            <div class="snippet-modal-footer">
                <button class="snippet-modal-btn snippet-modal-delete" id="snippetSectionDeleteBtn" style="display: none;" onclick="deleteSection(snippetState.editingSectionId)">🗑️ Delete</button>
                <button class="snippet-modal-btn snippet-modal-cancel" onclick="closeSectionEditor()">Cancel</button>
                <button class="snippet-modal-btn snippet-modal-save" onclick="saveSection()">Save</button>
            </div>
        </div>
    </div>

    <!-- Snippet Item Modal -->
    <div class="snippet-modal" id="snippetItemModal">
        <div class="snippet-modal-content snippet-modal-wide">
            <div class="snippet-modal-header">
                <span class="snippet-modal-title" id="snippetItemModalTitle">New Snippet</span>
                <button class="snippet-modal-close" onclick="closeSnippetEditor()">×</button>
            </div>
            <div class="snippet-modal-body">
                <div class="snippet-modal-field">
                    <label class="snippet-modal-label">Snippet Text</label>
                    <textarea class="snippet-modal-textarea" id="snippetItemTextInput" placeholder="Enter the snippet text that will appear in the charting drawer..." rows="4"></textarea>
                </div>
                <div class="snippet-modal-field">
                    <label class="snippet-modal-label">Tags (comma-separated)</label>
                    <input type="text" class="snippet-modal-input" id="snippetItemTagsInput" placeholder="e.g., hypertension, bp-support, medication">
                    <div class="snippet-tag-suggestions-container">
                        <div class="snippet-tag-suggestions-label">Click to add existing tags:</div>
                        <div class="snippet-tag-suggestions" id="snippetTagSuggestions">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="snippet-modal-footer">
                <button class="snippet-modal-btn snippet-modal-delete" id="snippetItemDeleteBtn" style="display: none;" onclick="deleteSnippet(snippetState.editingSectionId, snippetState.editingSnippetId)">🗑️ Delete</button>
                <button class="snippet-modal-btn snippet-modal-cancel" onclick="closeSnippetEditor()">Cancel</button>
                <button class="snippet-modal-btn snippet-modal-save" onclick="saveSnippet()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        let state = {
            patients: [],
            activePatientId: null,
            activePod: null, // Currently selected pod tab
            activeShift: '1st', // Currently selected shift tab
            selectedShifts: ['1st'], // Which shifts user is working (from import)
            expandedTechCheck: null, // Which tech's check details are expanded
            nextId: 1,
            excelData: null,
            selectedPatients: new Set(),
            collapsedSections: {}, // Track collapsed state per patient per section
            technicians: [], // Array of {name: string, pod: string}
            currentSection: 'B1', // Currently selected section
            sectionOrder: ['techcheck', 'qa', 'assignment', 'orders', 'weight', 'time'], // Order of sections in patient charts
            sections: {
                B1: { name: 'B1', chairs: [1, 2, 3, 4, 5, 16, 17, 18, 19, 20], info: '(Chairs 1-5, 16-20)' },
                B2: { name: 'B2', chairs: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15], info: '(Chairs 6-15)' },
                A1: { name: 'A1', chairs: [], info: '(TBD)' },
                A2: { name: 'A2', chairs: [], info: '(TBD)' },
                TCH: { name: 'TCH', chairs: [1, 2, 3, 4, 5], info: '(Chairs 1-5)' }
            }
        };

        // ========== OPERATIONS STATE & FUNCTIONS ==========
        let opsState = {
            checklists: [],  // Array of {id, name, position, folders: [{id, name, order}], items: [{id, text, order, folderId, url}]}
            activeChecklistId: null,
            completions: {},  // {date_checklistId: {completedItems: [], timestamp}}
            editingChecklistId: null,  // null = new, number = editing existing
            activeFolders: {}  // {checklistId: folderId} - tracks active tab for each checklist (null = uncategorized)
        };

        // Drag state for reordering
        let dragState = {
            draggedItem: null,
            draggedItemId: null,
            checklistId: null,
            dropPosition: null  // 'before' or 'after'
        };

        // Load operations data from localStorage
        function loadOpsData() {
            const saved = localStorage.getItem('hd_operations_data');
            if (saved) {
                const data = JSON.parse(saved);
                opsState.checklists = data.checklists || [];
                opsState.completions = data.completions || {};
                opsState.activeFolders = data.activeFolders || {};
                // Ensure each checklist has folders array
                opsState.checklists.forEach(cl => {
                    if (!cl.folders) cl.folders = [];
                    // Ensure each item has folderId (null = uncategorized)
                    cl.items.forEach(item => {
                        if (item.folderId === undefined) item.folderId = null;
                    });
                });
            }
            renderChecklistTabs();
        }

        // Save operations data to localStorage
        function saveOpsData() {
            localStorage.setItem('hd_operations_data', JSON.stringify({
                checklists: opsState.checklists,
                completions: opsState.completions,
                activeFolders: opsState.activeFolders
            }));
        }

        // Switch between top-level tabs
        function switchTopNav(tab) {
            document.getElementById('topNavCharting').classList.toggle('active', tab === 'charting');
            document.getElementById('topNavOperations').classList.toggle('active', tab === 'operations');
            document.getElementById('topNavReports').classList.toggle('active', tab === 'reports');
            document.getElementById('ptChartingPage').classList.toggle('active', tab === 'charting');
            document.getElementById('operationsPage').classList.toggle('active', tab === 'operations');
            document.getElementById('reportsPage').classList.toggle('active', tab === 'reports');

            if (tab === 'operations') {
                loadOpsData();
            }
            if (tab === 'reports') {
                refreshEOSR();
            }

            // Update floating navigation
            updateFloatingNav(tab);
        }

        // Switch between report tabs (for future expansion)
        function switchReportTab(tab) {
            // Currently only EOSR tab exists
            document.getElementById('reportTabEOSR').classList.toggle('active', tab === 'eosr');
            if (tab === 'eosr') {
                refreshEOSR();
            }
            // Update floating nav sub-tab
            updateFloatingNavSubTab('reports', tab);
        }

        // ========== FLOATING NAVIGATION FUNCTIONS ==========

        // Toggle floating navigation visibility
        function toggleFloatingNav() {
            const wrapper = document.getElementById('floatingNavWrapper');
            const expandBtn = document.getElementById('floatingNavExpandBtn');

            wrapper.classList.toggle('collapsed');

            // Show/hide expand button
            if (wrapper.classList.contains('collapsed')) {
                expandBtn.classList.add('visible');
            } else {
                expandBtn.classList.remove('visible');
            }

            // Save preference
            localStorage.setItem('hd_floating_nav_collapsed', wrapper.classList.contains('collapsed'));
        }

        // Navigate to a tab/sub-tab via floating navigation
        function floatingNavTo(tab, subTab) {
            // Switch to main tab
            switchTopNav(tab);

            // If sub-tab specified, switch to it
            if (subTab) {
                if (tab === 'operations') {
                    switchOpsSubTab(subTab);
                } else if (tab === 'reports') {
                    switchReportTab(subTab);
                }
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Update floating navigation main tab state
        function updateFloatingNav(activeTab) {
            // Update main tab buttons
            document.getElementById('floatNavCharting').classList.toggle('active', activeTab === 'charting');
            document.getElementById('floatNavOperations').classList.toggle('active', activeTab === 'operations');
            document.getElementById('floatNavReports').classList.toggle('active', activeTab === 'reports');

            // Reset sub-tab highlighting based on active main tab
            if (activeTab === 'operations') {
                const currentSubTab = labsState.activeOpsSubTab || 'checklists';
                updateFloatingNavSubTab('operations', currentSubTab);
            } else {
                // Clear operations sub-tab highlighting
                document.getElementById('floatNavChecklists').classList.remove('active');
                document.getElementById('floatNavLabs').classList.remove('active');
                document.getElementById('floatNavSnippets').classList.remove('active');
            }

            if (activeTab === 'reports') {
                updateFloatingNavSubTab('reports', 'eosr');
            } else {
                // Clear reports sub-tab highlighting
                document.getElementById('floatNavEOSR').classList.remove('active');
            }
        }

        // Update floating navigation sub-tab state
        function updateFloatingNavSubTab(mainTab, subTab) {
            if (mainTab === 'operations') {
                document.getElementById('floatNavChecklists').classList.toggle('active', subTab === 'checklists');
                document.getElementById('floatNavLabs').classList.toggle('active', subTab === 'labs');
                document.getElementById('floatNavSnippets').classList.toggle('active', subTab === 'snippets');
            } else if (mainTab === 'reports') {
                document.getElementById('floatNavEOSR').classList.toggle('active', subTab === 'eosr');
            }
        }

        // Initialize floating navigation state
        function initFloatingNav() {
            const collapsed = localStorage.getItem('hd_floating_nav_collapsed') === 'true';
            const wrapper = document.getElementById('floatingNavWrapper');
            const expandBtn = document.getElementById('floatingNavExpandBtn');

            if (collapsed) {
                wrapper.classList.add('collapsed');
                expandBtn.classList.add('visible');
            }

            // Set initial active state
            updateFloatingNav('charting');
        }

        // EOSR state to track edits
        let eosrState = {
            completeEdits: {},   // {patientId: editedText}
            earlyTermEdits: {},  // {patientId: editedText}
            weightEdits: {}      // {patientId: editedText}
        };

        // ========== LABS STATE & FUNCTIONS ==========
        let labsState = {
            entries: [],  // Array of {id, patientName, labResult, dateTime, timestamp}
            activeOpsSubTab: 'checklists'  // 'checklists' or 'labs'
        };

        // Clear EOSR and Labs state when loading new flowsheet data
        // This prevents stale data from previous sessions appearing in reports
        function clearEOSRAndLabsState() {
            // Clear EOSR edits
            eosrState.completeEdits = {};
            eosrState.earlyTermEdits = {};
            eosrState.weightEdits = {};

            // Clear labs state and localStorage
            labsState.entries = [];
            localStorage.removeItem('hd_labs_data');
        }

        // Load labs data from localStorage
        function loadLabsData() {
            const saved = localStorage.getItem('hd_labs_data');
            if (saved) {
                const data = JSON.parse(saved);
                labsState.entries = data.entries || [];
            }
            renderLabsList();
            updateLabDateTime();
        }

        // Save labs data to localStorage
        function saveLabsData() {
            localStorage.setItem('hd_labs_data', JSON.stringify({
                entries: labsState.entries
            }));
        }

        // Get current date/time in Phoenix, Arizona timezone
        function getPhoenixTime() {
            const options = {
                timeZone: 'America/Phoenix',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            };
            return new Date().toLocaleString('en-US', options);
        }

        // Update the lab date/time input field
        function updateLabDateTime() {
            const dateTimeInput = document.getElementById('labDateTime');
            if (dateTimeInput) {
                dateTimeInput.value = getPhoenixTime();
            }
        }

        // Switch between Operations sub-tabs (Checklists / Labs / Snippets)
        function switchOpsSubTab(tab) {
            labsState.activeOpsSubTab = tab;

            // Update sub-tab buttons
            document.getElementById('opsSubTabChecklists').classList.toggle('active', tab === 'checklists');
            document.getElementById('opsSubTabLabs').classList.toggle('active', tab === 'labs');
            document.getElementById('opsSubTabSnippets').classList.toggle('active', tab === 'snippets');

            // Update sub-content visibility
            document.getElementById('opsChecklistsContent').classList.toggle('active', tab === 'checklists');
            document.getElementById('opsLabsContent').classList.toggle('active', tab === 'labs');
            document.getElementById('opsSnippetsContent').classList.toggle('active', tab === 'snippets');

            // Update header actions visibility
            document.getElementById('opsChecklistActions').style.display = tab === 'checklists' ? 'flex' : 'none';

            // Load data for the active tab
            if (tab === 'labs') {
                loadLabsData();
            } else if (tab === 'snippets') {
                loadSnippetData();
            } else {
                loadOpsData();
            }

            // Update floating nav sub-tab
            updateFloatingNavSubTab('operations', tab);
        }

        // Add a new lab entry
        function addLabEntry() {
            const patientName = document.getElementById('labPatientName').value.trim();
            const labResult = document.getElementById('labResult').value.trim();
            const dateTime = document.getElementById('labDateTime').value;

            if (!patientName || !labResult) {
                alert('Please enter both patient name/initials and lab result.');
                return;
            }

            const entry = {
                id: Date.now(),
                patientName: patientName,
                labResult: labResult,
                dateTime: dateTime,
                timestamp: new Date().toISOString()
            };

            labsState.entries.unshift(entry);  // Add to beginning
            saveLabsData();
            renderLabsList();

            // Clear inputs
            document.getElementById('labPatientName').value = '';
            document.getElementById('labResult').value = '';
            updateLabDateTime();  // Refresh the time
        }

        // Copy a single lab entry to clipboard (without date/time)
        function copyLabEntry(id) {
            const entry = labsState.entries.find(e => e.id === id);
            if (!entry) return;

            const text = `${entry.patientName} - ${entry.labResult}`;
            navigator.clipboard.writeText(text).then(() => {
                // Show brief feedback
                const btn = document.querySelector(`button[onclick="copyLabEntry(${id})"]`);
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.style.background = '#10b981';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#3b82f6';
                    }, 1000);
                }
            });
        }

        // Delete a lab entry
        function deleteLabEntry(id) {
            if (!confirm('Delete this lab entry?')) return;
            labsState.entries = labsState.entries.filter(e => e.id !== id);
            saveLabsData();
            renderLabsList();
        }

        // Copy all lab entries as a bulleted list (without date/time)
        function copyAllLabs() {
            if (labsState.entries.length === 0) {
                alert('No lab entries to copy.');
                return;
            }

            const bulletList = labsState.entries.map(entry =>
                `• ${entry.patientName} - ${entry.labResult}`
            ).join('\n');

            navigator.clipboard.writeText(bulletList).then(() => {
                // Show brief feedback
                const btn = document.querySelector('.labs-copy-all-btn');
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '✓ Copied!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 1500);
                }
            });
        }

        // Refresh labs list - sync from patient charts
        function refreshLabsList() {
            // Re-sync all completed labs from patient charts
            if (typeof state !== 'undefined' && state.patients) {
                state.patients.forEach(patient => {
                    if (patient.labs) {
                        patient.labs.filter(lab => lab.sectionComplete).forEach(lab => {
                            syncLabToOperations(patient, lab);
                        });
                    }
                });
            }
            // Reload and render
            loadLabsData();
            // Show feedback
            const btn = document.querySelector('.labs-refresh-btn');
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '✓ Refreshed!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            }
        }

        // Render the labs list
        function renderLabsList() {
            const listContainer = document.getElementById('labsList');
            if (!listContainer) return;

            if (labsState.entries.length === 0) {
                listContainer.innerHTML = '<div class="labs-empty">No lab entries yet. Add a lab result above to get started.</div>';
                return;
            }

            listContainer.innerHTML = labsState.entries.map(entry => `
                <div class="labs-entry ${entry.sourcePatientId ? 'labs-entry-synced' : ''}">
                    <div class="labs-entry-info">
                        <div class="labs-entry-main">
                            ${entry.patientName} - ${entry.labResult}
                            ${entry.sourcePatientId ? '<span class="labs-synced-badge">Auto</span>' : ''}
                        </div>
                        <div class="labs-entry-time">${entry.dateTime}</div>
                    </div>
                    <div class="labs-entry-actions">
                        <button class="labs-copy-btn" onclick="copyLabEntry(${entry.id})">📋 Copy</button>
                        <button class="labs-delete-btn" onclick="deleteLabEntry(${entry.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== SNIPPET MANAGER STATE & FUNCTIONS ==========
        let snippetState = {
            configurations: [],  // Array of {id, name, order, sections: [{id, name, icon, order, snippets: [{id, text, tags: [], order}]}]}
            activeConfigId: null,
            editingConfigId: null,  // null = new, number = editing existing
            editingSectionId: null,
            editingSnippetId: null,
            selectedTags: new Set(),  // Tags currently selected for filtering in drawer
            allTags: []  // Cached list of all unique tags
        };

        // Drag state for snippet config tabs
        let snippetDragState = {
            draggedTab: null,
            draggedTabId: null,
            dropPosition: null
        };

        // Load snippet data from localStorage
        function loadSnippetData() {
            const saved = localStorage.getItem('hd_snippet_data');
            if (saved) {
                const data = JSON.parse(saved);
                snippetState.configurations = data.configurations || [];
                snippetState.activeConfigId = data.activeConfigId || null;
            }

            // Initialize with default configuration if none exist
            if (snippetState.configurations.length === 0) {
                initializeDefaultSnippets();
            }

            // Set active config if not set
            if (!snippetState.activeConfigId && snippetState.configurations.length > 0) {
                snippetState.activeConfigId = snippetState.configurations[0].id;
            }

            updateAllTags();
            renderSnippetConfigTabs();
            renderSnippetConfigContent();
        }

        // Save snippet data to localStorage
        function saveSnippetData() {
            localStorage.setItem('hd_snippet_data', JSON.stringify({
                configurations: snippetState.configurations,
                activeConfigId: snippetState.activeConfigId
            }));
            updateAllTags();
        }

        // Initialize with default snippet configuration based on existing drawer snippets
        function initializeDefaultSnippets() {
            const defaultConfig = {
                id: Date.now(),
                name: 'Default',
                order: 0,
                sections: [
                    {
                        id: 1,
                        name: 'Weight & UF Management',
                        icon: '⚖️',
                        order: 0,
                        snippets: [
                            { id: 101, text: 'Pt denies any pains / SOB. No other voiced concerns.', tags: ['assessment', 'pre-treatment'], order: 0 }
                        ]
                    },
                    {
                        id: 2,
                        name: 'Pre Dialysis',
                        icon: '🏥',
                        order: 1,
                        snippets: [
                            { id: 201, text: 'Weight and goal reviewed and verified with pt.', tags: ['weight', 'pre-treatment'], order: 0 },
                            { id: 202, text: 'Pt denies any pains / SOB. No other voiced concerns.', tags: ['assessment'], order: 1 },
                            { id: 203, text: '5 mg Midodrine given for BP support.', tags: ['medication', 'bp-support'], order: 2 },
                            { id: 204, text: 'T to 36.5 for BP support.', tags: ['temperature', 'bp-support'], order: 3 },
                            { id: 205, text: 'T to 36.0 for BP support.', tags: ['temperature', 'bp-support'], order: 4 }
                        ]
                    },
                    {
                        id: 3,
                        name: 'Treatment Initiated',
                        icon: '💉',
                        order: 2,
                        snippets: [
                            { id: 301, text: 'Treatment initiated per orders. BFR [BFR], UF goal [UF Goal].', tags: ['initiation', 'orders'], order: 0 },
                            { id: 302, text: 'Pt tolerated treatment initiation without complaint.', tags: ['initiation', 'stable'], order: 1 },
                            { id: 303, text: 'Access cannulated without difficulty.', tags: ['access', 'initiation'], order: 2 },
                            { id: 304, text: 'Good arterial/venous flow noted.', tags: ['access', 'flow'], order: 3 }
                        ]
                    },
                    {
                        id: 4,
                        name: 'During Treatment',
                        icon: '⏱️',
                        order: 3,
                        snippets: [
                            { id: 401, text: 'Pt experiencing cramping.', tags: ['cramping', 'complication'], order: 0 },
                            { id: 402, text: 'UF to minimum.', tags: ['uf-adjustment', 'intervention'], order: 1 }
                        ]
                    },
                    {
                        id: 5,
                        name: 'Hypertension Management',
                        icon: '🔴',
                        order: 4,
                        snippets: [
                            { id: 501, text: 'Pt BP elevated.', tags: ['hypertension', 'bp'], order: 0 },
                            { id: 502, text: 'Pt denies any chest pain, SOB, dizziness or headache.', tags: ['assessment', 'hypertension'], order: 1 },
                            { id: 503, text: 'Pt reports taking his BP meds before tx.', tags: ['medication', 'hypertension'], order: 2 },
                            { id: 504, text: '0.1 mg clonidine given for BP support.', tags: ['medication', 'hypertension'], order: 3 },
                            { id: 505, text: 'BP stabilized after intervention.', tags: ['stable', 'hypertension'], order: 4 },
                            { id: 506, text: 'Will continue to monitor BP closely.', tags: ['monitoring', 'hypertension'], order: 5 },
                            { id: 507, text: 'T to 37 for BP support.', tags: ['temperature', 'hypertension'], order: 6 }
                        ]
                    },
                    {
                        id: 6,
                        name: 'Hypotension Management',
                        icon: '🔵',
                        order: 5,
                        snippets: [
                            { id: 601, text: 'Pt experiencing hypotension during treatment.', tags: ['hypotension', 'complication'], order: 0 },
                            { id: 602, text: 'Pt BP low side.', tags: ['hypotension', 'bp'], order: 1 },
                            { id: 603, text: 'Pt experienced > 20 pt SBP drop.', tags: ['hypotension', 'bp-drop'], order: 2 },
                            { id: 604, text: 'Pt experiencing side effects d/t hypotension - dizzy / light headedness.', tags: ['hypotension', 'symptoms'], order: 3 },
                            { id: 605, text: 'Pt denies any s/s of hypotension such as light headedness, chest pain or SOB.', tags: ['hypotension', 'assessment'], order: 4 },
                            { id: 606, text: '5 mg Midodrine given for BP support.', tags: ['medication', 'bp-support'], order: 5 },
                            { id: 607, text: '100mL NS bolus given for BP support.', tags: ['fluid', 'bp-support'], order: 6 },
                            { id: 608, text: 'BP stabilized, treatment continued.', tags: ['stable', 'hypotension'], order: 7 },
                            { id: 609, text: 'UF to min for BP support.', tags: ['uf-adjustment', 'bp-support'], order: 8 },
                            { id: 610, text: 'T to 36.5 for BP support.', tags: ['temperature', 'bp-support'], order: 9 },
                            { id: 611, text: 'T already at 36.0.', tags: ['temperature', 'hypotension'], order: 10 },
                            { id: 612, text: 'MAP remains > 70.', tags: ['bp', 'monitoring'], order: 11 }
                        ]
                    },
                    {
                        id: 7,
                        name: 'No Changes / Stable',
                        icon: '✅',
                        order: 6,
                        snippets: [
                            { id: 701, text: 'Pt stable throughout treatment.', tags: ['stable'], order: 0 },
                            { id: 702, text: 'No complaints voiced.', tags: ['stable', 'assessment'], order: 1 },
                            { id: 703, text: 'Tolerating treatment well without intervention.', tags: ['stable'], order: 2 },
                            { id: 704, text: 'VS within normal limits.', tags: ['stable', 'vitals'], order: 3 },
                            { id: 705, text: 'No changes / Stable.', tags: ['stable'], order: 4 },
                            { id: 706, text: 'Pt resting comfortably in chair watching TV.', tags: ['stable', 'comfort'], order: 5 },
                            { id: 707, text: 'Pt resting comfortably in chair playing with phone.', tags: ['stable', 'comfort'], order: 6 },
                            { id: 708, text: 'Pt sleeping comfortably with head back and legs elevated. Chest rising and falling appropriately. No signs of distress.', tags: ['stable', 'sleeping'], order: 7 }
                        ]
                    },
                    {
                        id: 8,
                        name: 'Access & Lines',
                        icon: '🩸',
                        order: 7,
                        snippets: [
                            { id: 801, text: 'Fistula assessment: good thrill and bruit noted.', tags: ['access', 'fistula'], order: 0 },
                            { id: 802, text: 'Graft assessment: patent, no signs of infection.', tags: ['access', 'graft'], order: 1 },
                            { id: 803, text: 'Catheter site clean, dry, intact.', tags: ['access', 'catheter'], order: 2 },
                            { id: 804, text: 'Dressing changed per protocol.', tags: ['access', 'dressing'], order: 3 },
                            { id: 805, text: 'No signs of bleeding or hematoma at access site.', tags: ['access', 'assessment'], order: 4 },
                            { id: 806, text: 'Good hemostasis achieved post-treatment.', tags: ['access', 'post-treatment'], order: 5 }
                        ]
                    },
                    {
                        id: 9,
                        name: 'Fluid Management',
                        icon: '💧',
                        order: 8,
                        snippets: [
                            { id: 901, text: 'IDWG within acceptable range.', tags: ['fluid', 'weight'], order: 0 },
                            { id: 902, text: 'Significant IDWG noted, fluid restriction education reinforced.', tags: ['fluid', 'education'], order: 1 },
                            { id: 903, text: 'UF goal met without difficulty.', tags: ['fluid', 'uf'], order: 2 },
                            { id: 904, text: 'Pt reports improved adherence to fluid restriction.', tags: ['fluid', 'compliance'], order: 3 },
                            { id: 905, text: 'Dietitian consult recommended for fluid management.', tags: ['fluid', 'referral'], order: 4 },
                            { id: 906, text: 'Signs/symptoms of fluid overload: SOB, edema, JVD.', tags: ['fluid', 'overload'], order: 5 },
                            { id: 907, text: 'Post-treatment weight at/near dry weight.', tags: ['fluid', 'weight'], order: 6 }
                        ]
                    }
                ]
            };
            snippetState.configurations.push(defaultConfig);
            saveSnippetData();
        }

        // Update cached list of all unique tags
        function updateAllTags() {
            const tagSet = new Set();
            snippetState.configurations.forEach(config => {
                config.sections.forEach(section => {
                    section.snippets.forEach(snippet => {
                        (snippet.tags || []).forEach(tag => tagSet.add(tag));
                    });
                });
            });
            snippetState.allTags = Array.from(tagSet).sort();
        }

        // Select a snippet configuration
        function selectSnippetConfig(configId) {
            snippetState.activeConfigId = configId;
            saveSnippetData();
            renderSnippetConfigTabs();
            renderSnippetConfigContent();
        }

        // Render snippet configuration tabs
        function renderSnippetConfigTabs() {
            const container = document.getElementById('snippetConfigTabs');
            if (!container) return;

            const sortedConfigs = [...snippetState.configurations].sort((a, b) => a.order - b.order);

            container.innerHTML = sortedConfigs.map(config => `
                <div class="snippet-config-tab ${config.id === snippetState.activeConfigId ? 'active' : ''}"
                    draggable="true"
                    data-config-id="${config.id}"
                    ondragstart="handleConfigDragStart(event, ${config.id})"
                    ondragover="handleConfigDragOver(event)"
                    ondrop="handleConfigDrop(event, ${config.id})"
                    ondragend="handleConfigDragEnd(event)"
                    onclick="selectSnippetConfig(${config.id})">
                    <span class="snippet-config-tab-name">${config.name}</span>
                    <button class="snippet-config-tab-edit" onclick="event.stopPropagation(); openSnippetConfigEditor(${config.id})">✏️</button>
                </div>
            `).join('');
        }

        // Render active configuration content
        function renderSnippetConfigContent() {
            const container = document.getElementById('snippetConfigContent');
            if (!container) return;

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);

            if (!config) {
                container.innerHTML = `
                    <div class="snippet-config-empty">
                        <div class="snippet-config-empty-icon">✂️</div>
                        <div class="snippet-config-empty-text">No snippet configurations yet. Create your first configuration to get started!</div>
                        <button class="ops-btn ops-btn-primary" onclick="openSnippetConfigEditor()">+ Create Configuration</button>
                    </div>
                `;
                return;
            }

            const sortedSections = [...config.sections].sort((a, b) => a.order - b.order);

            container.innerHTML = `
                <div class="snippet-sections-header">
                    <h4>Sections in "${config.name}"</h4>
                    <button class="ops-btn ops-btn-primary" onclick="openSectionEditor()">+ Add Section</button>
                </div>
                <div class="snippet-sections-list">
                    ${sortedSections.length === 0 ? `
                        <div class="snippet-section-empty">No sections yet. Add your first section to start building snippets.</div>
                    ` : sortedSections.map(section => `
                        <div class="snippet-section-card" data-section-id="${section.id}">
                            <div class="snippet-section-card-header">
                                <div class="snippet-section-card-title">
                                    <span class="snippet-section-icon">${section.icon || '📝'}</span>
                                    <span class="snippet-section-name">${section.name}</span>
                                    <span class="snippet-section-count">${section.snippets.length} snippets</span>
                                </div>
                                <div class="snippet-section-card-actions">
                                    <button class="snippet-section-btn" onclick="openSectionEditor(${section.id})">✏️ Edit</button>
                                    <button class="snippet-section-btn snippet-section-btn-danger" onclick="deleteSection(${section.id})">🗑️</button>
                                </div>
                            </div>
                            <div class="snippet-section-card-body">
                                <div class="snippet-items-list">
                                    ${section.snippets.sort((a, b) => a.order - b.order).map(snippet => `
                                        <div class="snippet-item" data-snippet-id="${snippet.id}">
                                            <div class="snippet-item-content">
                                                <div class="snippet-item-text">${snippet.text}</div>
                                                <div class="snippet-item-tags">
                                                    ${(snippet.tags || []).map(tag => `<span class="snippet-tag">${tag}</span>`).join('')}
                                                </div>
                                            </div>
                                            <div class="snippet-item-actions">
                                                <button class="snippet-item-btn" onclick="openSnippetEditor(${section.id}, ${snippet.id})">✏️</button>
                                                <button class="snippet-item-btn snippet-item-btn-danger" onclick="deleteSnippet(${section.id}, ${snippet.id})">🗑️</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button class="snippet-add-btn" onclick="openSnippetEditor(${section.id})">+ Add Snippet</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Configuration tab drag handlers
        function handleConfigDragStart(event, configId) {
            snippetDragState.draggedTab = event.target;
            snippetDragState.draggedTabId = configId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleConfigDragOver(event) {
            event.preventDefault();
            const tab = event.target.closest('.snippet-config-tab');
            if (tab && tab !== snippetDragState.draggedTab) {
                const rect = tab.getBoundingClientRect();
                const midpoint = rect.left + rect.width / 2;
                if (event.clientX < midpoint) {
                    tab.classList.add('drag-over-left');
                    tab.classList.remove('drag-over-right');
                    snippetDragState.dropPosition = 'before';
                } else {
                    tab.classList.add('drag-over-right');
                    tab.classList.remove('drag-over-left');
                    snippetDragState.dropPosition = 'after';
                }
            }
        }

        function handleConfigDrop(event, targetId) {
            event.preventDefault();
            const tabs = document.querySelectorAll('.snippet-config-tab');
            tabs.forEach(tab => {
                tab.classList.remove('drag-over-left', 'drag-over-right');
            });

            if (snippetDragState.draggedTabId === targetId) return;

            const configs = snippetState.configurations;
            const draggedConfig = configs.find(c => c.id === snippetDragState.draggedTabId);
            const targetConfig = configs.find(c => c.id === targetId);

            if (!draggedConfig || !targetConfig) return;

            // Calculate new order values
            const sortedConfigs = [...configs].sort((a, b) => a.order - b.order);
            const targetIndex = sortedConfigs.findIndex(c => c.id === targetId);

            let newOrder;
            if (snippetDragState.dropPosition === 'before') {
                const prevConfig = sortedConfigs[targetIndex - 1];
                newOrder = prevConfig ? (prevConfig.order + targetConfig.order) / 2 : targetConfig.order - 1;
            } else {
                const nextConfig = sortedConfigs[targetIndex + 1];
                newOrder = nextConfig ? (targetConfig.order + nextConfig.order) / 2 : targetConfig.order + 1;
            }

            draggedConfig.order = newOrder;
            saveSnippetData();
            renderSnippetConfigTabs();
        }

        function handleConfigDragEnd(event) {
            event.target.classList.remove('dragging');
            const tabs = document.querySelectorAll('.snippet-config-tab');
            tabs.forEach(tab => {
                tab.classList.remove('drag-over-left', 'drag-over-right');
            });
            snippetDragState.draggedTab = null;
            snippetDragState.draggedTabId = null;
            snippetDragState.dropPosition = null;
        }

        // Open configuration editor modal
        function openSnippetConfigEditor(configId = null) {
            snippetState.editingConfigId = configId;
            const modal = document.getElementById('snippetConfigModal');
            const titleEl = document.getElementById('snippetConfigModalTitle');
            const nameInput = document.getElementById('snippetConfigNameInput');
            const deleteBtn = document.getElementById('snippetConfigDeleteBtn');

            if (configId) {
                const config = snippetState.configurations.find(c => c.id === configId);
                titleEl.textContent = 'Edit Configuration';
                nameInput.value = config ? config.name : '';
                deleteBtn.style.display = 'block';
            } else {
                titleEl.textContent = 'New Configuration';
                nameInput.value = '';
                deleteBtn.style.display = 'none';
            }

            modal.classList.add('open');
            nameInput.focus();
        }

        function closeSnippetConfigEditor() {
            document.getElementById('snippetConfigModal').classList.remove('open');
            snippetState.editingConfigId = null;
        }

        function saveSnippetConfig() {
            const nameInput = document.getElementById('snippetConfigNameInput');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a configuration name.');
                return;
            }

            if (snippetState.editingConfigId) {
                // Update existing
                const config = snippetState.configurations.find(c => c.id === snippetState.editingConfigId);
                if (config) {
                    config.name = name;
                }
            } else {
                // Create new
                const maxOrder = Math.max(0, ...snippetState.configurations.map(c => c.order));
                const newConfig = {
                    id: Date.now(),
                    name: name,
                    order: maxOrder + 1,
                    sections: []
                };
                snippetState.configurations.push(newConfig);
                snippetState.activeConfigId = newConfig.id;
            }

            saveSnippetData();
            closeSnippetConfigEditor();
            renderSnippetConfigTabs();
            renderSnippetConfigContent();
        }

        function deleteSnippetConfig() {
            if (!snippetState.editingConfigId) return;
            if (!confirm('Delete this configuration and all its sections/snippets?')) return;

            snippetState.configurations = snippetState.configurations.filter(c => c.id !== snippetState.editingConfigId);

            if (snippetState.activeConfigId === snippetState.editingConfigId) {
                snippetState.activeConfigId = snippetState.configurations.length > 0 ? snippetState.configurations[0].id : null;
            }

            saveSnippetData();
            closeSnippetConfigEditor();
            renderSnippetConfigTabs();
            renderSnippetConfigContent();
        }

        // Section editor modal functions
        function openSectionEditor(sectionId = null) {
            snippetState.editingSectionId = sectionId;
            const modal = document.getElementById('snippetSectionModal');
            const titleEl = document.getElementById('snippetSectionModalTitle');
            const nameInput = document.getElementById('snippetSectionNameInput');
            const iconInput = document.getElementById('snippetSectionIconInput');
            const deleteBtn = document.getElementById('snippetSectionDeleteBtn');

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);

            if (sectionId && config) {
                const section = config.sections.find(s => s.id === sectionId);
                titleEl.textContent = 'Edit Section';
                nameInput.value = section ? section.name : '';
                iconInput.value = section ? section.icon : '';
                deleteBtn.style.display = 'block';
            } else {
                titleEl.textContent = 'New Section';
                nameInput.value = '';
                iconInput.value = '📝';
                deleteBtn.style.display = 'none';
            }

            modal.classList.add('open');
            nameInput.focus();
        }

        function closeSectionEditor() {
            document.getElementById('snippetSectionModal').classList.remove('open');
            snippetState.editingSectionId = null;
        }

        function saveSection() {
            const nameInput = document.getElementById('snippetSectionNameInput');
            const iconInput = document.getElementById('snippetSectionIconInput');
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || '📝';

            if (!name) {
                alert('Please enter a section name.');
                return;
            }

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
            if (!config) return;

            if (snippetState.editingSectionId) {
                // Update existing
                const section = config.sections.find(s => s.id === snippetState.editingSectionId);
                if (section) {
                    section.name = name;
                    section.icon = icon;
                }
            } else {
                // Create new
                const maxOrder = Math.max(0, ...config.sections.map(s => s.order));
                const newSection = {
                    id: Date.now(),
                    name: name,
                    icon: icon,
                    order: maxOrder + 1,
                    snippets: []
                };
                config.sections.push(newSection);
            }

            saveSnippetData();
            closeSectionEditor();
            renderSnippetConfigContent();
        }

        function deleteSection(sectionId) {
            if (!confirm('Delete this section and all its snippets?')) return;

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
            if (!config) return;

            config.sections = config.sections.filter(s => s.id !== sectionId);
            saveSnippetData();
            renderSnippetConfigContent();
        }

        // Snippet editor modal functions
        function openSnippetEditor(sectionId, snippetId = null) {
            snippetState.editingSectionId = sectionId;
            snippetState.editingSnippetId = snippetId;

            const modal = document.getElementById('snippetItemModal');
            const titleEl = document.getElementById('snippetItemModalTitle');
            const textInput = document.getElementById('snippetItemTextInput');
            const tagsInput = document.getElementById('snippetItemTagsInput');
            const deleteBtn = document.getElementById('snippetItemDeleteBtn');

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
            const section = config ? config.sections.find(s => s.id === sectionId) : null;

            if (snippetId && section) {
                const snippet = section.snippets.find(sn => sn.id === snippetId);
                titleEl.textContent = 'Edit Snippet';
                textInput.value = snippet ? snippet.text : '';
                tagsInput.value = snippet ? (snippet.tags || []).join(', ') : '';
                deleteBtn.style.display = 'block';
            } else {
                titleEl.textContent = 'New Snippet';
                textInput.value = '';
                tagsInput.value = '';
                deleteBtn.style.display = 'none';
            }

            // Render tag suggestions
            renderTagSuggestions();

            modal.classList.add('open');
            textInput.focus();
        }

        function closeSnippetEditor() {
            document.getElementById('snippetItemModal').classList.remove('open');
            snippetState.editingSectionId = null;
            snippetState.editingSnippetId = null;
        }

        function renderTagSuggestions() {
            const container = document.getElementById('snippetTagSuggestions');
            if (!container) return;

            container.innerHTML = snippetState.allTags.map(tag => `
                <span class="snippet-tag-suggestion" onclick="addTagToInput('${tag}')">${tag}</span>
            `).join('');
        }

        function addTagToInput(tag) {
            const tagsInput = document.getElementById('snippetItemTagsInput');
            const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);

            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                tagsInput.value = currentTags.join(', ');
            }
        }

        function saveSnippet() {
            const textInput = document.getElementById('snippetItemTextInput');
            const tagsInput = document.getElementById('snippetItemTagsInput');
            const text = textInput.value.trim();
            const tags = tagsInput.value.split(',').map(t => t.trim().toLowerCase()).filter(t => t);

            if (!text) {
                alert('Please enter snippet text.');
                return;
            }

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
            const section = config ? config.sections.find(s => s.id === snippetState.editingSectionId) : null;

            if (!section) return;

            if (snippetState.editingSnippetId) {
                // Update existing
                const snippet = section.snippets.find(sn => sn.id === snippetState.editingSnippetId);
                if (snippet) {
                    snippet.text = text;
                    snippet.tags = tags;
                }
            } else {
                // Create new
                const maxOrder = Math.max(0, ...section.snippets.map(sn => sn.order));
                const newSnippet = {
                    id: Date.now(),
                    text: text,
                    tags: tags,
                    order: maxOrder + 1
                };
                section.snippets.push(newSnippet);
            }

            saveSnippetData();
            closeSnippetEditor();
            renderSnippetConfigContent();

            // Update the drawer if it's open so new snippets appear immediately
            const drawerPanel = document.getElementById('drawerPanel');
            if (drawerPanel && drawerPanel.classList.contains('open')) {
                renderDrawerSnippetsFromState();
            }
        }

        function deleteSnippet(sectionId, snippetId) {
            if (!confirm('Delete this snippet?')) return;

            const config = snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
            const section = config ? config.sections.find(s => s.id === sectionId) : null;

            if (!section) return;

            section.snippets = section.snippets.filter(sn => sn.id !== snippetId);
            saveSnippetData();
            renderSnippetConfigContent();

            // Update the drawer if it's open so deleted snippets are removed immediately
            const drawerPanel = document.getElementById('drawerPanel');
            if (drawerPanel && drawerPanel.classList.contains('open')) {
                renderDrawerSnippetsFromState();
            }
        }

        // Export/Import snippet data
        function exportSnippetData() {
            const data = {
                configurations: snippetState.configurations,
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `snippets_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importSnippetData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.configurations && Array.isArray(data.configurations)) {
                        if (confirm('This will replace all existing snippet configurations. Continue?')) {
                            snippetState.configurations = data.configurations;
                            snippetState.activeConfigId = data.configurations.length > 0 ? data.configurations[0].id : null;
                            saveSnippetData();
                            renderSnippetConfigTabs();
                            renderSnippetConfigContent();
                            alert('Snippets imported successfully!');
                        }
                    } else {
                        alert('Invalid snippet data format.');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Get active configuration for the drawer
        function getActiveSnippetConfig() {
            return snippetState.configurations.find(c => c.id === snippetState.activeConfigId);
        }

        // Format patient initials from "F.L." to "L, F -"
        function formatEOSRInitials(patient) {
            const initials = patient.initials || '';
            // If initials are in format "F.L." or "FL", convert to "L, F -"
            if (initials.length >= 2) {
                const cleaned = initials.replace(/\./g, '').toUpperCase();
                if (cleaned.length >= 2) {
                    // First char is first name initial, second is last name initial
                    return `${cleaned[1]}, ${cleaned[0]} -`;
                }
            }
            return initials ? `${initials} -` : 'Patient -';
        }

        // Generate early termination snippet with formatting
        function generateEOSRTimeSnippet(patient) {
            if (!patient.startTime || !patient.endTime || !patient.rxTime) {
                return { text: '', html: '' };
            }

            const startFormatted = patient.startTime;
            const endFormatted = patient.endTime;
            const actualDuration = calcActualDuration(patient.startTime, patient.endTime);
            const prescribedTime = patient.rxTime;
            const timeCheck = calcTimeShortfall(patient.rxTime, patient.startTime, patient.endTime);

            if (!actualDuration) {
                return { text: '', html: '' };
            }

            let baseText = `Tx start/end ${startFormatted} - ${endFormatted}. Actual duration: ${actualDuration} of ${prescribedTime}.`;
            let baseHtml = baseText;

            if (timeCheck.isShort && timeCheck.shortfall) {
                const shortfallFormatted = timeCheck.shortfall.replace('-', '');
                const alertText = `Tx ended ${shortfallFormatted} early.`;
                baseText += ` ${alertText}`;
                baseHtml += ` <span class="eosr-alert-text">${alertText}</span>`;
            }

            return { text: baseText, html: baseHtml };
        }

        // Generate weight snippet with formatting
        function generateEOSRWeightSnippet(patient) {
            const preOverDW = calcPreOverDW(patient.preWeight, patient.dryWeight);
            const totalRemoved = calcTotalRemoved(patient.preWeight, patient.postWeight);
            const postVsDW = calcPostVsDW(patient.postWeight, patient.dryWeight);

            if (!preOverDW || !totalRemoved || !postVsDW) {
                return { text: '', html: '' };
            }

            const dryWeight = parseFloat(patient.dryWeight).toFixed(1);
            const aboveBelow = parseFloat(postVsDW) >= 0 ? 'above' : 'below';
            const postVsDWAbs = Math.abs(parseFloat(postVsDW)).toFixed(1);
            const isOverThreshold = Math.abs(parseFloat(postVsDW)) > 1.5;
            const preSign = parseFloat(preOverDW) >= 0 ? '+' : '';

            const baseText = `Pt arrived ${preSign}${preOverDW} kg over DW of ${dryWeight} kg. Pt removed ${totalRemoved} kg, leaving ${postVsDWAbs} kg ${aboveBelow} dry weight.`;

            const alertPortion = `${postVsDWAbs} kg ${aboveBelow} dry weight.`;
            let baseHtml = `Pt arrived ${preSign}${preOverDW} kg over DW of ${dryWeight} kg. Pt removed ${totalRemoved} kg, leaving `;

            if (isOverThreshold) {
                baseHtml += `<span class="eosr-alert-text">${alertPortion}</span>`;
            } else {
                baseHtml += alertPortion;
            }

            return { text: baseText, html: baseHtml };
        }

        // Refresh EOSR data from current patient data
        function refreshEOSR() {
            renderEOSRComplete();
            renderEOSREarlyTerm();
            renderEOSRWeight();
            renderEOSRStatLabs();
        }

        // Render Treatments Complete Without Issue section
        function renderEOSRComplete() {
            const container = document.getElementById('eosrCompleteContent');
            const countEl = document.getElementById('eosrCompleteCount');

            // Get patients who completed treatment without issue:
            // - Has completed treatment (startTime, endTime, postWeight all present)
            // - No time issues (not ended >15 min early)
            // - No weight issues (post weight within 1.5 kg of dry weight)
            // - No hospitalization
            const completePatients = state.patients.filter(p => {
                // Must have completed treatment
                if (!p.startTime || !p.endTime || !p.postWeight || !p.dryWeight || !p.rxTime) return false;

                // Check for time issues
                const timeCheck = calcTimeShortfall(p.rxTime, p.startTime, p.endTime);
                if (timeCheck.isShort) return false;

                // Check for weight issues
                if (checkWeightAlert(p.postWeight, p.dryWeight)) return false;

                // Check for hospitalization
                if (p.hospitalization) return false;

                return true;
            });

            countEl.textContent = `${completePatients.length} patient${completePatients.length !== 1 ? 's' : ''}`;

            if (completePatients.length === 0) {
                container.innerHTML = '<div class="eosr-bullet-placeholder">•</div>';
                return;
            }

            container.innerHTML = completePatients.map(p => {
                const formattedName = formatEOSRInitials(p);
                const defaultText = 'Pt completed full treatment without issue and within dry weight parameters. No complaints at d/c.';
                const editedText = eosrState.completeEdits[p.id] !== undefined
                    ? eosrState.completeEdits[p.id]
                    : defaultText;

                return `
                    <div class="eosr-entry">
                        <div class="eosr-entry-header">
                            <span><span class="eosr-patient-name">${formattedName}</span></span>
                            <span class="eosr-patient-badge">Chair ${p.chair || 'N/A'}</span>
                        </div>
                        <textarea class="eosr-entry-text"
                            data-patient-id="${p.id}"
                            data-section="complete"
                            data-name="${formattedName}"
                            oninput="updateEOSREntry(this)">${editedText}</textarea>
                    </div>
                `;
            }).join('');
        }

        // Render STAT Labs section from Operations Labs and patient chart labs
        function renderEOSRStatLabs() {
            const container = document.getElementById('eosrStatLabsContent');
            const countEl = document.getElementById('eosrStatLabsCount');

            // Collect all labs from Operations Labs section
            const saved = localStorage.getItem('hd_labs_data');
            let opsLabs = [];
            if (saved) {
                const data = JSON.parse(saved);
                opsLabs = data.entries || [];
            }

            // Also collect completed labs directly from patient charts (in case not synced yet)
            const patientLabs = [];
            state.patients.forEach(patient => {
                if (patient.labs) {
                    patient.labs.filter(lab => lab.sectionComplete).forEach(lab => {
                        // Check if this lab is already in opsLabs
                        const alreadySynced = opsLabs.some(e =>
                            e.sourcePatientId === patient.id && e.sourceLabId === lab.id
                        );
                        if (!alreadySynced) {
                            const patientName = patient.initials || patient.name || `Pt #${patient.number}`;
                            patientLabs.push({
                                id: lab.id,
                                patientName: patientName,
                                labResult: lab.name + (lab.resultText ? ` - ${lab.resultText}` : ''),
                                dateTime: lab.timestamp || ''
                            });
                        }
                    });
                }
            });

            // Combine all labs
            const allLabs = [...opsLabs, ...patientLabs];

            countEl.textContent = `${allLabs.length} patient${allLabs.length !== 1 ? 's' : ''}`;

            if (allLabs.length === 0) {
                container.innerHTML = '<div class="eosr-bullet-placeholder">•</div>';
                return;
            }

            // Render labs as entries (similar to other EOSR sections but read-only display)
            container.innerHTML = allLabs.map(lab => `
                <div class="eosr-entry">
                    <div class="eosr-entry-header">
                        <span><span class="eosr-patient-name">${lab.patientName}</span></span>
                    </div>
                    <textarea class="eosr-entry-text"
                        data-patient-id="${lab.id}"
                        data-section="statLabs"
                        data-name="${lab.patientName}"
                        oninput="updateEOSREntry(this)">${lab.labResult}</textarea>
                </div>
            `).join('');
        }

        // Render Early Termination section
        function renderEOSREarlyTerm() {
            const container = document.getElementById('eosrEarlyTermContent');
            const countEl = document.getElementById('eosrEarlyTermCount');

            // Get patients with early termination (>15 mins)
            const earlyTermPatients = state.patients.filter(p => {
                if (!p.rxTime || !p.startTime || !p.endTime) return false;
                const timeCheck = calcTimeShortfall(p.rxTime, p.startTime, p.endTime);
                return timeCheck.isShort;
            });

            countEl.textContent = `${earlyTermPatients.length} patient${earlyTermPatients.length !== 1 ? 's' : ''}`;

            if (earlyTermPatients.length === 0) {
                container.innerHTML = '<div class="eosr-bullet-placeholder">•</div>';
                return;
            }

            container.innerHTML = earlyTermPatients.map(p => {
                const snippet = generateEOSRTimeSnippet(p);
                const formattedName = formatEOSRInitials(p);
                const editedText = eosrState.earlyTermEdits[p.id] !== undefined
                    ? eosrState.earlyTermEdits[p.id]
                    : snippet.text;

                return `
                    <div class="eosr-entry">
                        <div class="eosr-entry-header">
                            <span><span class="eosr-patient-name">${formattedName}</span></span>
                            <span class="eosr-patient-badge">Chair ${p.chair || 'N/A'}</span>
                        </div>
                        <textarea class="eosr-entry-text"
                            data-patient-id="${p.id}"
                            data-section="earlyTerm"
                            data-name="${formattedName}"
                            oninput="updateEOSREntry(this)">${editedText}</textarea>
                    </div>
                `;
            }).join('');
        }

        // Render Weight deviation section
        function renderEOSRWeight() {
            const container = document.getElementById('eosrWeightContent');
            const countEl = document.getElementById('eosrWeightCount');

            // Get patients leaving >1.5 kg from dry weight
            const weightPatients = state.patients.filter(p => {
                if (!p.postWeight || !p.dryWeight) return false;
                return checkWeightAlert(p.postWeight, p.dryWeight);
            });

            countEl.textContent = `${weightPatients.length} patient${weightPatients.length !== 1 ? 's' : ''}`;

            if (weightPatients.length === 0) {
                container.innerHTML = '<div class="eosr-bullet-placeholder">•</div>';
                return;
            }

            container.innerHTML = weightPatients.map(p => {
                const snippet = generateEOSRWeightSnippet(p);
                const formattedName = formatEOSRInitials(p);
                const editedText = eosrState.weightEdits[p.id] !== undefined
                    ? eosrState.weightEdits[p.id]
                    : snippet.text;

                return `
                    <div class="eosr-entry">
                        <div class="eosr-entry-header">
                            <span><span class="eosr-patient-name">${formattedName}</span></span>
                            <span class="eosr-patient-badge">Chair ${p.chair || 'N/A'}</span>
                        </div>
                        <textarea class="eosr-entry-text"
                            data-patient-id="${p.id}"
                            data-section="weight"
                            data-name="${formattedName}"
                            oninput="updateEOSREntry(this)">${editedText}</textarea>
                    </div>
                `;
            }).join('');
        }

        // Update EOSR entry when edited
        function updateEOSREntry(textarea) {
            const patientId = parseInt(textarea.dataset.patientId);
            const section = textarea.dataset.section;
            const newValue = textarea.value;

            if (section === 'complete') {
                eosrState.completeEdits[patientId] = newValue;
            } else if (section === 'earlyTerm') {
                eosrState.earlyTermEdits[patientId] = newValue;
            } else if (section === 'weight') {
                eosrState.weightEdits[patientId] = newValue;
            }
        }

        // EOSR section definitions in order
        const eosrSections = [
            { id: 'Complete', title: 'Treatments Complete Without Issue', contentId: 'eosrCompleteContent' },
            { id: 'Covid', title: 'COVID-19 Presumptive', contentId: 'eosrCovidContent' },
            { id: 'Weight', title: 'Patients leaving over/under 1.5 kg of dry weight', contentId: 'eosrWeightContent' },
            { id: 'EarlyTerm', title: 'Early Termination', contentId: 'eosrEarlyTermContent' },
            { id: 'Missed', title: 'Missed treatments', contentId: 'eosrMissedContent' },
            { id: 'Meds', title: 'Medications Rescheduled', contentId: 'eosrMedsContent' },
            { id: 'StatLabs', title: 'STAT Labs (please see separate email)', contentId: 'eosrStatLabsContent' },
            { id: 'SentOut', title: 'Patients sent out to ED/Hospital', contentId: 'eosrSentOutContent' },
            { id: 'Hosp', title: 'Hospitalization', contentId: 'eosrHospContent' },
            { id: 'Welfare', title: 'Welfare Check', contentId: 'eosrWelfareContent' },
            { id: 'NewPts', title: 'New Patients', contentId: 'eosrNewPtsContent' },
            { id: 'Midas', title: 'MIDAS Report Created', contentId: 'eosrMidasContent' },
            { id: 'Access', title: 'Access Complications Documented in Renvio', contentId: 'eosrAccessContent' },
            { id: 'Disinfect', title: 'All Disinfection Logs completed and signed off? Yes/No N/A', contentId: 'eosrDisinfectContent' }
        ];

        // Copy all EOSR content to clipboard with rich text (Outlook-compatible HTML)
        function copyEOSRToClipboard() {
            let plainText = '';
            // Outlook-compatible HTML with inline styles
            let html = '<div style="font-family: Calibri, Arial, sans-serif; font-size: 11pt;">';

            eosrSections.forEach(section => {
                const container = document.getElementById(section.contentId);
                const textareas = container.querySelectorAll('textarea');

                // Add section header (bold)
                plainText += `${section.title}\n`;
                html += `<p style="margin: 10px 0 5px 0;"><strong>${section.title}</strong></p>`;

                if (textareas.length === 0) {
                    // Empty section - just bullet (Outlook-compatible)
                    plainText += `\t•\n`;
                    html += `<ul style="margin: 0 0 0 20px; padding: 0;"><li style="margin: 2px 0;">&nbsp;</li></ul>`;
                } else {
                    // Start bullet list with Outlook-compatible styles
                    html += `<ul style="margin: 0 0 0 20px; padding: 0; list-style-type: disc;">`;
                    textareas.forEach(ta => {
                        const name = ta.dataset.name || 'Patient';
                        const text = ta.value;

                        // Parse text to find and highlight alert portions
                        let formattedHtml = text;

                        // Highlight "Tx ended XX:XX early." in red+bold
                        formattedHtml = formattedHtml.replace(
                            /(Tx ended \d{2}:\d{2} early\.)/g,
                            '<span style="color: red; font-weight: bold;">$1</span>'
                        );

                        // Highlight weight deviations like "2.6 kg above dry weight." in red+bold
                        formattedHtml = formattedHtml.replace(
                            /(\d+\.\d+ kg (?:above|below) dry weight\.)/g,
                            '<span style="color: red; font-weight: bold;">$1</span>'
                        );

                        plainText += `\t• ${name} ${text}\n`;
                        // Bold patient name for Outlook
                        html += `<li style="margin: 2px 0;"><strong style="font-weight: bold;">${name}</strong> ${formattedHtml}</li>`;
                    });
                    html += `</ul>`;
                }
                plainText += '\n';
            });

            html += '</div>';

            // Copy both plain text and HTML to clipboard
            const blob = new Blob([html], { type: 'text/html' });
            const textBlob = new Blob([plainText], { type: 'text/plain' });

            navigator.clipboard.write([
                new ClipboardItem({
                    'text/html': blob,
                    'text/plain': textBlob
                })
            ]).then(() => {
                alert('End of Shift Report copied to clipboard!');
            }).catch(err => {
                // Fallback to plain text
                navigator.clipboard.writeText(plainText).then(() => {
                    alert('End of Shift Report copied to clipboard (plain text)!');
                }).catch(err2 => {
                    console.error('Failed to copy:', err2);
                    alert('Failed to copy to clipboard. Please try again.');
                });
            });
        }

        // Render checklist tabs
        function renderChecklistTabs() {
            const container = document.getElementById('checklistTabs');

            if (opsState.checklists.length === 0) {
                container.innerHTML = '';
                renderChecklistContent();
                return;
            }

            // Set active checklist if none selected
            if (!opsState.activeChecklistId && opsState.checklists.length > 0) {
                opsState.activeChecklistId = opsState.checklists[0].id;
            }

            container.innerHTML = opsState.checklists.map(cl => `
                <div class="checklist-tab ${cl.id === opsState.activeChecklistId ? 'active' : ''}"
                     onclick="selectChecklist(${cl.id})">
                    ${cl.name}
                    <span style="font-size: 0.8em; opacity: 0.7; margin-left: 5px;">(${cl.position})</span>
                </div>
            `).join('') + `
                <div class="checklist-tab-add" onclick="openChecklistEditor()">+ Add</div>
            `;

            renderChecklistContent();
        }

        // Select a checklist tab
        function selectChecklist(id) {
            opsState.activeChecklistId = id;
            renderChecklistTabs();
        }

        // Get today's date key
        function getTodayKey() {
            const now = new Date();
            return now.toLocaleDateString('en-US', { timeZone: 'America/Phoenix' }).replace(/\//g, '-');
        }

        // Get completion key for checklist
        function getCompletionKey(checklistId) {
            return `${getTodayKey()}_${checklistId}`;
        }

        // Render a single checklist item HTML
        function renderChecklistItemHTML(checklist, item, isCompleted, isFirst, isLast) {
            const urlLink = item.url ? `<a href="${item.url}" target="_blank" class="checklist-item-link" onclick="event.stopPropagation()">🔗 Open Link</a>` : '';
            return `
                <div class="checklist-item ${isCompleted ? 'completed' : ''}"
                     draggable="true"
                     data-item-id="${item.id}"
                     data-folder-id="${item.folderId || ''}"
                     ondragstart="handleItemDragStart(event, ${checklist.id}, ${item.id})"
                     ondragend="handleItemDragEnd(event)"
                     ondragover="handleItemDragOver(event)"
                     ondragleave="handleItemDragLeave(event)"
                     ondrop="handleItemDrop(event, ${checklist.id}, ${item.id})">
                    <div class="checklist-item-move-btns">
                        <button class="checklist-move-btn" onclick="event.stopPropagation(); moveChecklistItem(${checklist.id}, ${item.id}, 'up')" ${isFirst ? 'disabled' : ''} title="Move up">▲</button>
                        <button class="checklist-move-btn" onclick="event.stopPropagation(); moveChecklistItem(${checklist.id}, ${item.id}, 'down')" ${isLast ? 'disabled' : ''} title="Move down">▼</button>
                    </div>
                    <span class="checklist-item-drag-handle" title="Drag to reorder">⋮⋮</span>
                    <input type="checkbox" class="checklist-item-checkbox"
                           ${isCompleted ? 'checked' : ''}
                           onchange="toggleChecklistItem(${checklist.id}, ${item.id}, this.checked)">
                    <span class="checklist-item-text">${item.text}</span>
                    ${urlLink}
                    <div class="checklist-item-actions">
                        <button class="checklist-item-btn checklist-item-edit" onclick="editChecklistItem(${checklist.id}, ${item.id})">✏️</button>
                        <button class="checklist-item-btn checklist-item-delete" onclick="deleteChecklistItem(${checklist.id}, ${item.id})">🗑️</button>
                    </div>
                </div>
            `;
        }

        // Render checklist content
        function renderChecklistContent() {
            const container = document.getElementById('checklistContent');

            if (opsState.checklists.length === 0) {
                container.innerHTML = `
                    <div class="checklist-empty">
                        <div class="checklist-empty-icon">📋</div>
                        <div class="checklist-empty-text">No checklists yet. Create your first checklist to get started!</div>
                        <button class="ops-btn ops-btn-primary" onclick="openChecklistEditor()">+ Create Checklist</button>
                    </div>
                `;
                return;
            }

            const checklist = opsState.checklists.find(cl => cl.id === opsState.activeChecklistId);
            if (!checklist) return;

            // Ensure folders array exists
            if (!checklist.folders) checklist.folders = [];

            const completionKey = getCompletionKey(checklist.id);
            const completion = opsState.completions[completionKey] || { completedItems: [] };
            const completedCount = completion.completedItems.length;
            const totalCount = checklist.items.length;
            const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;

            // Get or set active folder for this checklist (null = uncategorized)
            if (opsState.activeFolders[checklist.id] === undefined) {
                // Default to uncategorized or first folder if no uncategorized items
                const uncategorizedItems = checklist.items.filter(item => !item.folderId);
                if (uncategorizedItems.length > 0 || checklist.folders.length === 0) {
                    opsState.activeFolders[checklist.id] = null;
                } else {
                    opsState.activeFolders[checklist.id] = checklist.folders[0]?.id || null;
                }
            }

            const activeFolderId = opsState.activeFolders[checklist.id];

            // Group items by folder
            const uncategorizedItems = checklist.items.filter(item => !item.folderId).sort((a, b) => a.order - b.order);
            const folderItemsMap = {};
            checklist.folders.forEach(folder => {
                folderItemsMap[folder.id] = checklist.items.filter(item => item.folderId === folder.id).sort((a, b) => a.order - b.order);
            });

            // Build folder tabs HTML
            let tabsHTML = '';
            if (checklist.folders.length > 0 || uncategorizedItems.length > 0) {
                // Uncategorized tab
                const uncatCompleted = uncategorizedItems.filter(item => completion.completedItems.includes(item.id)).length;
                const isUncatActive = activeFolderId === null;
                tabsHTML += `
                    <div class="folder-tab ${isUncatActive ? 'active' : ''}" onclick="switchFolder(${checklist.id}, null)">
                        <span class="folder-tab-name">📋 Uncategorized</span>
                        <span class="folder-tab-progress">${uncatCompleted}/${uncategorizedItems.length}</span>
                    </div>
                `;

                // Folder tabs
                checklist.folders.sort((a, b) => a.order - b.order).forEach(folder => {
                    const folderItems = folderItemsMap[folder.id] || [];
                    const folderCompleted = folderItems.filter(item => completion.completedItems.includes(item.id)).length;
                    const isActive = activeFolderId === folder.id;

                    tabsHTML += `
                        <div class="folder-tab ${isActive ? 'active' : ''}" onclick="switchFolder(${checklist.id}, ${folder.id})">
                            <span class="folder-tab-name">📁 ${folder.name}</span>
                            <span class="folder-tab-progress">${folderCompleted}/${folderItems.length}</span>
                            <div class="folder-tab-actions">
                                <button class="folder-tab-btn" onclick="event.stopPropagation(); editFolder(${checklist.id}, ${folder.id})" title="Edit folder">✏️</button>
                                <button class="folder-tab-btn" onclick="event.stopPropagation(); deleteFolder(${checklist.id}, ${folder.id})" title="Delete folder">🗑️</button>
                            </div>
                        </div>
                    `;
                });
            }

            // Build active folder content HTML
            let activeItemsHTML = '';
            let activeFolderDrop = '';
            if (activeFolderId === null) {
                // Show uncategorized items
                const uncatItemsHTML = uncategorizedItems.map((item, idx, arr) => {
                    const isCompleted = completion.completedItems.includes(item.id);
                    const isFirst = idx === 0;
                    const isLast = idx === arr.length - 1;
                    return renderChecklistItemHTML(checklist, item, isCompleted, isFirst, isLast);
                }).join('');
                activeItemsHTML = uncatItemsHTML || '<div style="padding: 10px; color: #9ca3af; font-size: 0.9em;">No items. Add items below or drag items from other folders.</div>';
                activeFolderDrop = `ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, ${checklist.id}, null)"`;
            } else {
                // Show items from active folder
                const folderItems = folderItemsMap[activeFolderId] || [];
                const folderItemsHTML = folderItems.map((item, idx, arr) => {
                    const isCompleted = completion.completedItems.includes(item.id);
                    const isFirst = idx === 0;
                    const isLast = idx === arr.length - 1;
                    return renderChecklistItemHTML(checklist, item, isCompleted, isFirst, isLast);
                }).join('');
                activeItemsHTML = folderItemsHTML || '<div style="padding: 10px; color: #9ca3af; font-size: 0.9em;">No items in this folder. Add items below or drag items here.</div>';
                activeFolderDrop = `ondragover="handleFolderDragOver(event)" ondragleave="handleFolderDragLeave(event)" ondrop="handleFolderDrop(event, ${checklist.id}, ${activeFolderId})"`;
            }

            // Empty state
            let contentHTML = '';
            if (checklist.items.length === 0 && checklist.folders.length === 0) {
                contentHTML = '<div class="checklist-empty" style="padding: 20px;"><div class="checklist-empty-text">No items in this checklist. Add folders and items below!</div></div>';
            } else if (tabsHTML) {
                contentHTML = `
                    <div class="folder-tabs-container">
                        <div class="folder-tabs">
                            ${tabsHTML}
                        </div>
                        <div class="folder-content">
                            <div class="folder-items" ${activeFolderDrop}>
                                ${activeItemsHTML}
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="checklist-header">
                    <div>
                        <div class="checklist-title">${checklist.name}</div>
                        <span class="checklist-position">${checklist.position}</span>
                    </div>
                    <div class="checklist-progress">
                        <div class="checklist-progress-bar">
                            <div class="checklist-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <span class="checklist-progress-text">${completedCount}/${totalCount}</span>
                        <button class="ops-btn" style="background: #e0e7ff; color: #4338ca; padding: 6px 12px;" onclick="editChecklistDetails(${checklist.id})">✏️ Edit</button>
                        <button class="ops-btn" style="background: #fef3c7; color: #92400e; padding: 6px 12px;" onclick="resetChecklistProgress(${checklist.id})">🔄 Reset</button>
                    </div>
                </div>
                <button class="folder-add-btn" onclick="addFolder(${checklist.id})">📁 + Add Folder</button>
                ${contentHTML}
                <div class="checklist-add-item">
                    <input type="text" class="checklist-add-input" id="newItemInput_${checklist.id}"
                           placeholder="Add new item..."
                           onkeypress="if(event.key==='Enter') addChecklistItem(${checklist.id})">
                    <select id="newItemFolder_${checklist.id}" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em;">
                        <option value="" ${activeFolderId === null ? 'selected' : ''}>No Folder</option>
                        ${checklist.folders.map(f => `<option value="${f.id}" ${activeFolderId === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                    </select>
                    <button class="checklist-add-btn" onclick="addChecklistItem(${checklist.id})">+ Add Item</button>
                    <button class="ops-btn" style="background: #e0e7ff; color: #4338ca; padding: 12px 16px;" onclick="openItemEditor(${checklist.id})">+ Add with URL</button>
                </div>
            `;
        }

        // Drag and drop handlers - improved with proper position detection
        function handleItemDragStart(event, checklistId, itemId) {
            const itemEl = event.target.closest('.checklist-item');
            dragState.draggedItem = itemEl;
            dragState.draggedItemId = itemId;
            dragState.checklistId = checklistId;
            dragState.dropPosition = null;

            // Use setTimeout to allow the drag image to be captured first
            setTimeout(() => {
                itemEl.classList.add('dragging');
            }, 0);

            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', itemId.toString());
        }

        function handleItemDragEnd(event) {
            const itemEl = event.target.closest('.checklist-item');
            if (itemEl) itemEl.classList.remove('dragging');

            // Clear all drag-over classes
            document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
                el.classList.remove('drag-over-top', 'drag-over-bottom');
            });

            dragState.draggedItem = null;
            dragState.draggedItemId = null;
            dragState.checklistId = null;
            dragState.dropPosition = null;
        }

        function handleItemDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';

            const item = event.target.closest('.checklist-item');
            if (!item || item === dragState.draggedItem) return;

            // Calculate if we're in the top or bottom half of the target
            const rect = item.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const isAbove = event.clientY < midpoint;

            // Clear previous drag-over classes from all items
            document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
                if (el !== item) {
                    el.classList.remove('drag-over-top', 'drag-over-bottom');
                }
            });

            // Set the appropriate class based on mouse position
            if (isAbove) {
                item.classList.remove('drag-over-bottom');
                item.classList.add('drag-over-top');
                dragState.dropPosition = 'before';
            } else {
                item.classList.remove('drag-over-top');
                item.classList.add('drag-over-bottom');
                dragState.dropPosition = 'after';
            }
        }

        function handleItemDragLeave(event) {
            const item = event.target.closest('.checklist-item');
            if (!item) return;

            // Only remove classes if we're actually leaving the item (not just moving between children)
            const relatedTarget = event.relatedTarget;
            if (relatedTarget && item.contains(relatedTarget)) return;

            item.classList.remove('drag-over-top', 'drag-over-bottom');
        }

        function handleItemDrop(event, checklistId, targetItemId) {
            event.preventDefault();
            event.stopPropagation();

            const item = event.target.closest('.checklist-item');
            if (item) {
                item.classList.remove('drag-over-top', 'drag-over-bottom');
            }

            if (!dragState.draggedItemId || dragState.draggedItemId === targetItemId) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            const draggedItem = checklist.items.find(i => i.id === dragState.draggedItemId);
            const targetItem = checklist.items.find(i => i.id === targetItemId);
            if (!draggedItem || !targetItem) return;

            // Move dragged item to target's folder
            const oldFolderId = draggedItem.folderId;
            draggedItem.folderId = targetItem.folderId;

            // Get all items in the target folder, sorted by order
            let folderItems = checklist.items
                .filter(i => i.folderId === targetItem.folderId)
                .sort((a, b) => a.order - b.order);

            // Remove dragged item from its current position
            folderItems = folderItems.filter(i => i.id !== draggedItem.id);

            // Find target position
            let targetIndex = folderItems.findIndex(i => i.id === targetItem.id);

            // Calculate mouse position relative to target to determine before/after
            const rect = item ? item.getBoundingClientRect() : null;
            const isDropAfter = dragState.dropPosition === 'after';

            // Insert at the correct position
            if (isDropAfter) {
                targetIndex = targetIndex + 1;
            }

            // Insert dragged item at the new position
            folderItems.splice(targetIndex, 0, draggedItem);

            // Update order values for all items in folder
            folderItems.forEach((itm, index) => {
                itm.order = index + 1;
            });

            // Also update order for old folder if item moved between folders
            if (oldFolderId !== targetItem.folderId) {
                const oldFolderItems = checklist.items
                    .filter(i => i.folderId === oldFolderId && i.id !== draggedItem.id)
                    .sort((a, b) => a.order - b.order);
                oldFolderItems.forEach((itm, index) => {
                    itm.order = index + 1;
                });
            }

            saveOpsData();
            renderChecklistContent();
        }

        // Move item up or down with buttons
        function moveChecklistItem(checklistId, itemId, direction) {
            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            const item = checklist.items.find(i => i.id === itemId);
            if (!item) return;

            // Get items in the same folder, sorted by order
            const folderItems = checklist.items
                .filter(i => i.folderId === item.folderId)
                .sort((a, b) => a.order - b.order);

            const currentIndex = folderItems.findIndex(i => i.id === itemId);

            // Check bounds
            if (direction === 'up' && currentIndex === 0) return;
            if (direction === 'down' && currentIndex === folderItems.length - 1) return;

            // Swap with adjacent item
            const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            const swapItem = folderItems[swapIndex];

            // Swap order values
            const tempOrder = item.order;
            item.order = swapItem.order;
            swapItem.order = tempOrder;

            saveOpsData();
            renderChecklistContent();
        }

        function handleFolderDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const container = event.target.closest('.checklist-folder-items, .checklist-uncategorized, .folder-items');
            if (container) container.style.background = '#dbeafe';
        }

        function handleFolderDragLeave(event) {
            const container = event.target.closest('.checklist-folder-items, .checklist-uncategorized, .folder-items');
            if (container) container.style.background = '';
        }

        function handleFolderDrop(event, checklistId, folderId) {
            event.preventDefault();
            const container = event.target.closest('.checklist-folder-items, .checklist-uncategorized, .folder-items');
            if (container) container.style.background = '';

            if (!dragState.draggedItemId) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            const draggedItem = checklist.items.find(i => i.id === dragState.draggedItemId);
            if (!draggedItem) return;

            // Move item to new folder
            draggedItem.folderId = folderId;

            // Reorder within the new folder
            const folderItems = checklist.items.filter(i => i.folderId === folderId).sort((a, b) => a.order - b.order);
            draggedItem.order = folderItems.length;

            saveOpsData();
            renderChecklistContent();
        }

        // Switch active folder tab
        function switchFolder(checklistId, folderId) {
            opsState.activeFolders[checklistId] = folderId;
            saveOpsData();
            renderChecklistContent();
        }

        // Add folder to checklist
        function addFolder(checklistId) {
            const name = prompt('Enter folder name:');
            if (!name || !name.trim()) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            if (!checklist.folders) checklist.folders = [];

            const newFolder = {
                id: Date.now(),
                name: name.trim(),
                order: checklist.folders.length + 1
            };
            checklist.folders.push(newFolder);

            saveOpsData();
            renderChecklistContent();
        }

        // Edit folder
        function editFolder(checklistId, folderId) {
            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            const folder = checklist.folders.find(f => f.id === folderId);
            if (!folder) return;

            const newName = prompt('Edit folder name:', folder.name);
            if (!newName || !newName.trim()) return;

            folder.name = newName.trim();
            saveOpsData();
            renderChecklistContent();
        }

        // Delete folder
        function deleteFolder(checklistId, folderId) {
            if (!confirm('Delete this folder? Items will be moved to Uncategorized.')) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            // Move items to uncategorized
            checklist.items.forEach(item => {
                if (item.folderId === folderId) {
                    item.folderId = null;
                }
            });

            // Remove folder
            checklist.folders = checklist.folders.filter(f => f.id !== folderId);

            // If this was the active folder, switch to uncategorized
            if (opsState.activeFolders[checklistId] === folderId) {
                opsState.activeFolders[checklistId] = null;
            }

            saveOpsData();
            renderChecklistContent();
        }

        // Open item editor for adding with URL
        function openItemEditor(checklistId, itemId = null) {
            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            let item = null;
            if (itemId) {
                item = checklist.items.find(i => i.id === itemId);
            }

            const folderOptions = checklist.folders.map(f =>
                `<option value="${f.id}" ${item && item.folderId === f.id ? 'selected' : ''}>${f.name}</option>`
            ).join('');

            const modalHTML = `
                <div class="checklist-editor-modal active" id="itemEditorModal" onclick="if(event.target===this) closeItemEditor()">
                    <div class="checklist-editor">
                        <div class="checklist-editor-header">
                            <h3>${item ? 'Edit Item' : 'Add Item with URL'}</h3>
                            <button onclick="closeItemEditor()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">&times;</button>
                        </div>
                        <div class="checklist-editor-body" style="padding: 20px;">
                            <div class="item-edit-row">
                                <label>Item Text *</label>
                                <input type="text" id="itemEditText" value="${item ? item.text : ''}" placeholder="Enter item text...">
                            </div>
                            <div class="item-edit-row">
                                <label>URL (optional)</label>
                                <input type="text" id="itemEditUrl" value="${item && item.url ? item.url : ''}" placeholder="https://...">
                            </div>
                            <div class="item-edit-row">
                                <label>Folder</label>
                                <select id="itemEditFolder">
                                    <option value="" ${!item || !item.folderId ? 'selected' : ''}>No Folder</option>
                                    ${folderOptions}
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                                <button class="ops-btn" onclick="closeItemEditor()">Cancel</button>
                                <button class="ops-btn ops-btn-success" onclick="saveItemFromEditor(${checklistId}, ${itemId || 'null'})">${item ? 'Save Changes' : 'Add Item'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existing = document.getElementById('itemEditorModal');
            if (existing) existing.remove();

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('itemEditText').focus();
        }

        function closeItemEditor() {
            const modal = document.getElementById('itemEditorModal');
            if (modal) modal.remove();
        }

        function saveItemFromEditor(checklistId, itemId) {
            const text = document.getElementById('itemEditText').value.trim();
            const url = document.getElementById('itemEditUrl').value.trim();
            const folderId = document.getElementById('itemEditFolder').value;

            if (!text) {
                alert('Please enter item text');
                return;
            }

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            if (itemId) {
                // Edit existing item
                const item = checklist.items.find(i => i.id === itemId);
                if (item) {
                    item.text = text;
                    item.url = url || null;
                    item.folderId = folderId ? parseInt(folderId) : null;
                }
            } else {
                // Add new item
                const newItem = {
                    id: Date.now(),
                    text: text,
                    url: url || null,
                    folderId: folderId ? parseInt(folderId) : null,
                    order: checklist.items.length + 1
                };
                checklist.items.push(newItem);
            }

            saveOpsData();
            closeItemEditor();
            renderChecklistContent();
        }

        // Toggle checklist item completion
        function toggleChecklistItem(checklistId, itemId, checked) {
            const completionKey = getCompletionKey(checklistId);
            if (!opsState.completions[completionKey]) {
                opsState.completions[completionKey] = { completedItems: [], timestamp: new Date().toISOString() };
            }

            const completion = opsState.completions[completionKey];
            if (checked) {
                if (!completion.completedItems.includes(itemId)) {
                    completion.completedItems.push(itemId);
                }
            } else {
                completion.completedItems = completion.completedItems.filter(id => id !== itemId);
            }

            saveOpsData();
            renderChecklistContent();
        }

        // Add item to checklist
        function addChecklistItem(checklistId) {
            const input = document.getElementById(`newItemInput_${checklistId}`);
            const folderSelect = document.getElementById(`newItemFolder_${checklistId}`);
            const text = input.value.trim();
            if (!text) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            const folderId = folderSelect ? (folderSelect.value ? parseInt(folderSelect.value) : null) : null;

            const newItem = {
                id: Date.now(),
                text: text,
                order: checklist.items.length + 1,
                folderId: folderId,
                url: null
            };
            checklist.items.push(newItem);

            input.value = '';
            saveOpsData();
            renderChecklistContent();
        }

        // Edit checklist item (opens the item editor modal)
        function editChecklistItem(checklistId, itemId) {
            openItemEditor(checklistId, itemId);
        }

        // Delete checklist item
        function deleteChecklistItem(checklistId, itemId) {
            if (!confirm('Delete this item?')) return;

            const checklist = opsState.checklists.find(cl => cl.id === checklistId);
            if (!checklist) return;

            checklist.items = checklist.items.filter(i => i.id !== itemId);

            // Also remove from completions
            const completionKey = getCompletionKey(checklistId);
            if (opsState.completions[completionKey]) {
                opsState.completions[completionKey].completedItems =
                    opsState.completions[completionKey].completedItems.filter(id => id !== itemId);
            }

            saveOpsData();
            renderChecklistContent();
        }

        // Reset checklist progress for today
        function resetChecklistProgress(checklistId) {
            if (!confirm('Reset all checkmarks for today?')) return;

            const completionKey = getCompletionKey(checklistId);
            opsState.completions[completionKey] = { completedItems: [], timestamp: new Date().toISOString() };

            saveOpsData();
            renderChecklistContent();
        }

        // Open checklist editor modal
        function openChecklistEditor(checklistId = null) {
            opsState.editingChecklistId = checklistId;

            const titleEl = document.getElementById('checklistEditorTitle');
            const nameInput = document.getElementById('checklistNameInput');
            const positionInput = document.getElementById('checklistPositionInput');
            const deleteBtn = document.getElementById('checklistDeleteBtn');

            if (checklistId) {
                const checklist = opsState.checklists.find(cl => cl.id === checklistId);
                if (checklist) {
                    titleEl.textContent = 'Edit Checklist';
                    nameInput.value = checklist.name;
                    positionInput.value = checklist.position;
                    deleteBtn.style.display = 'block';
                }
            } else {
                titleEl.textContent = 'New Checklist';
                nameInput.value = '';
                positionInput.value = '';
                deleteBtn.style.display = 'none';
            }

            document.getElementById('checklistEditorModal').classList.add('active');
        }

        // Edit checklist details (name/position)
        function editChecklistDetails(checklistId) {
            openChecklistEditor(checklistId);
        }

        // Close checklist editor
        function closeChecklistEditor() {
            document.getElementById('checklistEditorModal').classList.remove('active');
            opsState.editingChecklistId = null;
        }

        // Save checklist from editor
        function saveChecklist() {
            const name = document.getElementById('checklistNameInput').value.trim();
            const position = document.getElementById('checklistPositionInput').value.trim();

            if (!name) {
                alert('Please enter a checklist name');
                return;
            }

            if (opsState.editingChecklistId) {
                // Update existing
                const checklist = opsState.checklists.find(cl => cl.id === opsState.editingChecklistId);
                if (checklist) {
                    checklist.name = name;
                    checklist.position = position || 'General';
                }
            } else {
                // Create new
                const newChecklist = {
                    id: Date.now(),
                    name: name,
                    position: position || 'General',
                    items: [],
                    folders: []
                };
                opsState.checklists.push(newChecklist);
                opsState.activeChecklistId = newChecklist.id;
            }

            saveOpsData();
            closeChecklistEditor();
            renderChecklistTabs();
        }

        // Delete checklist
        function deleteChecklist() {
            if (!opsState.editingChecklistId) return;
            if (!confirm('Delete this entire checklist? This cannot be undone.')) return;

            opsState.checklists = opsState.checklists.filter(cl => cl.id !== opsState.editingChecklistId);

            // Clean up completions
            Object.keys(opsState.completions).forEach(key => {
                if (key.endsWith(`_${opsState.editingChecklistId}`)) {
                    delete opsState.completions[key];
                }
            });

            opsState.activeChecklistId = opsState.checklists.length > 0 ? opsState.checklists[0].id : null;

            saveOpsData();
            closeChecklistEditor();
            renderChecklistTabs();
        }

        // Save operations data to server
        function saveOpsToServer() {
            const data = {
                checklists: opsState.checklists,
                completions: opsState.completions
            };

            fetch('api/save.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'operations', data: data })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Operations data saved to server successfully!');
                } else {
                    alert('Error saving to server: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(err => {
                alert('Error saving to server: ' + err.message);
            });
        }

        // Load operations data from server
        function loadOpsFromServer() {
            fetch('api/load.php?type=operations')
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    opsState.checklists = result.data.checklists || [];
                    opsState.completions = result.data.completions || {};
                    saveOpsData(); // Also save to localStorage
                    renderChecklistTabs();
                    alert('Operations data loaded from server!');
                } else {
                    alert('No operations data found on server or error: ' + (result.error || ''));
                }
            })
            .catch(err => {
                alert('Error loading from server: ' + err.message);
            });
        }

        // Export operations data to JSON file
        function exportOpsData() {
            const data = {
                checklists: opsState.checklists,
                completions: opsState.completions,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `operations_backup_${getTodayKey()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import operations data from JSON file
        function importOpsData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.checklists) {
                        if (confirm('This will replace your current checklists. Continue?')) {
                            opsState.checklists = data.checklists;
                            opsState.completions = data.completions || {};
                            opsState.activeChecklistId = opsState.checklists.length > 0 ? opsState.checklists[0].id : null;
                            saveOpsData();
                            renderChecklistTabs();
                            alert('Operations data imported successfully!');
                        }
                    } else {
                        alert('Invalid operations data file');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        // ========== V1.6.4 NEW FUNCTIONS ==========
        
        // localStorage functions
        function loadTechnicians() {
            const saved = localStorage.getItem('hd_technicians');
            if (saved) {
                state.technicians = JSON.parse(saved);
            } else {
                // Default technicians
                state.technicians = [
                    { name: 'John D.', pod: '1' },
                    { name: 'Sarah M.', pod: '2' },
                    { name: 'Mike R.', pod: '3' }
                ];
                saveTechnicians();
            }
        }
        
        function saveTechnicians() {
            localStorage.setItem('hd_technicians', JSON.stringify(state.technicians));
        }
        
        function loadSection() {
            const saved = localStorage.getItem('hd_current_section');
            if (saved && state.sections[saved]) {
                state.currentSection = saved;
            }
        }
        
        function saveSection() {
            localStorage.setItem('hd_current_section', state.currentSection);
        }

        // Save/load section order
        function saveSectionOrder() {
            localStorage.setItem('hd_section_order', JSON.stringify(state.sectionOrder));
        }

        function loadSectionOrder() {
            const saved = localStorage.getItem('hd_section_order');
            if (saved) {
                try {
                    state.sectionOrder = JSON.parse(saved);
                } catch (e) {
                    console.error('Failed to load section order:', e);
                }
            }
        }

        // Alias for backward compatibility
        function saveState() {
            saveSectionOrder();
        }

        // ========== THEME FUNCTIONS ==========
        let currentTheme = 'clinical-blue';
        
        function loadTheme() {
            const saved = localStorage.getItem('hd_theme');
            if (saved) {
                currentTheme = saved;
            }
            applyTheme(currentTheme);
        }
        
        function setTheme(themeName) {
            currentTheme = themeName;
            localStorage.setItem('hd_theme', themeName);
            applyTheme(themeName);
            updateThemeSelector();
        }
        
        function applyTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
        }
        
        function updateThemeSelector() {
            // Remove active class from all theme options
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            // Add active class to current theme
            const activeOption = document.querySelector(`.theme-option[data-theme-value="${currentTheme}"]`);
            if (activeOption) {
                activeOption.classList.add('active');
            }
        }
        
        // ========== SHIFT MANAGEMENT FUNCTIONS ==========
        
        function toggleShiftSelection(shift, isChecked) {
            if (isChecked) {
                if (!state.selectedShifts.includes(shift)) {
                    state.selectedShifts.push(shift);
                }
            } else {
                state.selectedShifts = state.selectedShifts.filter(s => s !== shift);
                // Ensure at least one shift is selected
                if (state.selectedShifts.length === 0) {
                    state.selectedShifts = ['1st'];
                    // Re-check the 1st shift checkbox
                    const firstShiftOption = document.querySelector('.shift-checkbox-option[data-shift="1st"] input');
                    if (firstShiftOption) firstShiftOption.checked = true;
                }
            }
            // Sort shifts in order
            state.selectedShifts.sort((a, b) => {
                const order = {'1st': 1, '2nd': 2, '3rd': 3};
                return order[a] - order[b];
            });
            // Update visual state
            updateShiftCheckboxVisuals();
            // Set active shift to first selected
            state.activeShift = state.selectedShifts[0];
            saveShifts();
        }
        
        function updateShiftCheckboxVisuals() {
            document.querySelectorAll('.shift-checkbox-option').forEach(opt => {
                const shift = opt.dataset.shift;
                if (state.selectedShifts.includes(shift)) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
        }
        
        function renderShiftTabs() {
            const container = document.getElementById('shiftTabs');
            const tabsContainer = document.getElementById('shiftTabsContainer');
            
            if (!container || !tabsContainer) return;
            
            // Only show shift tabs if more than one shift selected
            if (state.selectedShifts.length <= 1) {
                tabsContainer.style.display = 'none';
                return;
            }
            
            tabsContainer.style.display = 'flex';
            
            container.innerHTML = state.selectedShifts.map(shift => {
                const isActive = state.activeShift === shift;
                const patientsInShift = state.patients.filter(p => p.shift === shift).length;
                return `
                    <button class="shift-tab ${isActive ? 'active' : ''}" onclick="changeShift('${shift}')">
                        ${shift}
                        <span class="shift-count">${patientsInShift}</span>
                    </button>
                `;
            }).join('');
        }
        
        function changeShift(shift) {
            state.activeShift = shift;
            state.activePod = null; // Reset pod selection when changing shift
            state.activePatientId = null;
            renderShiftTabs();
            renderPodTabs();
            renderPatientTabs();
            renderTabContents();
            renderSummary();
        }
        
        function loadShifts() {
            const saved = localStorage.getItem('hd_selected_shifts');
            if (saved) {
                state.selectedShifts = JSON.parse(saved);
                state.activeShift = state.selectedShifts[0] || '1st';
            }
            // Update checkboxes to match saved state
            updateShiftCheckboxVisuals();
        }
        
        function saveShifts() {
            localStorage.setItem('hd_selected_shifts', JSON.stringify(state.selectedShifts));
        }

        // ========== DATA MANAGEMENT FUNCTIONS ==========

        function showSaveStatus(message, isError = false) {
            const statusEl = document.getElementById('saveStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = isError ? '#ef4444' : '#10b981';
                setTimeout(() => { statusEl.textContent = ''; }, 5000);
            }
        }

        async function saveToServer(silent = false) {
            try {
                if (!silent) showSaveStatus('Saving...');
                const data = {
                    patients: state.patients,
                    technicians: state.technicians,
                    currentSection: state.currentSection,
                    selectedShifts: state.selectedShifts,
                    timestampLogs: timestampState.logs,
                    savedAt: new Date().toISOString()
                };

                const response = await fetch('api/save.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Server error');

                const result = await response.json();
                return { success: true, timestamp: result.timestamp };
            } catch (error) {
                console.error('Save error:', error);
                return { success: false, error: error.message };
            }
        }

        // Universal Save All function - saves flowsheet, operations, and snippet data
        async function saveAll(isAutoSave = false) {
            const saveBtn = document.getElementById('universalSaveBtn');
            const saveStatus = document.getElementById('universalSaveStatus');
            const autoSaveIndicator = document.getElementById('autoSaveIndicator');

            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '⏳ Saving...';
            }

            try {
                // Save flowsheet data
                const flowsheetResult = await saveToServer(true);

                // Save operations data
                const opsResult = await saveOpsToServerAsync();

                // Save snippet data
                const snippetsResult = await saveSnippetsToServerAsync();

                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

                if (flowsheetResult.success && opsResult.success && snippetsResult.success) {
                    if (saveStatus) {
                        saveStatus.textContent = `Last saved: ${timeStr}`;
                        saveStatus.className = 'universal-save-status success';
                    }
                    if (autoSaveIndicator && isAutoSave) {
                        autoSaveIndicator.classList.add('flash');
                        setTimeout(() => autoSaveIndicator.classList.remove('flash'), 1000);
                    }
                    showSaveStatus(`All data saved at ${timeStr}`);
                } else {
                    const errors = [];
                    if (!flowsheetResult.success) errors.push('flowsheet');
                    if (!opsResult.success) errors.push('operations');
                    if (!snippetsResult.success) errors.push('snippets');
                    if (saveStatus) {
                        saveStatus.textContent = `Failed: ${errors.join(', ')}`;
                        saveStatus.className = 'universal-save-status error';
                    }
                    showSaveStatus(`Save failed for: ${errors.join(', ')}`, true);
                }
            } catch (error) {
                console.error('SaveAll error:', error);
                if (saveStatus) {
                    saveStatus.textContent = 'Save failed';
                    saveStatus.className = 'universal-save-status error';
                }
                showSaveStatus('Failed to save. Check console for details.', true);
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '💾 Save All';
                }
            }
        }

        // Async version of saveOpsToServer for use in saveAll
        async function saveOpsToServerAsync() {
            const data = {
                checklists: opsState.checklists,
                completions: opsState.completions
            };

            try {
                const response = await fetch('api/save.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'operations', data: data })
                });
                const result = await response.json();
                return { success: result.success };
            } catch (err) {
                return { success: false, error: err.message };
            }
        }

        // Save snippet data to server
        async function saveSnippetsToServerAsync() {
            const data = {
                configurations: snippetState.configurations,
                activeConfigId: snippetState.activeConfigId
            };

            try {
                const response = await fetch('api/save.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'snippets', data: data })
                });
                const result = await response.json();
                return { success: result.success };
            } catch (err) {
                return { success: false, error: err.message };
            }
        }

        // Auto-save state
        let autoSaveInterval = null;
        let autoSaveCountdown = 60;
        let countdownInterval = null;

        function startAutoSave() {
            // Clear any existing intervals
            if (autoSaveInterval) clearInterval(autoSaveInterval);
            if (countdownInterval) clearInterval(countdownInterval);

            autoSaveCountdown = 60;
            updateAutoSaveCountdown();

            // Countdown timer - updates every second
            countdownInterval = setInterval(() => {
                autoSaveCountdown--;
                if (autoSaveCountdown < 0) autoSaveCountdown = 60;
                updateAutoSaveCountdown();
            }, 1000);

            // Auto-save every 60 seconds
            autoSaveInterval = setInterval(() => {
                autoSaveCountdown = 60;
                saveAll(true);
            }, 60000);
        }

        function updateAutoSaveCountdown() {
            const countdownEl = document.getElementById('autoSaveCountdown');
            if (countdownEl) {
                countdownEl.textContent = `Auto-save in ${autoSaveCountdown}s`;
            }
        }

        function toggleAutoSave() {
            const toggle = document.getElementById('autoSaveToggle');
            const indicator = document.getElementById('autoSaveIndicator');
            const saveSection = document.getElementById('saveSection');

            if (autoSaveInterval) {
                // Turn off auto-save
                clearInterval(autoSaveInterval);
                clearInterval(countdownInterval);
                autoSaveInterval = null;
                countdownInterval = null;
                if (toggle) toggle.checked = false;
                if (indicator) indicator.classList.remove('active');
                if (saveSection) saveSection.classList.add('auto-save-warning');
                document.getElementById('autoSaveCountdown').textContent = 'Auto-save off';
            } else {
                // Turn on auto-save
                if (toggle) toggle.checked = true;
                if (indicator) indicator.classList.add('active');
                if (saveSection) saveSection.classList.remove('auto-save-warning');
                startAutoSave();
            }
        }

        async function loadFromServer() {
            if (!confirm('This will replace all current data. Continue?')) return;

            try {
                showSaveStatus('Loading...');
                const response = await fetch('api/load.php');

                if (response.status === 404) {
                    showSaveStatus('No saved data found on server.', true);
                    return;
                }

                if (!response.ok) throw new Error('Server error');

                const data = await response.json();

                // Clear EOSR edits and labs data from previous session
                clearEOSRAndLabsState();

                // Restore state
                if (data.patients) state.patients = data.patients;
                if (data.technicians) {
                    state.technicians = data.technicians;
                    saveTechnicians();
                }
                if (data.currentSection) {
                    state.currentSection = data.currentSection;
                    saveSection();
                }
                if (data.selectedShifts) {
                    state.selectedShifts = data.selectedShifts;
                    saveShifts();
                }
                if (data.timestampLogs) {
                    timestampState.logs = data.timestampLogs;
                    saveTimestampLogs();
                }

                // Load operations and snippets data
                await loadOpsAndSnippetsFromServer();

                renderAll();
                showSaveStatus(`Loaded data from ${data.savedAt || 'server'}`);
            } catch (error) {
                console.error('Load error:', error);
                showSaveStatus('Failed to load. Check console for details.', true);
            }
        }

        // Refresh App - saves data, sets auto-load flag, and reloads with cache busting
        async function refreshApp() {
            const btn = document.getElementById('refreshAppBtn');

            if (!confirm('This will:\n1. Save all current data to server\n2. Reload the app with latest code (clears cache)\n3. Automatically load your data back\n\nContinue?')) {
                return;
            }

            try {
                // Disable button and show progress
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '⏳ Saving...';
                }

                // Save all data to server first
                const saveResult = await saveToServer();

                if (!saveResult || !saveResult.success) {
                    throw new Error('Failed to save data to server');
                }

                // Also save operations and snippets data
                await saveOpsToServerAsync();
                await saveSnippetsToServerAsync();

                if (btn) {
                    btn.innerHTML = '🔄 Reloading...';
                }

                // Set flag to auto-load from server after refresh
                localStorage.setItem('hd_pending_server_load', 'true');

                // Reload with cache-busting query parameter
                // This forces the browser to fetch fresh HTML/JS/CSS
                const currentUrl = window.location.href.split('?')[0];
                window.location.href = currentUrl + '?v=' + Date.now();

            } catch (error) {
                console.error('Refresh error:', error);
                alert('Failed to save data before refresh. Please try again or save manually first.');

                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '🔄 Refresh App';
                }
            }
        }

        // Load operations and snippets data from server
        async function loadOpsAndSnippetsFromServer() {
            try {
                // Load operations data
                const opsResponse = await fetch('api/load.php?type=operations');
                if (opsResponse.ok) {
                    const opsData = await opsResponse.json();
                    if (opsData.checklists) opsState.checklists = opsData.checklists;
                    if (opsData.completions) opsState.completions = opsData.completions;
                    saveOpsData();
                }
            } catch (err) {
                console.warn('Could not load operations data:', err);
            }

            try {
                // Load snippet data
                const snippetsResponse = await fetch('api/load.php?type=snippets');
                if (snippetsResponse.ok) {
                    const snippetsData = await snippetsResponse.json();
                    if (snippetsData.configurations) {
                        snippetState.configurations = snippetsData.configurations;
                        snippetState.activeConfigId = snippetsData.activeConfigId || null;
                        saveSnippetData();
                    }
                }
            } catch (err) {
                console.warn('Could not load snippet data:', err);
            }
        }

        // Auto-load from server (called after refresh if flag is set)
        async function autoLoadFromServer() {
            try {
                showSaveStatus('Auto-loading saved data...');
                const response = await fetch('api/load.php');

                if (response.status === 404) {
                    showSaveStatus('No saved data found on server.', true);
                    return false;
                }

                if (!response.ok) throw new Error('Server error');

                const data = await response.json();

                // Clear EOSR edits and labs data from previous session
                clearEOSRAndLabsState();

                // Restore state
                if (data.patients) state.patients = data.patients;
                if (data.technicians) {
                    state.technicians = data.technicians;
                    saveTechnicians();
                }
                if (data.currentSection) {
                    state.currentSection = data.currentSection;
                    saveSection();
                }
                if (data.selectedShifts) {
                    state.selectedShifts = data.selectedShifts;
                    saveShifts();
                }
                if (data.timestampLogs) {
                    timestampState.logs = data.timestampLogs;
                    saveTimestampLogs();
                }

                // Load operations and snippets data
                await loadOpsAndSnippetsFromServer();

                renderAll();
                showSaveStatus(`Data restored from server (${data.savedAt || 'saved'})`);
                return true;
            } catch (error) {
                console.error('Auto-load error:', error);
                showSaveStatus('Failed to auto-load. Use Load from Server manually.', true);
                return false;
            }
        }

        function exportToFile() {
            const data = {
                patients: state.patients,
                technicians: state.technicians,
                currentSection: state.currentSection,
                selectedShifts: state.selectedShifts,
                timestampLogs: timestampState.logs,
                exportedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flowsheet-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showSaveStatus('File downloaded successfully');
        }

        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('This will replace all current data. Continue?')) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    // Restore state
                    if (data.patients) state.patients = data.patients;
                    if (data.technicians) {
                        state.technicians = data.technicians;
                        saveTechnicians();
                    }
                    if (data.currentSection) {
                        state.currentSection = data.currentSection;
                        saveSection();
                    }
                    if (data.selectedShifts) {
                        state.selectedShifts = data.selectedShifts;
                        saveShifts();
                    }
                    if (data.timestampLogs) {
                        timestampState.logs = data.timestampLogs;
                        saveTimestampLogs();
                    }

                    renderAll();
                    showSaveStatus(`Imported from ${file.name}`);
                } catch (error) {
                    console.error('Import error:', error);
                    showSaveStatus('Invalid file format.', true);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ========== TIMESTAMP QUICK NOTES FUNCTIONS ==========

        let timestampState = {
            selectedPatientId: null,
            logs: []
        };

        // Load timestamp logs from localStorage
        function loadTimestampLogs() {
            const saved = localStorage.getItem('hd_timestamp_logs');
            if (saved) {
                timestampState.logs = JSON.parse(saved);
            }
        }

        // Save timestamp logs to localStorage
        function saveTimestampLogs() {
            localStorage.setItem('hd_timestamp_logs', JSON.stringify(timestampState.logs));
        }

        // Get Phoenix, AZ time
        function getPhoenixTime() {
            const options = {
                timeZone: 'America/Phoenix',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return new Date().toLocaleTimeString('en-US', options);
        }

        // Update the current time display
        function updateTimestampClock() {
            const timeEl = document.getElementById('timestampCurrentTime');
            if (timeEl) {
                timeEl.textContent = `Current Time: ${getPhoenixTime()} (Phoenix, AZ)`;
            }
        }

        // Open timestamp modal
        function openTimestampModal() {
            loadTimestampLogs();
            timestampState.selectedPatientId = null;
            document.getElementById('timestampModal').classList.add('active');
            renderTimestampPatients();
            renderTimestampLog();
            updateTimestampClock();
            updateEventButtons();

            // Start clock update interval
            window.timestampClockInterval = setInterval(updateTimestampClock, 1000);
        }

        // Close timestamp modal
        function closeTimestampModal() {
            document.getElementById('timestampModal').classList.remove('active');
            if (window.timestampClockInterval) {
                clearInterval(window.timestampClockInterval);
            }
        }

        // Render patient buttons
        function renderTimestampPatients() {
            const grid = document.getElementById('timestampPatientGrid');
            const patients = state.patients.filter(p => p.name);

            if (patients.length === 0) {
                grid.innerHTML = '<div class="timestamp-log-empty">No patients added yet</div>';
                return;
            }

            grid.innerHTML = patients.map(p => `
                <div class="timestamp-patient-btn ${timestampState.selectedPatientId === p.id ? 'selected' : ''}"
                     onclick="selectTimestampPatient(${p.id})">
                    <div class="timestamp-patient-chair">Chair ${p.chair}</div>
                    <div class="timestamp-patient-name">${p.name}</div>
                </div>
            `).join('');
        }

        // Select a patient
        function selectTimestampPatient(patientId) {
            timestampState.selectedPatientId = patientId;
            renderTimestampPatients();
            updateEventButtons();

            const patient = state.patients.find(p => p.id === patientId);
            const display = document.getElementById('timestampSelectedDisplay');
            const text = document.getElementById('timestampSelectedText');

            if (patient) {
                display.classList.add('active');
                text.textContent = `Chair ${patient.chair} - ${patient.name}`;
            }
        }

        // Enable/disable event buttons based on patient selection
        function updateEventButtons() {
            const buttons = document.querySelectorAll('.timestamp-event-btn');
            const hasPatient = timestampState.selectedPatientId !== null;

            buttons.forEach(btn => {
                btn.disabled = !hasPatient;
            });
        }

        // Log a timestamp event
        function logTimestampEvent(eventType) {
            if (!timestampState.selectedPatientId) return;

            const patient = state.patients.find(p => p.id === timestampState.selectedPatientId);
            if (!patient) return;

            const logEntry = {
                id: Date.now(),
                time: getPhoenixTime(),
                timestamp: new Date().toISOString(),
                patientId: patient.id,
                chair: patient.chair,
                patientName: patient.name,
                event: eventType
            };

            timestampState.logs.unshift(logEntry);
            saveTimestampLogs();
            renderTimestampLog();
        }

        // Delete a timestamp log entry
        function deleteTimestampLog(logId) {
            timestampState.logs = timestampState.logs.filter(log => log.id !== logId);
            saveTimestampLogs();
            renderTimestampLog();
        }

        // Render timestamp log
        function renderTimestampLog() {
            const list = document.getElementById('timestampLogList');

            if (timestampState.logs.length === 0) {
                list.innerHTML = '<div class="timestamp-log-empty">No timestamps logged yet</div>';
                return;
            }

            list.innerHTML = timestampState.logs.map(log => `
                <div class="timestamp-log-item" data-log-id="${log.id}" onclick="copyTimestampEntry(this, ${log.id})" title="Click to copy" style="cursor: pointer;">
                    <div class="timestamp-log-time">${log.time}</div>
                    <div class="timestamp-log-patient">Chair ${log.chair} - ${log.patientName}</div>
                    <div class="timestamp-log-event">${log.event}</div>
                    <span class="timestamp-copy-icon">📋</span>
                    <button class="timestamp-log-delete" onclick="event.stopPropagation(); deleteTimestampLog(${log.id})">🗑️</button>
                </div>
            `).join('');
        }

        function copyTimestampEntry(element, logId) {
            const log = timestampState.logs.find(l => l.id === logId);
            if (log) {
                const text = log.time;
                navigator.clipboard.writeText(text).then(() => {
                    // Visual feedback - flash green
                    element.style.background = '#d1fae5';
                    element.style.transition = 'background 0.3s';
                    setTimeout(() => {
                        element.style.background = '';
                    }, 500);
                });
            }
        }

        // Settings Modal functions
        function openSettingsModal() {
            renderTechList();
            updateThemeSelector();
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('newTechName').value = '';
            document.getElementById('newTechPod').value = '';
            
            // Re-render patient cards to reflect any tech changes
            if (state.patients.length > 0) {
                renderAll();
            }
        }
        
        function renderTechList() {
            const container = document.getElementById('techList');
            if (state.technicians.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">No technicians added yet. Add one below!</div>';
                return;
            }
            
            container.innerHTML = state.technicians.map((tech, index) => `
                <div class="tech-item" id="tech-item-${index}">
                    <div class="tech-info">
                        <div class="tech-name">${tech.name}</div>
                        <div class="tech-pod">📍 Pod ${tech.pod}</div>
                    </div>
                    <div class="tech-actions">
                        <button class="btn-icon" onclick="editTechnician(${index})" title="Edit">✏️</button>
                        <button class="btn-icon delete" onclick="deleteTechnician(${index})" title="Delete">🗑️</button>
                    </div>
                </div>
            `).join('');
        }
        
        function addTechnician() {
            const nameInput = document.getElementById('newTechName');
            const podSelect = document.getElementById('newTechPod');
            
            const name = nameInput.value.trim();
            const pod = podSelect.value;
            
            if (!name) {
                alert('Please enter a technician name');
                return;
            }
            
            if (!pod) {
                alert('Please select a pod');
                return;
            }
            
            state.technicians.push({ name, pod });
            saveTechnicians();
            renderTechList();
            
            nameInput.value = '';
            podSelect.value = '';
        }
        
        function editTechnician(index) {
            const tech = state.technicians[index];
            const item = document.getElementById(`tech-item-${index}`);
            
            item.classList.add('editing');
            item.innerHTML = `
                <div class="tech-info" style="flex: 1;">
                    <input type="text" id="edit-name-${index}" class="edit-tech-input" value="${tech.name}" style="margin-bottom: 8px;">
                    <select id="edit-pod-${index}" class="edit-tech-select">
                        <option value="1" ${tech.pod === '1' ? 'selected' : ''}>Pod 1</option>
                        <option value="2" ${tech.pod === '2' ? 'selected' : ''}>Pod 2</option>
                        <option value="3" ${tech.pod === '3' ? 'selected' : ''}>Pod 3</option>
                        <option value="4" ${tech.pod === '4' ? 'selected' : ''}>Pod 4</option>
                        <option value="5" ${tech.pod === '5' ? 'selected' : ''}>Pod 5</option>
                        <option value="6" ${tech.pod === '6' ? 'selected' : ''}>Pod 6</option>
                    </select>
                </div>
                <div class="tech-actions">
                    <button class="btn-save" onclick="saveTechEdit(${index})">💾 Save</button>
                    <button class="btn-cancel" onclick="renderTechList()">Cancel</button>
                </div>
            `;
        }
        
        function saveTechEdit(index) {
            const name = document.getElementById(`edit-name-${index}`).value.trim();
            const pod = document.getElementById(`edit-pod-${index}`).value;
            
            if (!name) {
                alert('Name cannot be empty');
                return;
            }
            
            // Get old tech info before updating
            const oldTech = state.technicians[index];
            const oldName = oldTech.name;
            const oldPod = oldTech.pod;
            
            // Update the technician
            state.technicians[index] = { name, pod };
            saveTechnicians();
            
            // Update all patients assigned to this tech
            state.patients.forEach(patient => {
                if (patient.technician === oldName) {
                    // Update tech name if it changed
                    patient.technician = name;
                    // Update pod to new pod
                    patient.pod = pod;
                }
            });
            
            renderTechList();
        }
        
        function deleteTechnician(index) {
            const tech = state.technicians[index];
            if (confirm(`Delete ${tech.name}? Patients assigned to this tech will have their assignment cleared.`)) {
                // Clear tech/pod from any patients assigned to this tech
                state.patients.forEach(patient => {
                    if (patient.technician === tech.name) {
                        patient.technician = '';
                        patient.pod = '';
                    }
                });
                
                state.technicians.splice(index, 1);
                saveTechnicians();
                renderTechList();
            }
        }
        
        function clearAllTechs() {
            if (state.technicians.length === 0) {
                alert('No technicians to clear!');
                return;
            }
            
            const count = state.technicians.length;
            if (confirm(`Clear all ${count} technician(s)? All patient assignments will be cleared. This cannot be undone.`)) {
                // Clear tech/pod from all patients
                state.patients.forEach(patient => {
                    patient.technician = '';
                    patient.pod = '';
                });
                
                state.technicians = [];
                saveTechnicians();
                renderTechList();
            }
        }
        
        // Bulk Assign Modal State
        const bulkAssignState = {
            selectedPatients: new Set(),
            tempAssignments: {}, // {patientId: {technician, pod, chair}}
            activeShift: null // Current shift being edited in bulk assign
        };
        
        function openBulkAssign() {
            if (state.patients.length === 0) {
                alert('No patients to assign! Import patients first.');
                return;
            }
            
            // Reset state
            bulkAssignState.selectedPatients.clear();
            bulkAssignState.tempAssignments = {};
            bulkAssignState.activeShift = state.activeShift;
            
            // Copy current assignments to temp for ALL patients
            state.patients.forEach(p => {
                bulkAssignState.tempAssignments[p.id] = {
                    technician: p.technician || '',
                    pod: p.pod || '',
                    chair: p.chair || '',
                    shift: p.technician ? p.shift : '' // Only set shift if already assigned
                };
            });
            
            // Render shift tabs in bulk assign modal
            renderBulkAssignShiftTabs();
            
            // Populate dropdowns
            populateQuickFillDropdowns();
            renderBulkAssignTable();
            updateBulkAssignStats();
            
            document.getElementById('bulkAssignModal').classList.add('active');
        }
        
        function renderBulkAssignShiftTabs() {
            const container = document.getElementById('bulkAssignShiftTabs');
            if (!container) return;
            
            // Only show tabs if more than one shift
            if (state.selectedShifts.length <= 1) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = state.selectedShifts.map(shift => {
                const isActive = bulkAssignState.activeShift === shift;
                
                // Count patients visible in this tab
                const visibleCount = state.patients.filter(p => {
                    const temp = bulkAssignState.tempAssignments[p.id];
                    const hasTech = temp ? temp.technician : p.technician;
                    const assignedShift = temp && temp.shift ? temp.shift : p.shift;
                    return !hasTech || assignedShift === shift;
                }).length;
                
                return `
                    <button class="bulk-assign-shift-tab ${isActive ? 'active' : ''}" 
                        onclick="changeBulkAssignShift('${shift}')">
                        ${shift} Shift
                        <span style="opacity: 0.8; font-size: 0.85em;">(${visibleCount})</span>
                    </button>
                `;
            }).join('');
        }
        
        function changeBulkAssignShift(shift) {
            bulkAssignState.activeShift = shift;
            bulkAssignState.selectedPatients.clear();
            
            renderBulkAssignShiftTabs();
            renderBulkAssignTable();
            updateBulkAssignStats();
        }
        
        function closeBulkAssign() {
            document.getElementById('bulkAssignModal').classList.remove('active');
        }
        
        function populateQuickFillDropdowns() {
            // Tech dropdown
            const techSelect = document.getElementById('quickFillTech');
            techSelect.innerHTML = '<option value="">Select Tech...</option>' + 
                state.technicians.map(t => 
                    `<option value="${t.name}" data-pod="${t.pod}">${t.name} (Pod ${t.pod})</option>`
                ).join('');
            
            // Chair dropdown - based on current section
            const chairSelect = document.getElementById('quickFillChairStart');
            const chairs = state.sections[state.currentSection]?.chairs || [];
            chairSelect.innerHTML = '<option value="">Select Chair...</option>' + 
                chairs.map(c => `<option value="${c}">Chair ${c}</option>`).join('');
        }
        
        function renderBulkAssignTable() {
            const tbody = document.getElementById('bulkAssignTableBody');
            const chairs = state.sections[state.currentSection]?.chairs || [];
            
            // Show patients that are either:
            // 1. Assigned to this shift (have technician AND shift matches), OR
            // 2. Unassigned (no technician) - these appear in ALL shift tabs
            const shiftPatients = state.patients.filter(p => {
                const temp = bulkAssignState.tempAssignments[p.id];
                const hasTech = temp ? temp.technician : p.technician;
                
                if (!hasTech) {
                    // Unassigned patients show in all tabs
                    return true;
                }
                // Assigned patients only show in their shift tab
                return p.shift === bulkAssignState.activeShift;
            });
            
            tbody.innerHTML = shiftPatients.map(patient => {
                const temp = bulkAssignState.tempAssignments[patient.id] || {
                    technician: patient.technician || '',
                    pod: patient.pod || '',
                    chair: patient.chair || ''
                };
                
                // Ensure temp assignment exists for this patient
                if (!bulkAssignState.tempAssignments[patient.id]) {
                    bulkAssignState.tempAssignments[patient.id] = temp;
                }
                
                const isSelected = bulkAssignState.selectedPatients.has(patient.id);
                const isUnassigned = !temp.technician;
                
                return `
                    <tr class="${isSelected ? 'selected' : ''} ${isUnassigned ? 'unassigned-row' : ''}" data-patient-id="${patient.id}">
                        <td>
                            <input type="checkbox" 
                                ${isSelected ? 'checked' : ''} 
                                onchange="toggleBulkPatientSelection(${patient.id}, this.checked)">
                        </td>
                        <td class="patient-name">
                            ${patient.name}
                            ${isUnassigned ? '<span class="unassigned-badge">Unassigned</span>' : ''}
                        </td>
                        <td>
                            <select onchange="updateTempAssignment(${patient.id}, 'technician', this.value)">
                                <option value="">Select Tech...</option>
                                ${state.technicians.map(t => 
                                    `<option value="${t.name}" data-pod="${t.pod}" 
                                        ${temp.technician === t.name ? 'selected' : ''}>
                                        ${t.name} (Pod ${t.pod})
                                    </option>`
                                ).join('')}
                            </select>
                        </td>
                        <td class="pod-cell ${temp.pod ? '' : 'empty'}">
                            ${temp.pod ? 'Pod ' + temp.pod : '—'}
                        </td>
                        <td>
                            <select onchange="updateTempAssignment(${patient.id}, 'chair', this.value)">
                                <option value="">Select Chair...</option>
                                ${chairs.map(c => 
                                    `<option value="${c}" ${temp.chair === String(c) ? 'selected' : ''}>
                                        Chair ${c}
                                    </option>`
                                ).join('')}
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function toggleBulkPatientSelection(patientId, isChecked) {
            if (isChecked) {
                bulkAssignState.selectedPatients.add(patientId);
            } else {
                bulkAssignState.selectedPatients.delete(patientId);
            }
            
            // Update row styling
            const row = document.querySelector(`tr[data-patient-id="${patientId}"]`);
            if (row) {
                row.classList.toggle('selected', isChecked);
            }
            
            updateBulkAssignStats();
        }
        
        function selectAllPatients() {
            // Select only patients visible in current tab (assigned to this shift OR unassigned)
            state.patients.forEach(p => {
                const temp = bulkAssignState.tempAssignments[p.id];
                const hasTech = temp ? temp.technician : p.technician;
                
                if (!hasTech || p.shift === bulkAssignState.activeShift) {
                    bulkAssignState.selectedPatients.add(p.id);
                }
            });
            renderBulkAssignTable();
            updateBulkAssignStats();
        }
        
        function clearAllSelections() {
            bulkAssignState.selectedPatients.clear();
            renderBulkAssignTable();
            updateBulkAssignStats();
        }
        
        function updateTempAssignment(patientId, field, value) {
            if (!bulkAssignState.tempAssignments[patientId]) {
                bulkAssignState.tempAssignments[patientId] = { shift: '' };
            }
            
            bulkAssignState.tempAssignments[patientId][field] = value;
            
            // Auto-fill pod when tech is selected AND set shift
            if (field === 'technician') {
                const tech = state.technicians.find(t => t.name === value);
                bulkAssignState.tempAssignments[patientId].pod = tech ? tech.pod : '';
                
                // Set the shift to the current tab when tech is assigned
                if (value) {
                    bulkAssignState.tempAssignments[patientId].shift = bulkAssignState.activeShift;
                } else {
                    // Clear shift when tech is removed
                    bulkAssignState.tempAssignments[patientId].shift = '';
                }
                
                // Update pod cell display
                const row = document.querySelector(`tr[data-patient-id="${patientId}"]`);
                if (row) {
                    const podCell = row.querySelector('.pod-cell');
                    if (podCell) {
                        podCell.textContent = tech ? 'Pod ' + tech.pod : '—';
                        podCell.classList.toggle('empty', !tech);
                    }
                    
                    // Update row styling for unassigned
                    row.classList.toggle('unassigned-row', !value);
                    
                    // Update unassigned badge
                    const badge = row.querySelector('.unassigned-badge');
                    if (badge) {
                        badge.style.display = value ? 'none' : 'inline';
                    }
                }
            }
            
            updateBulkAssignStats();
        }
        
        function applyQuickFill() {
            if (bulkAssignState.selectedPatients.size === 0) {
                alert('Select at least one patient to apply quick fill!');
                return;
            }
            
            const techName = document.getElementById('quickFillTech').value;
            const chairStart = document.getElementById('quickFillChairStart').value;
            
            if (!techName && !chairStart) {
                alert('Select at least a technician or starting chair!');
                return;
            }
            
            const tech = state.technicians.find(t => t.name === techName);
            const chairs = state.sections[state.currentSection]?.chairs || [];
            let chairIndex = chairs.indexOf(parseInt(chairStart));
            
            // Get selected patients in order
            const selectedInOrder = state.patients.filter(p => 
                bulkAssignState.selectedPatients.has(p.id)
            );
            
            selectedInOrder.forEach((patient, i) => {
                if (!bulkAssignState.tempAssignments[patient.id]) {
                    bulkAssignState.tempAssignments[patient.id] = { shift: '' };
                }
                
                // Apply tech if selected
                if (techName) {
                    bulkAssignState.tempAssignments[patient.id].technician = techName;
                    bulkAssignState.tempAssignments[patient.id].pod = tech ? tech.pod : '';
                    // Set shift when tech is assigned
                    bulkAssignState.tempAssignments[patient.id].shift = bulkAssignState.activeShift;
                }
                
                // Apply chair with auto-increment
                if (chairStart && chairIndex >= 0 && chairIndex < chairs.length) {
                    bulkAssignState.tempAssignments[patient.id].chair = String(chairs[chairIndex]);
                    chairIndex++;
                }
            });
            
            renderBulkAssignTable();
            updateBulkAssignStats();
        }
        
        function updateBulkAssignStats() {
            document.getElementById('selectedCount').textContent = bulkAssignState.selectedPatients.size;
            
            // Count how many have assignments
            let assignedCount = 0;
            Object.values(bulkAssignState.tempAssignments).forEach(a => {
                if (a.technician || a.chair) assignedCount++;
            });
            document.getElementById('assignedCount').textContent = assignedCount;
        }
        
        function saveBulkAssignments() {
            // Apply temp assignments to actual patients
            state.patients.forEach(patient => {
                const temp = bulkAssignState.tempAssignments[patient.id];
                if (temp) {
                    patient.technician = temp.technician || '';
                    patient.pod = temp.pod || '';
                    patient.chair = temp.chair || '';
                    
                    // Set shift if patient was assigned a tech
                    if (temp.technician && temp.shift) {
                        patient.shift = temp.shift;
                    }
                }
            });
            
            closeBulkAssign();
            renderAll();
            
            // Show success message
            const count = Object.values(bulkAssignState.tempAssignments).filter(a => a.technician || a.chair).length;
            if (count > 0) {
                alert(`✓ Saved assignments for ${count} patient(s)!`);
            }
        }
        
        // ========== QUICK NOTES FUNCTIONS ==========
        function openQuickNotes() {
            const activePatient = state.patients.find(p => p.id === state.activePatientId);
            if (!activePatient) {
                alert('Please select a patient first.');
                return;
            }
            
            // Set patient name in header
            document.getElementById('quickNotesPatient').textContent = `${activePatient.name} - Chair ${activePatient.chair || 'N/A'}`;
            
            // Load existing notes
            document.getElementById('quickNotesText').value = activePatient.quickNotes || '';
            
            // Show modal
            document.getElementById('quickNotesModal').classList.add('active');
            
            // Focus textarea
            setTimeout(() => {
                document.getElementById('quickNotesText').focus();
            }, 100);
        }
        
        function closeQuickNotes() {
            document.getElementById('quickNotesModal').classList.remove('active');
        }
        
        function saveQuickNotes() {
            const activePatient = state.patients.find(p => p.id === state.activePatientId);
            if (!activePatient) return;
            
            activePatient.quickNotes = document.getElementById('quickNotesText').value;
            
            closeQuickNotes();
            renderAll(); // Update any note indicators if we add them later
        }
        
        // ========== QUICK CHART FUNCTIONS ==========
        let quickChartPatientId = null;
        
        function openQuickChart(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            quickChartPatientId = patientId;
            
            // Set patient name in header
            document.getElementById('quickChartPatient').textContent = `${patient.name} - Chair ${patient.chair || 'N/A'}`;
            
            // Populate fields
            document.getElementById('qc_dryWeight').value = patient.dryWeight || '';
            document.getElementById('qc_preWeight').value = patient.preWeight || '';
            document.getElementById('qc_goalUF').value = patient.goalUF || '';
            document.getElementById('qc_postWeight').value = patient.postWeight || '';
            document.getElementById('qc_startTime').value = patient.startTime || '';
            document.getElementById('qc_endTime').value = patient.endTime || '';
            
            // Populate checkboxes
            const checkFields = ['preCheck', 'thirtyMinCheck', 'medsComplete', 'abxIDPN', 'statLabs', 'missedTx', 'whiteboard', 'labsPrep', 'ettSigned'];
            checkFields.forEach(field => {
                const checkbox = document.getElementById(`qc_${field}`);
                const label = document.getElementById(`qc_${field}_label`);
                if (checkbox && label) {
                    checkbox.checked = patient[field] || false;
                    if (checkbox.checked) {
                        label.classList.add('checked');
                    } else {
                        label.classList.remove('checked');
                    }
                }
            });
            
            // Update field styling
            updateQuickChartFieldStyles();
            
            // Show modal
            document.getElementById('quickChartModal').classList.add('active');
        }
        
        function closeQuickChart() {
            document.getElementById('quickChartModal').classList.remove('active');
            quickChartPatientId = null;
        }
        
        function toggleQuickChartCheck(field) {
            const checkbox = document.getElementById(`qc_${field}`);
            const label = document.getElementById(`qc_${field}_label`);
            if (checkbox.checked) {
                label.classList.add('checked');
            } else {
                label.classList.remove('checked');
            }
        }
        
        function updateQuickChartFieldStyles() {
            const textFields = ['dryWeight', 'preWeight', 'goalUF', 'postWeight', 'startTime', 'endTime'];
            textFields.forEach(field => {
                const input = document.getElementById(`qc_${field}`);
                if (input) {
                    input.classList.remove('filled', 'empty');
                    if (input.value.trim()) {
                        input.classList.add('filled');
                    } else {
                        input.classList.add('empty');
                    }
                }
            });
        }
        
        // Add input listeners for real-time styling
        document.addEventListener('DOMContentLoaded', function() {
            const textFields = ['dryWeight', 'preWeight', 'goalUF', 'postWeight', 'startTime', 'endTime'];
            textFields.forEach(field => {
                const input = document.getElementById(`qc_${field}`);
                if (input) {
                    input.addEventListener('input', updateQuickChartFieldStyles);
                }
            });
        });
        
        function saveQuickChart() {
            const patient = state.patients.find(p => p.id === quickChartPatientId);
            if (!patient) return;
            
            // Save text fields
            patient.dryWeight = document.getElementById('qc_dryWeight').value;
            patient.preWeight = document.getElementById('qc_preWeight').value;
            patient.goalUF = document.getElementById('qc_goalUF').value;
            patient.postWeight = document.getElementById('qc_postWeight').value;
            patient.startTime = document.getElementById('qc_startTime').value;
            patient.endTime = document.getElementById('qc_endTime').value;
            
            // Save checkboxes
            const checkFields = ['preCheck', 'thirtyMinCheck', 'medsComplete', 'abxIDPN', 'statLabs', 'missedTx', 'whiteboard', 'labsPrep', 'ettSigned'];
            checkFields.forEach(field => {
                const checkbox = document.getElementById(`qc_${field}`);
                if (checkbox) {
                    patient[field] = checkbox.checked;
                }
            });
            
            closeQuickChart();
            renderAll();
        }
        
        // Section Selector functions
        function renderSectionSelector() {
            const container = document.getElementById('sectionOptions');
            if (!container) return;
            
            container.innerHTML = Object.keys(state.sections).map(sectionKey => {
                const section = state.sections[sectionKey];
                const selected = state.currentSection === sectionKey ? 'selected' : '';
                return `
                    <label class="section-option ${selected}">
                        <input type="radio" name="section" class="section-radio" value="${sectionKey}" 
                            ${selected ? 'checked' : ''} onchange="changeSection('${sectionKey}')">
                        <span class="section-label">${section.name}</span>
                        <span class="section-info">${section.info}</span>
                    </label>
                `;
            }).join('');
        }
        
        function changeSection(sectionKey) {
            state.currentSection = sectionKey;
            saveSection();
            renderSectionSelector();
        }

        // Toggle section collapse
        function toggleSection(patientId, sectionName) {
            const key = `${patientId}_${sectionName}`;
            if (!state.collapsedSections[key]) {
                state.collapsedSections[key] = false;
            }
            state.collapsedSections[key] = !state.collapsedSections[key];
            
            // Update UI
            const header = document.querySelector(`[data-section="${key}"]`);
            const content = header.nextElementSibling;
            
            if (state.collapsedSections[key]) {
                header.classList.add('collapsed');
                content.classList.add('collapsed');
            } else {
                header.classList.remove('collapsed');
                content.classList.remove('collapsed');
            }
        }

        // Expand all sections for a patient
        function expandAllSections(patientId) {
            const sectionNames = ['techcheck', 'qa', 'assignment', 'orders', 'weight', 'time'];
            sectionNames.forEach(sectionName => {
                const key = `${patientId}_${sectionName}`;
                state.collapsedSections[key] = false;
                const header = document.querySelector(`[data-section="${key}"]`);
                if (header) {
                    const content = header.nextElementSibling;
                    header.classList.remove('collapsed');
                    content.classList.remove('collapsed');
                }
            });
        }

        // Collapse all sections for a patient
        function collapseAllSections(patientId) {
            const sectionNames = ['techcheck', 'qa', 'assignment', 'orders', 'weight', 'time'];
            sectionNames.forEach(sectionName => {
                const key = `${patientId}_${sectionName}`;
                state.collapsedSections[key] = true;
                const header = document.querySelector(`[data-section="${key}"]`);
                if (header) {
                    const content = header.nextElementSibling;
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                }
            });
        }

        // Section drag state
        let sectionDragState = {
            draggedSection: null,
            draggedSectionId: null,
            patientId: null
        };

        // Initialize section order in state if needed
        function initSectionOrder() {
            if (!state.sectionOrder) {
                state.sectionOrder = ['techcheck', 'qa', 'assignment', 'orders', 'weight', 'time'];
            }
        }

        // Section drag and drop handlers
        function handleSectionDragStart(event, patientId) {
            initSectionOrder();
            const section = event.target.closest('.collapsible-section');
            sectionDragState.draggedSection = section;
            sectionDragState.draggedSectionId = section.dataset.sectionId;
            sectionDragState.patientId = patientId;
            section.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleSectionDragEnd(event) {
            event.target.closest('.collapsible-section').classList.remove('dragging');
            document.querySelectorAll('.collapsible-section.drag-over').forEach(el => el.classList.remove('drag-over'));
            sectionDragState.draggedSection = null;
            sectionDragState.draggedSectionId = null;
            sectionDragState.patientId = null;
        }

        function handleSectionDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            const section = event.target.closest('.collapsible-section');
            if (section && section !== sectionDragState.draggedSection) {
                // Remove drag-over from all sections first
                document.querySelectorAll('.collapsible-section.drag-over').forEach(el => el.classList.remove('drag-over'));
                section.classList.add('drag-over');
            }
        }

        function handleSectionDragLeave(event) {
            const section = event.target.closest('.collapsible-section');
            if (section) {
                section.classList.remove('drag-over');
            }
        }

        function handleSectionDrop(event, patientId) {
            event.preventDefault();
            const targetSection = event.target.closest('.collapsible-section');
            if (targetSection) targetSection.classList.remove('drag-over');

            if (!sectionDragState.draggedSectionId) return;

            const targetSectionId = targetSection?.dataset.sectionId;
            if (!targetSectionId || sectionDragState.draggedSectionId === targetSectionId) return;

            initSectionOrder();

            // Get current order
            const order = [...state.sectionOrder];
            const draggedIndex = order.indexOf(sectionDragState.draggedSectionId);
            const targetIndex = order.indexOf(targetSectionId);

            if (draggedIndex === -1 || targetIndex === -1) return;

            // Remove dragged item and insert at new position
            order.splice(draggedIndex, 1);
            order.splice(targetIndex, 0, sectionDragState.draggedSectionId);

            // Update state
            state.sectionOrder = order;
            saveState();

            // Reorder the sections in the DOM for ALL patients
            reorderSectionsInDOM();
        }

        // Reorder sections in DOM based on saved order
        function reorderSectionsInDOM() {
            initSectionOrder();
            state.patients.forEach(patient => {
                const container = document.getElementById(`sectionsContainer_${patient.id}`);
                if (!container) return;

                const sections = {};
                container.querySelectorAll('.collapsible-section').forEach(section => {
                    sections[section.dataset.sectionId] = section;
                });

                // Reorder based on saved order
                state.sectionOrder.forEach(sectionId => {
                    if (sections[sectionId]) {
                        container.appendChild(sections[sectionId]);
                    }
                });
            });
        }

        // Toggle Tech Check item (checked = missing from chart)
        function toggleTechCheck(patientId, field, event) {
            event.stopPropagation();
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            // Initialize techCheck if it doesn't exist
            if (!patient.techCheck) {
                patient.techCheck = {
                    initiationTime: false,
                    orderVerification: false,
                    txInitiated: false,
                    txEnded: false,
                    blankVitalsNotes: false,
                    heparinBolus: false,
                    lidocaine: false,
                    postWeight: false
                };
            }
            
            patient.techCheck[field] = !patient.techCheck[field];
            renderAll();
        }
        
        // Get tech check issues for a patient
        function getTechCheckIssues(patient) {
            if (!patient.techCheck) return [];
            
            const issueLabels = {
                initiationTime: 'Initiation Time',
                orderVerification: 'Order Verification',
                accessEvalTime: 'Access Eval. Time',
                txInitiated: 'Tx Initiated',
                txEnded: 'Tx Ended',
                blankVitalsNotes: 'Blank Vitals Notes',
                heparinBolus: 'Heparin Bolus',
                lidocaine: 'Lidocaine',
                postWeight: 'Post Weight'
            };
            
            const issues = [];
            for (const [key, label] of Object.entries(issueLabels)) {
                if (patient.techCheck[key]) {
                    issues.push(label);
                }
            }
            return issues;
        }
        
        // Get tech check count for all patients under a technician
        function getTechCheckCountForTech(techName) {
            const techPatients = state.patients.filter(p => 
                p.technician === techName && p.shift === state.activeShift
            );
            
            let totalIssues = 0;
            const allIssues = [];
            
            techPatients.forEach(patient => {
                const issues = getTechCheckIssues(patient);
                totalIssues += issues.length;
                if (issues.length > 0) {
                    allIssues.push({
                        patient: patient.name,
                        issues: issues
                    });
                }
            });
            
            return { count: totalIssues, details: allIssues };
        }

        // Convert name to initials (HIPAA compliant)
        function nameToInitials(fullName) {
            if (!fullName) return '';
            const parts = fullName.trim().split(/[\s,]+/).filter(p => p.length > 0);
            if (parts.length === 0) return '';
            
            if (fullName.includes(',')) {
                const [last, first] = fullName.split(',').map(s => s.trim());
                return `${first.charAt(0)}.${last.charAt(0)}.`;
            }
            
            if (parts.length >= 2) {
                return `${parts[0].charAt(0)}.${parts[1].charAt(0)}.`;
            }
            
            return `${parts[0].charAt(0)}.`;
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    state.excelData = jsonData;
                    displayPatientSelector(jsonData);
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid Excel file.');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Display patient selector
        function displayPatientSelector(data) {
            const patientList = document.getElementById('patientList');
            const section = document.getElementById('patientSelectorSection');
            
            patientList.innerHTML = '';
            state.selectedPatients.clear();
            
            // Initialize assignment storage
            if (!state.patientAssignments) {
                state.patientAssignments = {};
            }
            
            // Get current section chairs
            const currentSectionData = state.sections[state.currentSection];
            const chairOptions = currentSectionData.chairs.length > 0
                ? currentSectionData.chairs.map(chair => `<option value="${chair}">Chair ${chair}</option>`).join('')
                : '<option value="">No chairs defined</option>';
            
            // Generate tech dropdown options
            const techOptions = state.technicians.map(tech => 
                `<option value="${tech.name}" data-pod="${tech.pod}">${tech.name} (Pod ${tech.pod})</option>`
            ).join('');
            
            data.forEach((patient, index) => {
                const initials = nameToInitials(patient['Patient Name']);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'patient-item';
                itemDiv.id = `patient-card-${index}`;
                
                // Initialize assignment data
                if (!state.patientAssignments[index]) {
                    state.patientAssignments[index] = {
                        technician: '',
                        pod: '',
                        chair: ''
                    };
                }
                
                itemDiv.innerHTML = `
                    <div class="patient-item-header">
                        <input type="checkbox" id="patient_${index}" 
                            onchange="togglePatientSelection(${index}, this.checked)">
                        <label for="patient_${index}" class="patient-initials">${initials}</label>
                    </div>
                    <div class="assignment-field">
                        <label class="assignment-label">Technician</label>
                        <select class="assignment-select" id="tech_${index}" disabled 
                            onchange="onTechSelected(${index}, this.value)">
                            <option value="">Select Tech...</option>
                            ${techOptions}
                        </select>
                    </div>
                    <div class="assignment-field">
                        <label class="assignment-label">Pod (auto-assigned)</label>
                        <input type="text" class="assignment-input" id="pod_${index}" 
                            placeholder="Auto-fills from tech" disabled readonly>
                        <div class="auto-label" id="pod-label_${index}" style="display: none;">✓ Auto-filled from tech</div>
                    </div>
                    <div class="assignment-field">
                        <label class="assignment-label">Chair # (${state.currentSection})</label>
                        <select class="assignment-select" id="chair_${index}" disabled 
                            onchange="updateAssignment(${index}, 'chair', this.value)">
                            <option value="">Select Chair...</option>
                            ${chairOptions}
                        </select>
                    </div>
                `;
                
                patientList.appendChild(itemDiv);
            });
            
            section.style.display = 'block';
            updateImportButton();
        }
        
        // Handle tech selection and auto-fill pod
        function onTechSelected(index, techName) {
            updateAssignment(index, 'technician', techName);
            
            if (!techName) {
                // Clear pod if tech is deselected
                const podInput = document.getElementById(`pod_${index}`);
                const podLabel = document.getElementById(`pod-label_${index}`);
                podInput.value = '';
                podInput.classList.remove('auto-filled');
                podLabel.style.display = 'none';
                updateAssignment(index, 'pod', '');
                return;
            }
            
            // Find tech and get their pod
            const tech = state.technicians.find(t => t.name === techName);
            if (tech) {
                const podInput = document.getElementById(`pod_${index}`);
                const podLabel = document.getElementById(`pod-label_${index}`);
                podInput.value = `Pod ${tech.pod}`;
                podInput.classList.add('auto-filled');
                podLabel.style.display = 'block';
                updateAssignment(index, 'pod', tech.pod);
            }
        }
        
        // Update assignment data
        function updateAssignment(index, field, value) {
            if (!state.patientAssignments[index]) {
                state.patientAssignments[index] = {};
            }
            state.patientAssignments[index][field] = value;
        }

        // Toggle patient selection
        function togglePatientSelection(index, isChecked) {
            const card = document.getElementById(`patient-card-${index}`);
            const techSelect = document.getElementById(`tech_${index}`);
            const chairSelect = document.getElementById(`chair_${index}`);
            // Pod stays disabled (auto-filled from tech)
            
            if (isChecked) {
                state.selectedPatients.add(index);
                if (card) card.classList.add('selected');
                if (techSelect) techSelect.disabled = false;
                if (chairSelect) chairSelect.disabled = false;
            } else {
                state.selectedPatients.delete(index);
                if (card) card.classList.remove('selected');
                if (techSelect) techSelect.disabled = true;
                if (chairSelect) chairSelect.disabled = true;
            }
            updateImportButton();
        }

        // Toggle select all
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.patient-item input[type="checkbox"]');
            const allChecked = state.selectedPatients.size === checkboxes.length;
            
            checkboxes.forEach((cb, index) => {
                cb.checked = !allChecked;
                if (!allChecked) {
                    state.selectedPatients.add(index);
                } else {
                    state.selectedPatients.delete(index);
                }
            });
            
            updateImportButton();
        }

        // Update import button state
        function updateImportButton() {
            const btn = document.getElementById('importBtn');
            btn.disabled = state.selectedPatients.size === 0;
        }

        // Import selected patients
        function importSelectedPatients() {
            if (!state.excelData || state.selectedPatients.size === 0) return;
            
            state.patients = [];
            state.nextId = 1;
            
            const selectedIndices = Array.from(state.selectedPatients).sort((a, b) => a - b);
            
            selectedIndices.forEach(index => {
                const excelPatient = state.excelData[index];
                const initials = nameToInitials(excelPatient['Patient Name']);
                
                const patient = {
                    id: state.nextId++,
                    number: state.patients.length + 1,
                    name: initials,
                    
                    // Assignment data (v1.6.4)
                    section: state.currentSection,
                    technician: state.patientAssignments[index]?.technician || '',
                    pod: state.patientAssignments[index]?.pod || '',
                    chair: state.patientAssignments[index]?.chair || '',
                    
                    shift: state.activeShift || '1st',
                    
                    // Treatment parameters from Excel
                    rxTime: excelPatient['Duration (HH:MM)'] || '03:00',
                    dialyzer: excelPatient['Dialyzer'] || 'Revaclear 400',
                    bi: excelPatient['Bicarbonate'] || '',
                    profile: excelPatient['Sodium Profiling'] || '',
                    na: excelPatient['Sodium'] || '',
                    k: excelPatient['Potassium'] || '',
                    ca: excelPatient['Calcium'] || '',
                    dfr: excelPatient['Dialysate Flow Rate'] || '',
                    bfr: excelPatient['Blood Flow Rate'] || '',
                    arterialNeedleGauge: excelPatient['Arterial Needle Gauge'] || '',
                    venousNeedleGauge: excelPatient['Venous Needle Gauge'] || '',
                    temp: excelPatient['Dialysate Temperature'] || '',
                    
                    // Weight/UF
                    dryWeight: String(excelPatient['Dry Weight'] || ''),
                    preWeight: '',
                    goalUF: '',
                    postWeight: '',

                    // Wheelchair Weight Calculation (TCH patients)
                    wheelchairPreMeasured: '',
                    wheelchairPostMeasured: '',
                    wheelchairItems: loadWheelchairProfile(initials),
                    
                    // Time tracking
                    startTime: '',
                    endTime: '',
                    
                    // QA Checklist
                    preCheck: false,
                    preCheckSubs: {
                        machineCheck: false,
                        preDialysis: false,
                        orderVerify: false
                    },
                    thirtyMinCheck: false,
                    medsComplete: false,
                    medsSubs: {
                        medsGiven: false,
                        medsSheetSigned: false
                    },
                    abxIDPN: false,
                    statLabs: false,
                    emailSent: false,
                    ettSigned: false,
                    missedTx: false,
                    missedTxSubs: {
                        rescheduled: false,
                        calledOff: false,
                        noCallNoShow: false
                    },
                    hospitalization: false,
                    hospitalizationHospital: '',
                    hospitalizationSubs: {
                        hhPrep: false,
                        hospEntered: false,
                        whiteboard: false,
                        eosrReport: false
                    },
                    misc: false,
                    miscSubs: {
                        thirtyMinCheck: false,
                        abxIDPN: false,
                        statLabs: false,
                        labsPrep: false
                    },
                    labsPrep: false,
                    endedEarly: '',
                    reschedule: '',
                    
                    // UF Documentation Snippets
                    selectedSnippets: [],
                    extraTxDay: '',
                    extraTxSide: '',
                    extraTxTime: '',
                    
                    // Pre Dialysis Documentation Snippets
                    selectedPreSnippets: [],
                    preDialysisComplete: false,
                    
                    // Post Dialysis Documentation Snippets (formerly UF snippets)
                    postDialysisComplete: false,
                    
                    // Time Documentation Snippets
                    selectedTimeSnippets: [],
                    
                    // Quick Notes
                    quickNotes: '',
                    
                    // Tech Check - items checked = missing from chart
                    techCheck: {
                        initiationTime: false,
                        orderVerification: false,
                        txInitiated: false,
                        txEnded: false,
                        blankVitalsNotes: false,
                        heparinBolus: false,
                        lidocaine: false,
                        postWeight: false
                    }
                };
                
                state.patients.push(patient);
            });
            
            if (state.patients.length > 0) {
                state.activePatientId = state.patients[0].id;
            }
            
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            
            renderAll();
        }

        // Skip import
        function skipImport() {
            document.getElementById('importModal').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            addPatient();
            renderAll();
        }

        // Show import modal
        function showImportModal() {
            renderSectionSelector(); // Render section selector
            document.getElementById('importModal').classList.remove('hidden');
        }

        // Add new patient
        function addPatient() {
            const patientNumber = state.patients.filter(p => p.shift === state.activeShift).length + 1;
            const patient = {
                id: state.nextId++,
                number: patientNumber,
                name: `Patient ${patientNumber}`,
                section: state.currentSection,
                technician: '',
                pod: '',
                chair: '',
                shift: state.activeShift || '1st',
                rxTime: '03:00',
                dialyzer: 'Revaclear 400',
                bi: '', profile: '', na: '', k: '', ca: '',
                dfr: '', bfr: '', arterialNeedleGauge: '', venousNeedleGauge: '', temp: '',
                dryWeight: '', preWeight: '', goalUF: '', postWeight: '',
                // Wheelchair Weight Calculation (TCH patients)
                wheelchairPreMeasured: '',
                wheelchairPostMeasured: '',
                wheelchairItems: [],
                startTime: '', endTime: '',
                preCheck: false, thirtyMinCheck: false, medsComplete: false,
                preCheckSubs: { machineCheck: false, preDialysis: false, orderVerify: false },
                medsSubs: { medsGiven: false, medsSheetSigned: false },
                abxIDPN: false, statLabs: false, emailSent: false,
                ettSigned: false, missedTx: false,
                missedTxSubs: { rescheduled: false, calledOff: false, noCallNoShow: false },
                hospitalization: false, hospitalizationHospital: '',
                hospitalizationSubs: { hhPrep: false, hospEntered: false, whiteboard: false, eosrReport: false },
                labsPrep: false, endedEarly: '', reschedule: '',
                selectedSnippets: [], extraTxDay: '', extraTxSide: '', extraTxTime: '',
                selectedPreSnippets: [], preDialysisComplete: false,
                postDialysisComplete: false,
                selectedTimeSnippets: [],
                quickNotes: '',
                techCheck: {
                    initiationTime: false,
                    orderVerification: false,
                    txInitiated: false,
                    txEnded: false,
                    blankVitalsNotes: false,
                    heparinBolus: false,
                    lidocaine: false,
                    postWeight: false
                },
                chartClosed: false,
                miscTodos: [],  // Array of {id, text, completed, timestamp}
                labs: []  // Array of {id, name, timestamp, mainComplete, distributed, drawn, orderInNextGen, resultText, resultsSentEmail, resultsEnteredRenvio, actionTaken, sectionComplete}
            };

            state.patients.push(patient);
            if (!state.activePatientId) {
                state.activePatientId = patient.id;
            }

            // Initialize Assignment and Treatment Orders sections as collapsed by default
            state.collapsedSections[`${patient.id}_assignment`] = true;
            state.collapsedSections[`${patient.id}_orders`] = true;
        }

        // Remove patient
        function removePatient(id) {
            if (state.patients.length === 1) {
                alert('Cannot remove the last patient');
                return;
            }
            
            const index = state.patients.findIndex(p => p.id === id);
            if (index === -1) return;
            
            state.patients.splice(index, 1);
            state.patients.forEach((p, idx) => p.number = idx + 1);
            
            if (state.activePatientId === id) {
                state.activePatientId = state.patients[0]?.id || null;
            }
            
            renderAll();
        }

        // Switch active patient
        function switchPatient(id) {
            state.activePatientId = id;
            renderAll();
        }

        // Update patient field
        function updatePatient(id, field, value) {
            const patient = state.patients.find(p => p.id === id);
            if (patient) {
                patient[field] = value;
                renderAll();
            }
        }
        
        // Update patient assignment fields (section, tech, pod, chair)
        function updatePatientAssignment(id, field, value) {
            const patient = state.patients.find(p => p.id === id);
            if (patient) {
                patient[field] = value;
                renderAll();
            }
        }

        // Toggle QA main item (expands/collapses sub-items)
        function toggleQAMainItem(patientId, field, checked) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient) {
                patient[field] = checked;
                renderAll();
            }
        }

        // Toggle QA sub-item and update checkmarks
        function toggleQASubItem(patientId, subsField, subItem, checked) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient) {
                // Initialize the subs object if it doesn't exist
                if (!patient[subsField]) {
                    patient[subsField] = {};
                }
                patient[subsField][subItem] = checked;

                // Check if all sub-items are checked for checkmark display
                if (subsField === 'preCheckSubs') {
                    const allChecked = patient.preCheckSubs?.machineCheck &&
                                       patient.preCheckSubs?.preDialysis &&
                                       patient.preCheckSubs?.orderVerify;
                    // Update Pre pill to yellow if machine check is done
                    // The checkmark shows when all are done
                }
                if (subsField === 'medsSubs') {
                    const allChecked = patient.medsSubs?.medsGiven &&
                                       patient.medsSubs?.medsSheetSigned;
                    // The checkmark shows when all are done
                }

                renderAll();
            }
        }

        // Misc To-Do List Functions
        function addMiscTodo(patientId, text) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && text.trim()) {
                if (!patient.miscTodos) patient.miscTodos = [];
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    timeZone: 'America/Phoenix',
                    month: 'short', day: 'numeric',
                    hour: 'numeric', minute: '2-digit'
                });
                patient.miscTodos.push({
                    id: Date.now(),
                    text: text.trim(),
                    completed: false,
                    timestamp: timestamp
                });
                renderAll();
            }
        }

        function addMiscTodoFromInput(patientId) {
            const input = document.getElementById(`miscTodoInput_${patientId}`);
            if (input && input.value.trim()) {
                addMiscTodo(patientId, input.value);
                input.value = '';
            }
        }

        function toggleMiscTodo(patientId, todoId, completed) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.miscTodos) {
                const todo = patient.miscTodos.find(t => t.id === todoId);
                if (todo) {
                    todo.completed = completed;
                    renderAll();
                }
            }
        }

        function deleteMiscTodo(patientId, todoId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.miscTodos) {
                patient.miscTodos = patient.miscTodos.filter(t => t.id !== todoId);
                renderAll();
            }
        }

        function hasIncompleteTodos(patient) {
            if (!patient.miscTodos || patient.miscTodos.length === 0) return false;
            return patient.miscTodos.some(t => !t.completed);
        }

        // Labs Section Functions
        function addLab(patientId, labName) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && labName.trim()) {
                if (!patient.labs) patient.labs = [];
                const now = new Date();
                const timestamp = now.toLocaleString('en-US', {
                    timeZone: 'America/Phoenix',
                    month: 'short', day: 'numeric',
                    hour: 'numeric', minute: '2-digit'
                });
                patient.labs.push({
                    id: Date.now(),
                    name: labName.trim(),
                    timestamp: timestamp,
                    mainComplete: false,
                    distributed: false,
                    drawn: false,
                    orderInNextGen: false,
                    resultText: '',
                    resultsSentEmail: false,
                    resultsEnteredRenvio: false,
                    actionTaken: false,
                    sectionComplete: false
                });
                renderAll();
            }
        }

        function addLabFromInput(patientId) {
            const input = document.getElementById(`labInput_${patientId}`);
            if (input && input.value.trim()) {
                addLab(patientId, input.value);
                input.value = '';
            }
        }

        function toggleLabCheckbox(patientId, labId, field, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.labs) {
                const lab = patient.labs.find(l => l.id === labId);
                if (lab) {
                    lab[field] = value;
                    renderAll();
                }
            }
        }

        function updateLabResultText(patientId, labId, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.labs) {
                const lab = patient.labs.find(l => l.id === labId);
                if (lab) {
                    lab.resultText = value;
                    // Don't renderAll() on every keystroke, just update state
                }
            }
        }

        function deleteLab(patientId, labId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.labs) {
                patient.labs = patient.labs.filter(l => l.id !== labId);
                renderAll();
            }
        }

        function isLabComplete(lab) {
            return lab.mainComplete &&
                   lab.distributed &&
                   lab.drawn &&
                   lab.orderInNextGen &&
                   lab.resultsSentEmail &&
                   lab.resultsEnteredRenvio &&
                   lab.actionTaken;
        }

        function hasIncompleteLabs(patient) {
            if (!patient.labs || patient.labs.length === 0) return false;
            return patient.labs.some(l => !isLabComplete(l) || !l.sectionComplete);
        }

        function toggleLabSectionComplete(patientId, labId, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (patient && patient.labs) {
                const lab = patient.labs.find(l => l.id === labId);
                if (lab && isLabComplete(lab)) {
                    lab.sectionComplete = value;
                    // Sync to Operations Labs when marked complete
                    if (value) {
                        syncLabToOperations(patient, lab);
                    }
                    renderAll();
                }
            }
        }

        // Toggle expand/collapse for completed labs in patient chart
        function toggleCompletedLabExpand(patientId, labId, event) {
            // Don't toggle if clicking on checkbox or delete button
            if (event.target.type === 'checkbox' || event.target.classList.contains('labs-item-delete')) {
                return;
            }
            const element = document.getElementById(`completedLab_${patientId}_${labId}`);
            if (element) {
                element.classList.toggle('expanded');
            }
        }

        // Sync a completed lab from patient chart to Operations Labs section
        function syncLabToOperations(patient, lab) {
            // Load current labs data
            const saved = localStorage.getItem('hd_labs_data');
            let labsData = { entries: [] };
            if (saved) {
                labsData = JSON.parse(saved);
            }

            // Check if this lab already exists (by patient + lab name + timestamp combo)
            const existingIndex = labsData.entries.findIndex(e =>
                e.sourcePatientId === patient.id &&
                e.sourceLabId === lab.id
            );

            // Format patient identifier
            const patientName = patient.initials || patient.name || `Pt #${patient.number}`;

            // Create entry with lab details
            const entry = {
                id: Date.now(),
                patientName: patientName,
                labResult: lab.name + (lab.resultText ? ` - ${lab.resultText}` : ''),
                dateTime: lab.timestamp || getPhoenixTime(),
                timestamp: new Date().toISOString(),
                sourcePatientId: patient.id,
                sourceLabId: lab.id,
                // Store full lab details for reference
                labDetails: {
                    name: lab.name,
                    resultText: lab.resultText || '',
                    distributed: lab.distributed,
                    drawn: lab.drawn,
                    orderInNextGen: lab.orderInNextGen,
                    resultsSentEmail: lab.resultsSentEmail,
                    resultsEnteredRenvio: lab.resultsEnteredRenvio,
                    actionTaken: lab.actionTaken
                }
            };

            if (existingIndex >= 0) {
                // Update existing entry
                labsData.entries[existingIndex] = entry;
            } else {
                // Add new entry at the beginning
                labsData.entries.unshift(entry);
            }

            // Save back to localStorage
            localStorage.setItem('hd_labs_data', JSON.stringify(labsData));

            // Update labsState if it's been initialized
            if (typeof labsState !== 'undefined') {
                labsState.entries = labsData.entries;
            }
        }

        // Check if patient has any missed tx sub-items checked
        function hasMissedTxChecked(patient) {
            if (!patient.missedTx) return false;
            return patient.missedTxSubs?.rescheduled ||
                   patient.missedTxSubs?.calledOff ||
                   patient.missedTxSubs?.noCallNoShow;
        }


        // Handle tech selection in patient card - auto-fill pod
        function onTechSelectedInCard(patientId, techName) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient.technician = techName;
            
            if (!techName) {
                patient.pod = '';
            } else {
                const tech = state.technicians.find(t => t.name === techName);
                if (tech) {
                    patient.pod = tech.pod;
                }
            }
            
            renderAll();
        }
        
        // Get chairs for a given section
        function getChairsForSection(sectionKey) {
            if (!sectionKey || !state.sections[sectionKey]) {
                return [];
            }
            return state.sections[sectionKey].chairs || [];
        }

        // Calculations
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            
            // Handle both HHMM (e.g., "0800") and HH:MM (e.g., "08:00") formats
            let cleaned = String(timeStr).replace(':', '');
            
            // Pad to 4 digits if needed (e.g., "800" -> "0800")
            cleaned = cleaned.padStart(4, '0');
            
            if (cleaned.length !== 4) return 0;
            
            const hours = parseInt(cleaned.substring(0, 2));
            const minutes = parseInt(cleaned.substring(2, 4));
            
            if (isNaN(hours) || isNaN(minutes)) return 0;
            
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const h = Math.floor(Math.abs(minutes) / 60);
            const m = Math.abs(minutes) % 60;
            const sign = minutes < 0 ? '-' : '';
            return `${sign}${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        function parseTimeToMinutes(durationStr) {
            // Parse duration strings like "03:00" (3 hours) or "03:30" (3.5 hours) into minutes
            if (!durationStr) return 0;
            
            const parts = String(durationStr).split(':');
            if (parts.length !== 2) return 0;
            
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            
            return hours * 60 + minutes;
        }

        function calcGoalUF(pre, dry) {
            // Convert to numbers and check validity
            const preNum = parseFloat(pre);
            const dryNum = parseFloat(dry);
            
            if (isNaN(preNum) || isNaN(dryNum) || !pre || !dry) {
                return '';
            }
            
            return (preNum - dryNum).toFixed(1);
        }

        function calcActualUF(pre, post) {
            const preNum = parseFloat(pre);
            const postNum = parseFloat(post);
            
            if (isNaN(preNum) || isNaN(postNum) || !pre || !post) {
                return '';
            }
            
            return (preNum - postNum).toFixed(1);
        }

        function calcDiff(goalUF, actualUF) {
            const goalNum = parseFloat(goalUF);
            const actualNum = parseFloat(actualUF);
            
            if (isNaN(goalNum) || isNaN(actualNum) || !goalUF || !actualUF) {
                return '';
            }
            
            return (goalNum - actualNum).toFixed(1);
        }
        
        // UF Documentation calculations
        function calcTargetWeight(preWeight, goalUF) {
            const preNum = parseFloat(preWeight);
            const goalNum = parseFloat(goalUF);
            if (isNaN(preNum) || isNaN(goalNum) || !preWeight || !goalUF) return '';
            return (preNum - goalNum + 0.4).toFixed(1);
        }

        function copyTargetWeight(inputEl) {
            const value = inputEl.value;
            if (!value) {
                alert('No target weight to copy');
                return;
            }
            navigator.clipboard.writeText(value).then(() => {
                const originalBg = inputEl.style.background;
                inputEl.style.background = 'linear-gradient(135deg, #86efac 0%, #4ade80 100%)';
                inputEl.value = '✓ Copied!';
                setTimeout(() => {
                    inputEl.value = value;
                    inputEl.style.background = '';
                }, 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please copy manually.');
            });
        }

        function calcTotalRemoved(pre, post) {
            const preNum = parseFloat(pre);
            const postNum = parseFloat(post);
            if (isNaN(preNum) || isNaN(postNum) || !pre || !post) return '';
            return (preNum - postNum).toFixed(1);
        }
        
        function calcPostVsDW(post, dry) {
            const postNum = parseFloat(post);
            const dryNum = parseFloat(dry);
            if (isNaN(postNum) || isNaN(dryNum) || !post || !dry) return '';
            return (postNum - dryNum).toFixed(1);
        }
        
        function calcPreOverDW(pre, dry) {
            const preNum = parseFloat(pre);
            const dryNum = parseFloat(dry);
            if (isNaN(preNum) || isNaN(dryNum) || !pre || !dry) return '';
            return (preNum - dryNum).toFixed(1);
        }
        
        function calcEstimatedEndTime(startTime, rxTime) {
            if (!startTime || !rxTime) return '';
            
            // Parse start time (HHMM format, e.g., "0800" or "1330")
            let startStr = String(startTime).replace(':', '').padStart(4, '0');
            if (startStr.length !== 4) return '';
            
            const startHours = parseInt(startStr.substring(0, 2));
            const startMins = parseInt(startStr.substring(2, 4));
            
            // Parse rx time (e.g., "3:15" or "03:15")
            const rxParts = String(rxTime).split(':');
            if (rxParts.length !== 2) return '';
            
            const rxHours = parseInt(rxParts[0]);
            const rxMins = parseInt(rxParts[1]);
            
            if (isNaN(startHours) || isNaN(startMins) || isNaN(rxHours) || isNaN(rxMins)) return '';
            
            // Calculate end time
            let endHours = startHours + rxHours;
            let endMins = startMins + rxMins;
            
            // Handle minute overflow
            if (endMins >= 60) {
                endHours += Math.floor(endMins / 60);
                endMins = endMins % 60;
            }
            
            // Handle hour overflow (past midnight)
            if (endHours >= 24) {
                endHours = endHours % 24;
            }
            
            // Format as HHMM
            return String(endHours).padStart(2, '0') + String(endMins).padStart(2, '0');
        }

        function calcActualDuration(start, end) {
            if (!start || !end) return '';
            
            let startMin = timeToMinutes(start);
            let endMin = timeToMinutes(end);
            
            if (endMin < startMin) {
                endMin += 24 * 60;
            }
            
            return minutesToTime(endMin - startMin);
        }

        function calcTimeShortfall(prescribed, start, end) {
            if (!prescribed || !start || !end) {
                return { shortfall: '', cssClass: '', isShort: false, percentage: '' };
            }
            
            const prescribedMin = timeToMinutes(prescribed);
            const actualDuration = calcActualDuration(start, end);
            const actualMin = timeToMinutes(actualDuration);
            const diff = actualMin - prescribedMin;
            
            // Calculate percentage of scheduled time received
            const percentage = prescribedMin > 0 ? ((actualMin / prescribedMin) * 100).toFixed(1) : '';
            
            let cssClass = 'success';
            let isShort = false;
            
            if (diff < -15) {
                cssClass = 'danger';
                isShort = true;
            } else if (diff < 0) {
                cssClass = 'warning';
            }
            
            return { shortfall: minutesToTime(diff), cssClass, isShort, percentage };
        }

        function checkWeightAlert(post, dry) {
            if (!post || !dry) return false;
            return Math.abs(parseFloat(post) - parseFloat(dry)) > 1.5;
        }

        // ============================================
        // Wheelchair Weight Calculation Functions
        // ============================================

        // Load wheelchair equipment profile from localStorage by patient initials
        function loadWheelchairProfile(patientName) {
            if (!patientName) return [];
            const profiles = JSON.parse(localStorage.getItem('wheelchair_profiles') || '{}');
            const items = profiles[patientName] || [];
            // Ensure all items have activeForPre and activeForPost flags
            return items.map(item => ({
                ...item,
                activeForPre: item.activeForPre !== false,
                activeForPost: item.activeForPost !== false
            }));
        }

        // Save wheelchair equipment profile to localStorage by patient initials
        function saveWheelchairProfile(patientName, items) {
            if (!patientName) return;
            const profiles = JSON.parse(localStorage.getItem('wheelchair_profiles') || '{}');
            profiles[patientName] = items;
            localStorage.setItem('wheelchair_profiles', JSON.stringify(profiles));
        }

        // Calculate the sum of equipment weights for a specific column (pre or post)
        function calcEquipmentTotal(items, column = 'pre') {
            if (!items || items.length === 0) return 0;
            const activeKey = column === 'pre' ? 'activeForPre' : 'activeForPost';
            return items
                .filter(item => item[activeKey] !== false)
                .reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
        }

        // Calculate actual patient weight (total measured - equipment) for a column
        function calcWheelchairActualWeight(totalMeasured, items, column = 'pre') {
            const total = parseFloat(totalMeasured);
            if (isNaN(total) || !totalMeasured) return '';
            const equipmentTotal = calcEquipmentTotal(items, column);
            return (total - equipmentTotal).toFixed(1);
        }

        // Add a new wheelchair equipment item (active for both pre and post by default)
        function addWheelchairItem(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            if (!patient.wheelchairItems) {
                patient.wheelchairItems = [];
            }

            patient.wheelchairItems.push({
                name: '',
                weight: '',
                activeForPre: true,
                activeForPost: true
            });
            saveWheelchairProfile(patient.name, patient.wheelchairItems);
            renderAll();
        }

        // Remove a wheelchair equipment item
        function removeWheelchairItem(patientId, index) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient || !patient.wheelchairItems) return;

            patient.wheelchairItems.splice(index, 1);
            saveWheelchairProfile(patient.name, patient.wheelchairItems);
            renderAll();
        }

        // Update a wheelchair equipment item (name or weight)
        function updateWheelchairItem(patientId, index, field, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient || !patient.wheelchairItems || !patient.wheelchairItems[index]) return;

            patient.wheelchairItems[index][field] = value;
            saveWheelchairProfile(patient.name, patient.wheelchairItems);

            // Update the calculated fields without full re-render
            updateWheelchairCalculations(patientId);
        }

        // Toggle an item's active state for a specific column (pre or post)
        function toggleWheelchairItemActive(patientId, index, column) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient || !patient.wheelchairItems || !patient.wheelchairItems[index]) return;

            const activeKey = column === 'pre' ? 'activeForPre' : 'activeForPost';
            patient.wheelchairItems[index][activeKey] = !patient.wheelchairItems[index][activeKey];
            saveWheelchairProfile(patient.name, patient.wheelchairItems);

            // Update calculations for the specific column
            updateWheelchairCalculations(patientId);
        }

        // Update wheelchair measured weight for a specific column
        function updateWheelchairMeasured(patientId, column, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            if (column === 'pre') {
                patient.wheelchairPreMeasured = value;
            } else {
                patient.wheelchairPostMeasured = value;
            }
            updateWheelchairCalculations(patientId);
        }

        // Update the calculated display fields for both wheelchair columns
        function updateWheelchairCalculations(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            // Pre column calculations
            const preEquipmentTotal = calcEquipmentTotal(patient.wheelchairItems, 'pre');
            const preActualWeight = calcWheelchairActualWeight(patient.wheelchairPreMeasured, patient.wheelchairItems, 'pre');

            // Post column calculations
            const postEquipmentTotal = calcEquipmentTotal(patient.wheelchairItems, 'post');
            const postActualWeight = calcWheelchairActualWeight(patient.wheelchairPostMeasured, patient.wheelchairItems, 'post');

            // Update Pre column DOM elements
            const preEquipTotalEl = document.getElementById(`wheelchairPreEquipTotal_${patientId}`);
            const preActualEl = document.getElementById(`wheelchairPreActual_${patientId}`);
            const usePreBtn = document.getElementById(`useAsPreBtn_${patientId}`);

            if (preEquipTotalEl) preEquipTotalEl.value = preEquipmentTotal.toFixed(1);
            if (preActualEl) preActualEl.value = preActualWeight;
            if (usePreBtn) usePreBtn.disabled = !preActualWeight;

            // Update Post column DOM elements
            const postEquipTotalEl = document.getElementById(`wheelchairPostEquipTotal_${patientId}`);
            const postActualEl = document.getElementById(`wheelchairPostActual_${patientId}`);
            const usePostBtn = document.getElementById(`useAsPostBtn_${patientId}`);

            if (postEquipTotalEl) postEquipTotalEl.value = postEquipmentTotal.toFixed(1);
            if (postActualEl) postActualEl.value = postActualWeight;
            if (usePostBtn) usePostBtn.disabled = !postActualWeight;

            // Update checkbox styling
            const items = patient.wheelchairItems || [];
            items.forEach((item, index) => {
                const preCheck = document.getElementById(`wheelchairPreCheck_${patientId}_${index}`);
                const postCheck = document.getElementById(`wheelchairPostCheck_${patientId}_${index}`);
                const preLabel = preCheck?.closest('.wheelchair-equipment-check');
                const postLabel = postCheck?.closest('.wheelchair-equipment-check');

                if (preLabel) {
                    preLabel.classList.toggle('unchecked', !item.activeForPre);
                }
                if (postLabel) {
                    postLabel.classList.toggle('unchecked', !item.activeForPost);
                }
            });
        }

        // Use wheelchair actual weight as Pre Weight
        function useWheelchairAsPreWeight(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            const actualWeight = calcWheelchairActualWeight(patient.wheelchairPreMeasured, patient.wheelchairItems, 'pre');
            if (!actualWeight) return;

            patient.preWeight = actualWeight;

            // Visual feedback
            const btn = document.getElementById(`useAsPreBtn_${patientId}`);
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '✓ Updated!';
                btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            }

            renderAll();
        }

        // Use wheelchair actual weight as Post Weight
        function useWheelchairAsPostWeight(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            const actualWeight = calcWheelchairActualWeight(patient.wheelchairPostMeasured, patient.wheelchairItems, 'post');
            if (!actualWeight) return;

            patient.postWeight = actualWeight;

            // Visual feedback
            const btn = document.getElementById(`useAsPostBtn_${patientId}`);
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '✓ Updated!';
                btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            }

            renderAll();
        }

        // Copy wheelchair actual weight to clipboard
        function copyWheelchairWeight(patientId, column) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;

            const measured = column === 'pre' ? patient.wheelchairPreMeasured : patient.wheelchairPostMeasured;
            const actualWeight = calcWheelchairActualWeight(measured, patient.wheelchairItems, column);

            if (!actualWeight) {
                alert('No weight to copy');
                return;
            }

            navigator.clipboard.writeText(actualWeight).then(() => {
                const btn = document.getElementById(`copyBtn_${column}_${patientId}`);
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '✓';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 1000);
                }
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please copy manually.');
            });
        }

        // Toggle wheelchair section collapse state
        function toggleWheelchairSection(patientId) {
            const header = document.querySelector(`#wheelchairSection_${patientId} .wheelchair-header`);
            const content = document.querySelector(`#wheelchairSection_${patientId} .wheelchair-content`);

            if (header && content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        }

        // Generate equipment checkboxes for a column
        function renderEquipmentChecks(patient, column) {
            const items = patient.wheelchairItems || [];
            if (items.length === 0) {
                return '<p style="color: #92400e; font-size: 0.8em; font-style: italic; margin: 5px 0;">No equipment items</p>';
            }

            const activeKey = column === 'pre' ? 'activeForPre' : 'activeForPost';

            return items.map((item, index) => {
                const isActive = item[activeKey] !== false;
                const displayName = item.name || `Item ${index + 1}`;
                const displayWeight = item.weight ? `${item.weight} kg` : '—';

                return `
                    <label class="wheelchair-equipment-check ${isActive ? '' : 'unchecked'}">
                        <input type="checkbox"
                            id="wheelchair${column === 'pre' ? 'Pre' : 'Post'}Check_${patient.id}_${index}"
                            ${isActive ? 'checked' : ''}
                            onchange="toggleWheelchairItemActive(${patient.id}, ${index}, '${column}')">
                        <span>${displayName}</span>
                        <span class="item-weight">${displayWeight}</span>
                    </label>
                `;
            }).join('');
        }

        // Generate wheelchair section HTML for a patient
        function renderWheelchairSection(patient) {
            if (patient.section !== 'TCH') return '';

            const items = patient.wheelchairItems || [];

            // Pre column calculations
            const preEquipmentTotal = calcEquipmentTotal(items, 'pre');
            const preActualWeight = calcWheelchairActualWeight(patient.wheelchairPreMeasured, items, 'pre');

            // Post column calculations
            const postEquipmentTotal = calcEquipmentTotal(items, 'post');
            const postActualWeight = calcWheelchairActualWeight(patient.wheelchairPostMeasured, items, 'post');

            // Equipment items editor (shared section at top)
            const itemsHtml = items.map((item, index) => `
                <div class="wheelchair-item">
                    <input type="text" placeholder="Item name (e.g., Wheelchair)"
                        value="${item.name || ''}"
                        onchange="updateWheelchairItem(${patient.id}, ${index}, 'name', this.value)">
                    <input type="number" step="0.1" placeholder="kg"
                        value="${item.weight || ''}"
                        onchange="updateWheelchairItem(${patient.id}, ${index}, 'weight', this.value)">
                    <button class="remove-btn" onclick="removeWheelchairItem(${patient.id}, ${index})" title="Remove item">✕</button>
                </div>
            `).join('');

            return `
                <div class="wheelchair-section" id="wheelchairSection_${patient.id}">
                    <div class="wheelchair-header" onclick="toggleWheelchairSection(${patient.id})">
                        <h4>🦽 Wheelchair Weight Calculation</h4>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="wheelchair-content">
                        <!-- Shared Equipment Items Section -->
                        <div class="wheelchair-items-section">
                            <div class="wheelchair-items-header">
                                <h5>Equipment Items (shared for Pre & Post)</h5>
                                <button class="add-item-btn" onclick="addWheelchairItem(${patient.id})">
                                    + Add Item
                                </button>
                            </div>
                            ${items.length === 0 ?
                                '<p style="color: #92400e; font-size: 0.85em; font-style: italic;">No items added. Click "+ Add Item" to add wheelchair, sling, cushion, etc.</p>'
                                : itemsHtml}
                        </div>

                        <!-- Pre/Post Calculation Columns -->
                        <div class="wheelchair-columns">
                            <!-- Pre Weight Column -->
                            <div class="wheelchair-column pre-column">
                                <h5>⬇️ PRE Weight (Arrival)</h5>

                                <div class="wheelchair-measured-row">
                                    <label>Measured:</label>
                                    <input type="number" step="0.1" placeholder="kg"
                                        value="${patient.wheelchairPreMeasured || ''}"
                                        onchange="updateWheelchairMeasured(${patient.id}, 'pre', this.value)">
                                    <span style="color: #92400e; font-size: 0.85em;">kg</span>
                                </div>

                                <div class="wheelchair-equipment-checks">
                                    ${renderEquipmentChecks(patient, 'pre')}
                                </div>

                                <div class="wheelchair-result-row">
                                    <label>Equipment:</label>
                                    <input type="text" class="calculated"
                                        id="wheelchairPreEquipTotal_${patient.id}"
                                        value="${preEquipmentTotal.toFixed(1)}" readonly>
                                </div>
                                <div class="wheelchair-result-row actual-row">
                                    <label>Actual Weight:</label>
                                    <input type="text"
                                        id="wheelchairPreActual_${patient.id}"
                                        value="${preActualWeight}" readonly>
                                </div>

                                <div class="wheelchair-column-actions">
                                    <button class="use-weight-btn pre-btn"
                                        id="useAsPreBtn_${patient.id}"
                                        onclick="useWheelchairAsPreWeight(${patient.id})"
                                        ${!preActualWeight ? 'disabled' : ''}>
                                        → Pre Weight
                                    </button>
                                    <button class="copy-weight-btn"
                                        id="copyBtn_pre_${patient.id}"
                                        onclick="copyWheelchairWeight(${patient.id}, 'pre')">
                                        📋
                                    </button>
                                </div>
                            </div>

                            <!-- Post Weight Column -->
                            <div class="wheelchair-column post-column">
                                <h5>⬆️ POST Weight (End)</h5>

                                <div class="wheelchair-measured-row">
                                    <label>Measured:</label>
                                    <input type="number" step="0.1" placeholder="kg"
                                        value="${patient.wheelchairPostMeasured || ''}"
                                        onchange="updateWheelchairMeasured(${patient.id}, 'post', this.value)">
                                    <span style="color: #92400e; font-size: 0.85em;">kg</span>
                                </div>

                                <div class="wheelchair-equipment-checks">
                                    ${renderEquipmentChecks(patient, 'post')}
                                </div>

                                <div class="wheelchair-result-row">
                                    <label>Equipment:</label>
                                    <input type="text" class="calculated"
                                        id="wheelchairPostEquipTotal_${patient.id}"
                                        value="${postEquipmentTotal.toFixed(1)}" readonly>
                                </div>
                                <div class="wheelchair-result-row actual-row">
                                    <label>Actual Weight:</label>
                                    <input type="text"
                                        id="wheelchairPostActual_${patient.id}"
                                        value="${postActualWeight}" readonly>
                                </div>

                                <div class="wheelchair-column-actions">
                                    <button class="use-weight-btn post-btn"
                                        id="useAsPostBtn_${patient.id}"
                                        onclick="useWheelchairAsPostWeight(${patient.id})"
                                        ${!postActualWeight ? 'disabled' : ''}>
                                        → Post Weight
                                    </button>
                                    <button class="copy-weight-btn"
                                        id="copyBtn_post_${patient.id}"
                                        onclick="copyWheelchairWeight(${patient.id}, 'post')">
                                        📋
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getPercentageColor(percentage) {
            if (!percentage) return '';
            const pct = parseFloat(percentage);
            if (pct >= 90) return '#27ae60'; // Green
            if (pct >= 75) return '#f39c12'; // Yellow/Orange
            return '#e74c3c'; // Red
        }

        function calculateSummaryStats() {
            // Filter by current shift
            const shiftPatients = state.patients.filter(p => p.shift === state.activeShift);
            const total = shiftPatients.length;
            let timeAlerts = 0, weightAlerts = 0, complete = 0;

            shiftPatients.forEach(p => {
                const timeCheck = calcTimeShortfall(p.rxTime, p.startTime, p.endTime);
                if (timeCheck.isShort) timeAlerts++;
                if (checkWeightAlert(p.postWeight, p.dryWeight)) weightAlerts++;
                if (p.preWeight && p.postWeight && p.startTime && p.endTime) complete++;
            });

            return { total, timeAlerts, weightAlerts, complete };
        }

        function hasAlerts(patient) {
            const timeCheck = calcTimeShortfall(patient.rxTime, patient.startTime, patient.endTime);
            const weightAlert = checkWeightAlert(patient.postWeight, patient.dryWeight);
            
            // Check for incomplete pre-dialysis tasks
            const missingPreCheck = !patient.preCheck;
            const missing30Min = !patient.thirtyMinCheck;
            const missingMeds = !patient.medsComplete;
            const missingStartTime = !patient.startTime;
            
            return timeCheck.isShort || weightAlert || missingPreCheck || missing30Min || missingMeds || missingStartTime;
        }
        
        function getPatientStatus(patient) {
            // Returns detailed status for tab indicators
            const status = {
                preCheck: patient.preCheck,
                thirtyMinCheck: patient.thirtyMinCheck,
                medsComplete: patient.medsComplete,
                hasStartTime: !!patient.startTime,
                hasEndTime: !!patient.endTime,
                countdown: null,
                countdownClass: ''
            };
            
            // Calculate countdown if start time and rx time are set
            if (patient.startTime && patient.rxTime) {
                const now = new Date();
                const startMinutes = timeToMinutes(patient.startTime);
                const rxMinutes = parseTimeToMinutes(patient.rxTime);
                
                // Calculate estimated end time in minutes from midnight
                const estimatedEndMinutes = startMinutes + rxMinutes;
                
                // Convert to today's datetime
                const estimatedEndTime = new Date();
                estimatedEndTime.setHours(Math.floor(estimatedEndMinutes / 60));
                estimatedEndTime.setMinutes(estimatedEndMinutes % 60);
                estimatedEndTime.setSeconds(0);
                
                // Calculate time remaining
                const diffMs = estimatedEndTime - now;
                const diffMins = Math.floor(diffMs / 1000 / 60);
                
                if (diffMins > 0) {
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    status.countdown = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                    
                    // Color coding
                    if (diffMins <= 30) {
                        status.countdownClass = 'critical';
                    } else if (diffMins <= 60) {
                        status.countdownClass = 'warning';
                    }
                } else if (diffMins < 0) {
                    status.countdown = 'OVERDUE';
                    status.countdownClass = 'critical';
                }
            }
            
            return status;
        }

        // Render functions
        function renderSummary() {
            const stats = calculateSummaryStats();
            document.getElementById('totalPatients').textContent = stats.total;
            document.getElementById('timeAlerts').textContent = stats.timeAlerts;
            document.getElementById('weightAlerts').textContent = stats.weightAlerts;
            document.getElementById('completionRate').textContent = `${stats.complete}/${stats.total}`;
        }

        function renderTabs() {
            renderShiftTabs();
            renderPodTabs();
            renderPatientTabs();
        }
        
        // Get pods grouped by technician
        function getPodGroups() {
            const pods = {};
            
            // Filter patients by current shift first
            const shiftPatients = state.patients.filter(p => p.shift === state.activeShift);
            
            // Group patients by their assigned tech (for current shift)
            shiftPatients.forEach(p => {
                const techName = p.technician || 'Unassigned';
                if (!pods[techName]) {
                    const tech = state.technicians.find(t => t.name === techName);
                    pods[techName] = {
                        techName: techName,
                        podName: tech ? tech.pod : '',
                        patients: []
                    };
                }
                pods[techName].patients.push(p);
            });
            
            // Sort patients within each pod by chair number
            Object.values(pods).forEach(pod => {
                pod.patients.sort((a, b) => {
                    const chairA = parseInt(a.chair) || 999;
                    const chairB = parseInt(b.chair) || 999;
                    return chairA - chairB;
                });
            });
            
            return pods;
        }
        
        function renderPodTabs() {
            const podTabsContainer = document.getElementById('podTabs');
            const pods = getPodGroups();
            const podNames = Object.keys(pods);
            
            // If no patients, hide everything
            if (state.patients.length === 0) {
                podTabsContainer.innerHTML = '<div style="color: white; opacity: 0.7; padding: 10px;">No patients loaded. Import from Excel or add manually.</div>';
                document.getElementById('patientTabsContainer').style.display = 'none';
                return;
            }
            
            // Set default active pod if none selected or current pod no longer exists
            if (!state.activePod || !pods[state.activePod]) {
                state.activePod = podNames[0];
            }
            
            // Render pod tabs
            const podTabsHTML = podNames.map(techName => {
                const pod = pods[techName];
                const isActive = state.activePod === techName;
                const patientCount = pod.patients.length;
                const podLabel = pod.podName ? `📍 ${pod.podName}` : '📍';
                const alertCount = pod.patients.filter(p => hasAlerts(p)).length;
                const alertBadge = alertCount > 0 ? `<span style="color: #fca5a5;">⚠️${alertCount}</span>` : '';
                
                // Tech check alert badge and expandable details
                const techCheckData = getTechCheckCountForTech(techName);
                let techCheckBadge = '';
                let techCheckExpanded = '';
                
                if (techCheckData.count > 0) {
                    const isExpanded = state.expandedTechCheck === techName;
                    const expandedItems = techCheckData.details.map(d => 
                        `<div class="tech-check-expanded-item">${d.patient}: ${d.issues.join(', ')}</div>`
                    ).join('');
                    
                    techCheckBadge = `
                        <span class="tech-check-alert" onclick="toggleTechCheckExpand('${techName}', event)">
                            🔍${techCheckData.count}
                        </span>
                    `;
                    
                    techCheckExpanded = `
                        <div class="tech-check-expanded ${isExpanded ? 'visible' : ''}" id="techCheckExpanded_${techName.replace(/\s/g, '_')}">
                            <strong style="font-size: 0.9em;">Missing Chart Items:</strong>
                            ${expandedItems}
                        </div>
                    `;
                }
                
                return `<div class="pod-tab-wrapper">
                    <div class="pod-tab ${isActive ? 'active' : ''}" onclick="switchPod('${techName}')">
                        ${podLabel}
                        <span class="tech-name">${techName}</span>
                        <span class="patient-count">${patientCount} pts</span>
                        ${alertBadge}
                        ${techCheckBadge}
                    </div>
                    ${techCheckExpanded}
                </div>`;
            }).join('');
            
            podTabsContainer.innerHTML = podTabsHTML;
        }
        
        // Toggle tech check expanded view
        function toggleTechCheckExpand(techName, event) {
            event.stopPropagation(); // Don't trigger pod switch
            
            if (state.expandedTechCheck === techName) {
                state.expandedTechCheck = null;
            } else {
                state.expandedTechCheck = techName;
            }
            
            // Update visibility without full re-render
            document.querySelectorAll('.tech-check-expanded').forEach(el => {
                el.classList.remove('visible');
            });
            
            if (state.expandedTechCheck) {
                const expandedEl = document.getElementById(`techCheckExpanded_${state.expandedTechCheck.replace(/\s/g, '_')}`);
                if (expandedEl) {
                    expandedEl.classList.add('visible');
                }
            }
        }
        
        function renderPatientTabs() {
            const container = document.getElementById('patientTabsContainer');
            const tabsContainer = document.getElementById('patientTabs');
            const pods = getPodGroups();
            
            if (state.patients.length === 0 || !state.activePod) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const currentPod = pods[state.activePod];
            if (!currentPod) {
                tabsContainer.innerHTML = '';
                return;
            }
            
            const patients = currentPod.patients;

            // Ensure active patient is in current pod, or select first patient
            const activeInPod = patients.find(p => p.id === state.activePatientId);
            if (!activeInPod && patients.length > 0) {
                state.activePatientId = patients[0].id;
            }

            // Sort patients: active charts first, closed charts last
            const sortedPatients = [...patients].sort((a, b) => {
                if (a.chartClosed && !b.chartClosed) return 1;
                if (!a.chartClosed && b.chartClosed) return -1;
                return 0;
            });

            const tabsHTML = sortedPatients.map(p => {
                const isActive = p.id === state.activePatientId;
                const status = getEnhancedPatientStatus(p);

                // Pre badge: yellow if machine check done but not all, complete if all done
                const allPreDone = p.preCheckSubs?.machineCheck && p.preCheckSubs?.preDialysis && p.preCheckSubs?.orderVerify;
                const preBadgeClass = allPreDone ? 'complete' : (p.preCheckSubs?.machineCheck ? 'yellow' : 'pending');
                const preCheckmarkText = allPreDone ? 'Pre ✓' : 'Pre';

                // Meds badge: complete with checkmark if all sub-items done
                const allMedsDone = p.medsSubs?.medsGiven && p.medsSubs?.medsSheetSigned;
                const medsBadgeClass = allMedsDone ? 'complete' : (status.medsComplete ? 'complete' : 'pending');
                const medsCheckmarkText = allMedsDone ? 'Meds ✓' : 'Meds';

                // Status badges row - conditionally show hospital or missed tx instead of pills
                let statusRow = '';
                if (p.hospitalization) {
                    // If hospitalized, show hospital name instead of status pills
                    const hospitalName = p.hospitalizationHospital || 'Hospitalized';
                    statusRow = `
                        <div class="tab-row status-row hospitalized-status">
                            <span class="hospital-name-badge">🏥 ${hospitalName}</span>
                        </div>`;
                } else if (p.missedTx && (p.missedTxSubs?.rescheduled || p.missedTxSubs?.calledOff || p.missedTxSubs?.noCallNoShow)) {
                    // If missed tx, show the type of missed tx instead of status pills
                    let missedType = '';
                    if (p.missedTxSubs?.rescheduled) missedType = 'Rescheduled';
                    else if (p.missedTxSubs?.calledOff) missedType = 'Called Off';
                    else if (p.missedTxSubs?.noCallNoShow) missedType = 'No Call/No Show';
                    statusRow = `
                        <div class="tab-row status-row missed-tx-status">
                            <span class="missed-tx-badge">⚠️ ${missedType}</span>
                        </div>`;
                } else {
                    statusRow = `
                        <div class="tab-row status-row">
                            <span class="status-badge ${preBadgeClass}">${preCheckmarkText}</span>
                            <span class="status-badge ${medsBadgeClass}">${medsCheckmarkText}</span>
                            <span class="status-badge ${status.thirtyMinCheck ? 'complete' : 'pending'}">30m</span>
                            <span class="status-badge ${status.postComplete ? 'complete' : 'pending'}">Post</span>
                        </div>`;
                }
                
                // Time row
                let timeRow = '';
                if (status.timeRemaining || status.estEndTime) {
                    timeRow = `<div class="tab-row time-row">`;
                    if (status.timeRemaining) {
                        timeRow += `<span class="time-badge">⏳ ${status.timeRemaining}</span>`;
                    }
                    if (status.estEndTime) {
                        timeRow += `<span class="time-badge">🏁 ${status.estEndTime}</span>`;
                    }
                    timeRow += `</div>`;
                }
                
                // Alerts row
                let alertsRow = '';
                const alerts = [];
                if (status.weightAlert) {
                    alerts.push(`<span class="alert-badge" data-tooltip="Post weight ±1.5kg from dry weight">⚖️</span>`);
                }
                if (status.timeShort) {
                    alerts.push(`<span class="alert-badge" data-tooltip="Treatment time ${status.timeShortMinutes}+ min short">⏱️</span>`);
                }
                if (status.ettNeeded) {
                    alerts.push(`<span class="alert-badge" data-tooltip="ETT signature required">✍️</span>`);
                }
                if (alerts.length > 0) {
                    alertsRow = `<div class="tab-row alerts-row">${alerts.join('')}</div>`;
                }
                
                // Chair badge
                const chairBadge = p.chair ? `Chair ${p.chair}` : 'No Chair';
                
                // Notes indicator
                const notesIndicator = p.quickNotes ? '<span title="Has notes" style="opacity: 0.7;">📝</span>' : '';

                // Incomplete todos indicator
                const incompleteTodosIndicator = hasIncompleteTodos(p) ? '<span title="Incomplete to-dos" style="color: #dc2626; font-weight: bold;">❗</span>' : '';

                // Special status classes for tab
                const hospitalized = p.hospitalization ? 'hospitalized' : '';
                const missedTxClass = (p.missedTx && (p.missedTxSubs?.rescheduled || p.missedTxSubs?.calledOff || p.missedTxSubs?.noCallNoShow)) ? 'missed-tx' : '';
                const chartClosedClass = p.chartClosed ? 'chart-closed' : '';

                // Pre badge shows yellow if machine check is done but not all items
                const preYellow = (p.preCheckSubs?.machineCheck && !(p.preCheckSubs?.machineCheck && p.preCheckSubs?.preDialysis && p.preCheckSubs?.orderVerify)) ? 'yellow' : '';
                // Pre checkmark if all sub-items done
                const preCheckmark = (p.preCheckSubs?.machineCheck && p.preCheckSubs?.preDialysis && p.preCheckSubs?.orderVerify) ? ' ✓' : '';
                // Meds checkmark if all sub-items done
                const medsCheckmark = (p.medsSubs?.medsGiven && p.medsSubs?.medsSheetSigned) ? ' ✓' : '';

                return `<div class="patient-tab ${isActive ? 'active' : ''} ${hospitalized} ${missedTxClass} ${chartClosedClass}" onclick="switchPatient(${p.id})">
                    <button class="quick-chart-tab-btn" onclick="event.stopPropagation(); openQuickChart(${p.id})" title="Quick Chart">⚡</button>
                    <div class="tab-header">
                        <span class="patient-name">${p.name} ${notesIndicator} ${incompleteTodosIndicator}</span>
                        <span class="chair-badge">${chairBadge}</span>
                    </div>
                    <div class="tab-body">
                        ${statusRow}
                        ${timeRow}
                        ${alertsRow}
                    </div>
                </div>`;
            }).join('');
            
            // Add patient button
            const addButton = `<div class="patient-tab" onclick="addPatient(); renderAll();" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-color: #10b981; color: white; min-width: 100px; justify-content: center; align-items: center;">
                <div class="tab-header" style="border: none; justify-content: center;">
                    <span class="patient-name">➕ Add</span>
                </div>
            </div>`;
            
            tabsContainer.innerHTML = tabsHTML + addButton;
        }
        
        function switchPod(techName) {
            state.activePod = techName;
            
            // Select first patient in the new pod
            const pods = getPodGroups();
            const pod = pods[techName];
            if (pod && pod.patients.length > 0) {
                state.activePatientId = pod.patients[0].id;
            }
            
            renderAll();
        }
        
        function getEnhancedPatientStatus(patient) {
            const status = {
                preCheck: patient.preCheck,
                thirtyMinCheck: patient.thirtyMinCheck,
                medsComplete: patient.medsComplete,
                postComplete: !!(patient.postWeight && patient.endTime),
                timeRemaining: null,
                estEndTime: null,
                weightAlert: false,
                timeShort: false,
                timeShortMinutes: 0,
                ettNeeded: false
            };
            
            // Calculate time remaining and est end time
            if (patient.startTime && patient.rxTime) {
                const now = new Date();
                const startMinutes = timeToMinutes(patient.startTime);
                const rxMinutes = parseTimeToMinutes(patient.rxTime);
                const estimatedEndMinutes = startMinutes + rxMinutes;
                
                // Format est end time
                const endHours = Math.floor(estimatedEndMinutes / 60) % 24;
                const endMins = estimatedEndMinutes % 60;
                status.estEndTime = `${String(endHours).padStart(2, '0')}${String(endMins).padStart(2, '0')}`;
                
                // Calculate time remaining
                const estimatedEndTime = new Date();
                estimatedEndTime.setHours(Math.floor(estimatedEndMinutes / 60));
                estimatedEndTime.setMinutes(estimatedEndMinutes % 60);
                estimatedEndTime.setSeconds(0);
                
                const diffMs = estimatedEndTime - now;
                const diffMins = Math.floor(diffMs / 1000 / 60);
                
                if (diffMins > 0) {
                    const hours = Math.floor(diffMins / 60);
                    const mins = diffMins % 60;
                    status.timeRemaining = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                } else if (diffMins <= 0) {
                    status.timeRemaining = 'Done';
                }
            }
            
            // Check weight alert
            if (patient.postWeight && patient.dryWeight) {
                const diff = Math.abs(parseFloat(patient.postWeight) - parseFloat(patient.dryWeight));
                status.weightAlert = diff > 1.5;
            }
            
            // Check time short
            const timeCheck = calcTimeShortfall(patient.rxTime, patient.startTime, patient.endTime);
            if (timeCheck.isShort) {
                status.timeShort = true;
                status.timeShortMinutes = timeCheck.shortfall;
            }
            
            // ETT needed: if time is short and not yet signed
            if (status.timeShort && !patient.ettSigned) {
                status.ettNeeded = true;
            }
            
            return status;
        }


        
        // Snippet management functions
        function toggleSnippet(patientId, snippetType) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const index = patient.selectedSnippets.indexOf(snippetType);
            if (index > -1) {
                patient.selectedSnippets.splice(index, 1);
            } else {
                patient.selectedSnippets.push(snippetType);
            }
            
            renderAll();
        }
        
        function updateSnippetInput(patientId, field, value) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient[field] = value;
            renderAll();
        }
        
        function generateUFSnippet(patient) {
            const preOverDW = calcPreOverDW(patient.preWeight, patient.dryWeight);
            const totalRemoved = calcTotalRemoved(patient.preWeight, patient.postWeight);
            const postVsDW = calcPostVsDW(patient.postWeight, patient.dryWeight);
            
            if (!preOverDW || !totalRemoved || !postVsDW) {
                return { text: '', html: '' };
            }
            
            const dryWeight = parseFloat(patient.dryWeight).toFixed(1);
            const aboveBelow = parseFloat(postVsDW) >= 0 ? 'above' : 'below';
            const postVsDWAbs = Math.abs(parseFloat(postVsDW)).toFixed(1);
            const isOverThreshold = Math.abs(parseFloat(postVsDW)) > 1.5;
            
            const preSign = parseFloat(preOverDW) >= 0 ? '+' : '';
            
            const baseText = `Pt arrived ${preSign}${preOverDW} kg over DW of ${dryWeight} kg. Pt removed ${totalRemoved} kg, leaving ${postVsDWAbs} kg ${aboveBelow} dry weight.`;
            
            const finalPortion = `${postVsDWAbs} kg ${aboveBelow} dry weight`;
            const finalPortionHTML = isOverThreshold 
                ? `<span style="color: #e53e3e; font-weight: bold;">${finalPortion}</span>`
                : finalPortion;
            
            const baseHTML = `Pt arrived ${preSign}${preOverDW} kg over DW of ${dryWeight} kg. Pt removed ${totalRemoved} kg, leaving ${finalPortionHTML}.`;
            
            return { text: baseText, html: baseHTML };
        }
        
        function getSnippetText(patient, snippetType) {
            switch(snippetType) {
                case 'offered':
                    return 'Pt offered extra tx to remove excess fluid.';
                case 'refused':
                    return 'Pt refused.';
                case 'agreeable':
                    const day = patient.extraTxDay || '[day]';
                    const side = patient.extraTxSide || '[side]';
                    const time = patient.extraTxTime || '[time]';
                    return `Pt agreeable to extra tx. NP Kline approved. Pt to come in ${day} on ${side} side at ${time}.`;
                case 'transport-arranged':
                    return 'Transportation arranged.';
                case 'self-transport':
                    return 'Pt self transports.';
                default:
                    return '';
            }
        }
        
        function generateCompleteSnippet(patient) {
            const baseSnippet = generateUFSnippet(patient);
            if (!baseSnippet.text) {
                return { text: '', html: '' };
            }
            
            const parts = [baseSnippet.text];
            const htmlParts = [baseSnippet.html];
            
            patient.selectedSnippets.forEach(snippetType => {
                const text = getSnippetText(patient, snippetType);
                parts.push(text);
                htmlParts.push(text);
            });
            
            return {
                text: parts.join(' '),
                html: htmlParts.join(' ')
            };
        }
        
        async function copySnippet(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const snippet = generateCompleteSnippet(patient);
            if (!snippet.text) return;
            
            try {
                const htmlBlob = new Blob([snippet.html], { type: 'text/html' });
                const textBlob = new Blob([snippet.text], { type: 'text/plain' });
                
                const clipboardItem = new ClipboardItem({
                    'text/html': htmlBlob,
                    'text/plain': textBlob
                });
                
                await navigator.clipboard.write([clipboardItem]);
                
                const feedback = document.getElementById(`copyFeedback_${patientId}`);
                if (feedback) {
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 2000);
                }
            } catch (err) {
                console.error('Failed to copy:', err);
                try {
                    await navigator.clipboard.writeText(snippet.text);
                    const feedback = document.getElementById(`copyFeedback_${patientId}`);
                    if (feedback) {
                        feedback.classList.add('show');
                        setTimeout(() => feedback.classList.remove('show'), 2000);
                    }
                } catch (fallbackErr) {
                    alert('Failed to copy to clipboard. Please try again.');
                }
            }
        }
        
        function clearSnippetSelections(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient.selectedSnippets = [];
            patient.extraTxDay = '';
            patient.extraTxSide = '';
            patient.extraTxTime = '';
            renderAll();
        }
        
        // Pre Dialysis Snippet Functions
        function generatePreDialysisSnippet(patient) {
            if (!patient.goalUF) {
                return { text: '', html: '' };
            }
            
            // Start with default sentence
            const firstSentence = 'Weight and goal reviewed and verified with pt.';
            const parts = [`UF Goal of ${patient.goalUF} kg`];
            
            if (patient.selectedPreSnippets && patient.selectedPreSnippets.length > 0) {
                patient.selectedPreSnippets.forEach(snippetType => {
                    parts.push(getPreSnippetText(snippetType));
                });
            }
            
            const text = firstSentence + ' ' + parts.join(', ') + '.';
            const html = text;
            
            return { text, html };
        }
        
        function getPreSnippetText(snippetType) {
            switch(snippetType) {
                case 'pt-request':
                    return 'per pt request';
                case 'pt-tolerance':
                    return 'per pt tolerance';
                default:
                    return '';
            }
        }
        
        function togglePreSnippet(patientId, snippetType) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            if (!patient.selectedPreSnippets) {
                patient.selectedPreSnippets = [];
            }
            
            const index = patient.selectedPreSnippets.indexOf(snippetType);
            if (index > -1) {
                patient.selectedPreSnippets.splice(index, 1);
            } else {
                patient.selectedPreSnippets.push(snippetType);
            }
            
            renderAll();
        }
        
        async function copyPreSnippet(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const snippet = generatePreDialysisSnippet(patient);
            if (!snippet.text) return;
            
            try {
                await navigator.clipboard.writeText(snippet.text);
                
                const feedback = document.getElementById(`copyPreFeedback_${patientId}`);
                if (feedback) {
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 2000);
                }
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please try again.');
            }
        }
        
        function clearPreSnippetSelections(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient.selectedPreSnippets = [];
            renderAll();
        }
        
        // Time Snippet Functions
        function generateTimeSnippet(patient) {
            if (!patient.startTime || !patient.endTime || !patient.rxTime) {
                return { text: '', html: '' };
            }
            
            const actualDuration = calcActualDuration(patient.startTime, patient.endTime);
            const timeCheck = calcTimeShortfall(patient.rxTime, patient.startTime, patient.endTime);
            
            if (!actualDuration) {
                return { text: '', html: '' };
            }
            
            const startFormatted = patient.startTime;
            const endFormatted = patient.endTime;
            const prescribedTime = patient.rxTime;
            
            // Base text: "Tx start/end 0637 - 0941. Actual duration: 03:04 of 03:30."
            let baseText = `Tx start/end ${startFormatted} - ${endFormatted}. Actual duration: ${actualDuration} of ${prescribedTime}.`;
            let baseHTML = `Tx start/end ${startFormatted} - ${endFormatted}. Actual duration: ${actualDuration} of ${prescribedTime}.`;
            
            // If treatment was short, add the "Tx ended XX:XX early" sentence
            if (timeCheck.isShort && timeCheck.shortfall) {
                // Remove the negative sign from shortfall (it's already "short")
                const shortfallFormatted = timeCheck.shortfall.replace('-', '');
                const earlySentence = ` Tx ended ${shortfallFormatted} early.`;
                
                // Plain text
                baseText += earlySentence;
                
                // HTML with bold and red (Outlook compatible)
                const earlySentenceHTML = `<span style="font-weight: bold; color: red;"> Tx ended ${shortfallFormatted} early.</span>`;
                baseHTML += earlySentenceHTML;
            }
            
            return { text: baseText, html: baseHTML };
        }
        
        function toggleTimeSnippet(patientId, snippetType) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            if (!patient.selectedTimeSnippets) {
                patient.selectedTimeSnippets = [];
            }
            
            const index = patient.selectedTimeSnippets.indexOf(snippetType);
            if (index > -1) {
                patient.selectedTimeSnippets.splice(index, 1);
            } else {
                patient.selectedTimeSnippets.push(snippetType);
            }
            
            renderAll();
        }
        
        function getTimeSnippetText(patient, snippetType) {
            switch(snippetType) {
                case 'patient-request':
                    return 'Patient requested early termination.';
                case 'hypotension':
                    return 'Treatment ended early due to hypotension.';
                case 'cramping':
                    return 'Treatment ended early due to cramping.';
                case 'nausea':
                    return 'Treatment ended early due to nausea/vomiting.';
                case 'patient-unstable':
                    return 'Patient became unstable, treatment discontinued.';
                case 'ett-signed':
                    return 'ETT signed by patient.';
                default:
                    return '';
            }
        }
        
        function generateCompleteTimeSnippet(patient) {
            const baseSnippet = generateTimeSnippet(patient);
            if (!baseSnippet.text) {
                return { text: '', html: '' };
            }
            
            const parts = [baseSnippet.text];
            const htmlParts = [baseSnippet.html];
            
            if (patient.selectedTimeSnippets) {
                patient.selectedTimeSnippets.forEach(snippetType => {
                    const text = getTimeSnippetText(patient, snippetType);
                    parts.push(text);
                    htmlParts.push(text);
                });
            }
            
            return {
                text: parts.join(' '),
                html: htmlParts.join(' ')
            };
        }
        
        async function copyTimeSnippet(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const snippet = generateCompleteTimeSnippet(patient);
            if (!snippet.text) return;
            
            try {
                const htmlBlob = new Blob([snippet.html], { type: 'text/html' });
                const textBlob = new Blob([snippet.text], { type: 'text/plain' });
                
                const clipboardItem = new ClipboardItem({
                    'text/html': htmlBlob,
                    'text/plain': textBlob
                });
                
                await navigator.clipboard.write([clipboardItem]);
                
                const feedback = document.getElementById(`copyTimeFeedback_${patientId}`);
                if (feedback) {
                    feedback.classList.add('show');
                    setTimeout(() => feedback.classList.remove('show'), 2000);
                }
            } catch (err) {
                console.error('Failed to copy:', err);
                try {
                    await navigator.clipboard.writeText(snippet.text);
                    const feedback = document.getElementById(`copyTimeFeedback_${patientId}`);
                    if (feedback) {
                        feedback.classList.add('show');
                        setTimeout(() => feedback.classList.remove('show'), 2000);
                    }
                } catch (fallbackErr) {
                    alert('Failed to copy to clipboard. Please try again.');
                }
            }
        }
        
        function clearTimeSnippetSelections(patientId) {
            const patient = state.patients.find(p => p.id === patientId);
            if (!patient) return;
            
            patient.selectedTimeSnippets = [];
            renderAll();
        }

        // Helper function to get field status class (red when empty, green when filled)
        function getFieldStatusClass(value) {
            return value && String(value).trim() !== '' ? 'editable-filled' : 'editable-required';
        }
        
        function renderPatientCard(patient) {
            const actualUF = calcActualUF(patient.preWeight, patient.postWeight);
            const diff = calcDiff(patient.goalUF, actualUF);
            const actualDuration = calcActualDuration(patient.startTime, patient.endTime);
            const timeCheck = calcTimeShortfall(patient.rxTime, patient.startTime, patient.endTime);
            const weightAlert = checkWeightAlert(patient.postWeight, patient.dryWeight);
            
            // Field status classes for key editable fields
            const preWeightClass = getFieldStatusClass(patient.preWeight);
            const goalUFClass = getFieldStatusClass(patient.goalUF);
            const postWeightClass = getFieldStatusClass(patient.postWeight);
            const startTimeClass = getFieldStatusClass(patient.startTime);
            const endTimeClass = getFieldStatusClass(patient.endTime);

            // Special status classes for patient card background
            const hospitalizedClass = patient.hospitalization ? 'patient-hospitalized' : '';
            const missedTxCardClass = (patient.missedTx && (patient.missedTxSubs?.rescheduled || patient.missedTxSubs?.calledOff || patient.missedTxSubs?.noCallNoShow)) ? 'patient-missed-tx' : '';
            const chartClosedCardClass = patient.chartClosed ? 'chart-closed' : '';

            return `
                <div class="patient-card ${hospitalizedClass} ${missedTxCardClass} ${chartClosedCardClass}">
                    <!-- At-a-Glance Section -->
                    <div class="at-a-glance">
                        <div class="glance-title">
                            👁️ Quick View - ${patient.name}
                            <div class="glance-actions">
                                <button class="glance-action-btn" onclick="expandAllSections(${patient.id})" title="Expand All">
                                    ⬇️ Expand
                                </button>
                                <button class="glance-action-btn" onclick="collapseAllSections(${patient.id})" title="Collapse All">
                                    ⬆️ Collapse
                                </button>
                                <label class="chart-closed-checkbox ${patient.chartClosed ? 'checked' : ''} ${hasIncompleteTodos(patient) ? 'disabled' : ''}" style="margin-left: 15px;">
                                    <input type="checkbox" ${patient.chartClosed ? 'checked' : ''} ${hasIncompleteTodos(patient) ? 'disabled' : ''}
                                        onchange="updatePatient(${patient.id}, 'chartClosed', this.checked)"
                                        title="${hasIncompleteTodos(patient) ? 'Complete all to-dos before closing chart' : 'Mark chart as closed'}">
                                    <span class="chart-closed-label">📋 Chart Closed</span>
                                    <span class="chart-closed-checkmark">✓</span>
                                </label>
                                ${hasIncompleteTodos(patient) ? '<span style="color: #dc2626; font-size: 0.75em; margin-left: 8px;">Complete all to-dos first</span>' : ''}
                            </div>
                        </div>
                        <div class="glance-grid">
                            <div class="glance-item">
                                <div class="glance-label">Rx Time</div>
                                <div class="glance-value">${patient.rxTime || '--:--'}</div>
                            </div>
                            <div class="glance-item">
                                <div class="glance-label">Dialyzer</div>
                                <div class="glance-value">${patient.dialyzer}</div>
                            </div>
                            <div class="glance-item">
                                <div class="glance-label">Dry Weight</div>
                                <div class="glance-value">${patient.dryWeight || '--'} kg</div>
                            </div>
                            <div class="glance-item">
                                <div class="glance-label">Pre Weight</div>
                                <div class="glance-value">${patient.preWeight || '--'} kg</div>
                            </div>
                            <div class="glance-item">
                                <div class="glance-label">Goal UF</div>
                                <div class="glance-value">${patient.goalUF || '--'} kg</div>
                            </div>
                            <div class="glance-item">
                                <div class="glance-label">Post Weight</div>
                                <div class="glance-value ${weightAlert ? 'alert' : ''}">${patient.postWeight || '--'} kg</div>
                            </div>
                        </div>
                    </div>

                    <!-- Sections Container for Drag/Drop Reordering -->
                    <div class="sections-container" id="sectionsContainer_${patient.id}">

                    <!-- Tech Check (Missing Chart Items) - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="techcheck" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header" data-section="${patient.id}_techcheck" onclick="toggleSection(${patient.id}, 'techcheck')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            🔍 Tech Check (Missing Chart Items)
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content">
                            <div class="tech-check-grid">
                                <!-- Main Flowsheet -->
                                <div class="tech-check-card">
                                    <div class="tech-check-title">📋 Main Flowsheet</div>
                                    <div class="tech-check-items">
                                        <div class="tech-check-item ${patient.techCheck?.initiationTime ? 'checked' : ''}" 
                                            onclick="toggleTechCheck(${patient.id}, 'initiationTime', event)">
                                            <input type="checkbox" ${patient.techCheck?.initiationTime ? 'checked' : ''}>
                                            <label>Initiation Time</label>
                                        </div>
                                        <div class="tech-check-item ${patient.techCheck?.orderVerification ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'orderVerification', event)">
                                            <input type="checkbox" ${patient.techCheck?.orderVerification ? 'checked' : ''}>
                                            <label>Order Verification</label>
                                        </div>
                                        <div class="tech-check-item ${patient.techCheck?.accessEvalTime ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'accessEvalTime', event)">
                                            <input type="checkbox" ${patient.techCheck?.accessEvalTime ? 'checked' : ''}>
                                            <label>Access Eval. Time</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dialysis Treatment -->
                                <div class="tech-check-card">
                                    <div class="tech-check-title">💉 Dialysis Treatment</div>
                                    <div class="tech-check-items">
                                        <div class="tech-check-item ${patient.techCheck?.txInitiated ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'txInitiated', event)">
                                            <input type="checkbox" ${patient.techCheck?.txInitiated ? 'checked' : ''}>
                                            <label>Tx Initiated</label>
                                        </div>
                                        <div class="tech-check-item ${patient.techCheck?.txEnded ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'txEnded', event)">
                                            <input type="checkbox" ${patient.techCheck?.txEnded ? 'checked' : ''}>
                                            <label>Tx Ended</label>
                                        </div>
                                        <div class="tech-check-item ${patient.techCheck?.blankVitalsNotes ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'blankVitalsNotes', event)">
                                            <input type="checkbox" ${patient.techCheck?.blankVitalsNotes ? 'checked' : ''}>
                                            <label>Blank Vitals Notes</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Dialysis Meds -->
                                <div class="tech-check-card">
                                    <div class="tech-check-title">💊 Dialysis Meds</div>
                                    <div class="tech-check-items">
                                        <div class="tech-check-item ${patient.techCheck?.heparinBolus ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'heparinBolus', event)">
                                            <input type="checkbox" ${patient.techCheck?.heparinBolus ? 'checked' : ''}>
                                            <label>Heparin Bolus</label>
                                        </div>
                                        <div class="tech-check-item ${patient.techCheck?.lidocaine ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'lidocaine', event)">
                                            <input type="checkbox" ${patient.techCheck?.lidocaine ? 'checked' : ''}>
                                            <label>Lidocaine</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Post Dialysis -->
                                <div class="tech-check-card">
                                    <div class="tech-check-title">✅ Post Dialysis</div>
                                    <div class="tech-check-items">
                                        <div class="tech-check-item ${patient.techCheck?.postWeight ? 'checked' : ''}"
                                            onclick="toggleTechCheck(${patient.id}, 'postWeight', event)">
                                            <input type="checkbox" ${patient.techCheck?.postWeight ? 'checked' : ''}>
                                            <label>Post Weight</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QA Checklist - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="qa" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header" data-section="${patient.id}_qa" onclick="toggleSection(${patient.id}, 'qa')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            ✅ QA Checklist
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content">
                            <div class="qa-section">
                                <!-- 5-Column QA Grid -->
                                <div class="qa-boxes-grid">
                                    <!-- Pre Check -->
                                    <div class="qa-main-item ${patient.preCheck ? 'expanded' : ''}" id="qaPreCheck_${patient.id}">
                                        <label class="qa-main-checkbox">
                                            <input type="checkbox" ${patient.preCheck ? 'checked' : ''}
                                                onchange="toggleQAMainItem(${patient.id}, 'preCheck', this.checked)">
                                            Pre Check
                                            <span class="qa-checkmark" style="display: ${(patient.preCheckSubs?.machineCheck && patient.preCheckSubs?.preDialysis && patient.preCheckSubs?.orderVerify) ? 'inline' : 'none'}">✓</span>
                                        </label>
                                        <div class="qa-sub-items">
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.preCheckSubs?.machineCheck ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'preCheckSubs', 'machineCheck', this.checked)">
                                                Machine Check
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.preCheckSubs?.preDialysis ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'preCheckSubs', 'preDialysis', this.checked)">
                                                Pre Dialysis
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.preCheckSubs?.orderVerify ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'preCheckSubs', 'orderVerify', this.checked)">
                                                Order Verify
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Meds -->
                                    <div class="qa-main-item ${patient.medsComplete ? 'expanded' : ''}" id="qaMeds_${patient.id}">
                                        <label class="qa-main-checkbox">
                                            <input type="checkbox" ${patient.medsComplete ? 'checked' : ''}
                                                onchange="toggleQAMainItem(${patient.id}, 'medsComplete', this.checked)">
                                            Meds
                                            <span class="qa-checkmark" style="display: ${(patient.medsSubs?.medsGiven && patient.medsSubs?.medsSheetSigned) ? 'inline' : 'none'}">✓</span>
                                        </label>
                                        <div class="qa-sub-items">
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.medsSubs?.medsGiven ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'medsSubs', 'medsGiven', this.checked)">
                                                Meds Given
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.medsSubs?.medsSheetSigned ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'medsSubs', 'medsSheetSigned', this.checked)">
                                                Meds Sheet Signed
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Misc -->
                                    <div class="qa-main-item ${patient.misc ? 'expanded' : ''}" id="qaMisc_${patient.id}">
                                        <label class="qa-main-checkbox">
                                            <input type="checkbox" ${patient.misc ? 'checked' : ''}
                                                onchange="toggleQAMainItem(${patient.id}, 'misc', this.checked)">
                                            Misc
                                            <span class="qa-checkmark" style="display: ${(patient.miscSubs?.thirtyMinCheck && patient.miscSubs?.abxIDPN && patient.miscSubs?.statLabs && patient.miscSubs?.labsPrep) ? 'inline' : 'none'}">✓</span>
                                        </label>
                                        <div class="qa-sub-items">
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.miscSubs?.thirtyMinCheck ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'miscSubs', 'thirtyMinCheck', this.checked)">
                                                30 Min Check
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.miscSubs?.abxIDPN ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'miscSubs', 'abxIDPN', this.checked)">
                                                Abx/IDPN
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.miscSubs?.statLabs ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'miscSubs', 'statLabs', this.checked)">
                                                STAT Labs
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.miscSubs?.labsPrep ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'miscSubs', 'labsPrep', this.checked)">
                                                Labs Prep
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Hospitalization -->
                                    <div class="qa-main-item ${patient.hospitalization ? 'expanded' : ''}" id="qaHosp_${patient.id}" style="border-color: ${patient.hospitalization ? '#38bdf8' : '#e5e7eb'}; background: ${patient.hospitalization ? '#e0f2fe' : 'white'};">
                                        <label class="qa-main-checkbox">
                                            <input type="checkbox" ${patient.hospitalization ? 'checked' : ''}
                                                onchange="toggleQAMainItem(${patient.id}, 'hospitalization', this.checked)">
                                            🏥 Hosp
                                        </label>
                                        <div class="qa-sub-items">
                                            <div class="qa-sub-item">
                                                <input type="text" placeholder="Hospital..." value="${patient.hospitalizationHospital || ''}"
                                                    onchange="updatePatient(${patient.id}, 'hospitalizationHospital', this.value)" style="font-size: 0.85em;">
                                            </div>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.hospitalizationSubs?.hhPrep ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'hospitalizationSubs', 'hhPrep', this.checked)">
                                                H&H prep
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.hospitalizationSubs?.hospEntered ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'hospitalizationSubs', 'hospEntered', this.checked)">
                                                Entered
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.hospitalizationSubs?.whiteboard ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'hospitalizationSubs', 'whiteboard', this.checked)">
                                                Whiteboard
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.hospitalizationSubs?.eosrReport ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'hospitalizationSubs', 'eosrReport', this.checked)">
                                                EOSR
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Missed Tx -->
                                    <div class="qa-main-item ${patient.missedTx ? 'expanded' : ''}" id="qaMissedTx_${patient.id}" style="border-color: ${patient.missedTx ? '#facc15' : '#e5e7eb'}; background: ${patient.missedTx ? '#fef9c3' : 'white'};">
                                        <label class="qa-main-checkbox">
                                            <input type="checkbox" ${patient.missedTx ? 'checked' : ''}
                                                onchange="toggleQAMainItem(${patient.id}, 'missedTx', this.checked)">
                                            ⚠️ Missed
                                        </label>
                                        <div class="qa-sub-items">
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.missedTxSubs?.rescheduled ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'missedTxSubs', 'rescheduled', this.checked)">
                                                Rescheduled
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.missedTxSubs?.calledOff ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'missedTxSubs', 'calledOff', this.checked)">
                                                Called off
                                            </label>
                                            <label class="qa-sub-item">
                                                <input type="checkbox" ${patient.missedTxSubs?.noCallNoShow ? 'checked' : ''}
                                                    onchange="toggleQASubItem(${patient.id}, 'missedTxSubs', 'noCallNoShow', this.checked)">
                                                No show
                                            </label>
                                        </div>
                                    </div>
                                </div><!-- End qa-boxes-grid -->

                                <!-- Misc To-Do List & Labs Grid -->
                                <div class="todo-labs-grid">
                                    <!-- Misc To-Do List Section -->
                                    <div class="misc-todo-section" style="margin-top: 0;">
                                        <div class="misc-todo-header" data-section="${patient.id}_misctodo" onclick="toggleSection(${patient.id}, 'misctodo')" style="cursor: pointer; padding: 10px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="font-size: 0.9em; transition: transform 0.2s;">▼</span>
                                                <span class="misc-todo-title">📝 Misc To-Do List</span>
                                                ${hasIncompleteTodos(patient) ? '<span class="incomplete-todos-badge">⚠️ Incomplete</span>' : ''}
                                            </div>
                                        </div>

                                        <div class="misc-todo-content">
                                        <!-- Add To Do -->
                                        <div class="misc-todo-add-section">
                                            <div class="misc-todo-input-row">
                                                <input type="text" class="misc-todo-input" id="miscTodoInput_${patient.id}"
                                                    placeholder="Enter a to-do item..."
                                                    onkeypress="if(event.key==='Enter') addMiscTodoFromInput(${patient.id})">
                                                <button class="misc-todo-add-btn" onclick="addMiscTodoFromInput(${patient.id})">+ Add To Do</button>
                                            </div>
                                            <div class="misc-todo-snippets">
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'Access assessment chart')">Access assessment chart</button>
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'Foot check')">Foot check</button>
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'Monthly progress note')">Monthly progress note</button>
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'Daily progress note')">Daily progress note</button>
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'Notify MD/NP')">Notify MD/NP</button>
                                                <button class="misc-todo-snippet-btn" onclick="addMiscTodo(${patient.id}, 'PHN Call')">PHN Call</button>
                                            </div>
                                        </div>

                                        <!-- To Do List -->
                                        <div class="misc-todo-list">
                                            <div class="misc-todo-list-header">📋 To Do</div>
                                            ${(patient.miscTodos || []).filter(t => !t.completed).length === 0
                                                ? '<div class="misc-todo-empty">No pending to-dos</div>'
                                                : (patient.miscTodos || []).filter(t => !t.completed).map(todo => `
                                                    <div class="misc-todo-item">
                                                        <input type="checkbox" class="misc-todo-checkbox"
                                                            onchange="toggleMiscTodo(${patient.id}, ${todo.id}, this.checked)">
                                                        <span class="misc-todo-text">${todo.text}</span>
                                                        <span class="misc-todo-timestamp">${todo.timestamp}</span>
                                                        <button class="misc-todo-delete" onclick="deleteMiscTodo(${patient.id}, ${todo.id})">✕</button>
                                                    </div>
                                                `).join('')
                                            }
                                        </div>

                                        <!-- Complete List -->
                                        <div class="misc-todo-list">
                                            <div class="misc-todo-list-header">✅ Complete</div>
                                            ${(patient.miscTodos || []).filter(t => t.completed).length === 0
                                                ? '<div class="misc-todo-empty">No completed to-dos</div>'
                                                : (patient.miscTodos || []).filter(t => t.completed).map(todo => `
                                                    <div class="misc-todo-item completed">
                                                        <input type="checkbox" class="misc-todo-checkbox" checked
                                                            onchange="toggleMiscTodo(${patient.id}, ${todo.id}, this.checked)">
                                                        <span class="misc-todo-text">${todo.text}</span>
                                                        <span class="misc-todo-timestamp">${todo.timestamp}</span>
                                                        <button class="misc-todo-delete" onclick="deleteMiscTodo(${patient.id}, ${todo.id})">✕</button>
                                                    </div>
                                                `).join('')
                                            }
                                        </div>
                                        </div><!-- End misc-todo-content -->
                                    </div>

                                    <!-- STAT Labs Section -->
                                    <div class="labs-section" style="margin-top: 0;">
                                        <div class="labs-header" data-section="${patient.id}_labs" onclick="toggleSection(${patient.id}, 'labs')" style="cursor: pointer; padding: 10px; background: linear-gradient(135deg, #fef9c3 0%, #fef3c7 100%); border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <span style="font-size: 0.9em; transition: transform 0.2s;">▼</span>
                                                <span class="labs-title">🧪 STAT Labs</span>
                                                ${hasIncompleteLabs(patient) ? '<span class="incomplete-labs-badge">⚠️ Incomplete</span>' : ''}
                                            </div>
                                        </div>

                                        <div class="labs-content">
                                        <!-- Add Lab -->
                                        <div class="labs-add-section">
                                            <div class="labs-input-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                                                <input type="text" class="labs-input" id="labInput_${patient.id}"
                                                    placeholder="Enter a lab..."
                                                    onkeypress="if(event.key==='Enter') addLabFromInput(${patient.id})"
                                                    style="flex: 1; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 0.95em;">
                                                <button class="labs-add-btn" onclick="addLabFromInput(${patient.id})" style="padding: 10px 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">+ Add Lab</button>
                                            </div>
                                            <div class="labs-snippets">
                                                <button class="labs-snippet-btn" onclick="addLab(${patient.id}, 'H&H - Post Hosp.')">H&H - Post Hosp.</button>
                                                <button class="labs-snippet-btn" onclick="addLab(${patient.id}, 'BMP - 2+ Missed Tx')">BMP - 2+ Missed Tx</button>
                                            </div>
                                        </div>

                                        <!-- Labs List -->
                                        <div class="labs-list">
                                            <div class="labs-list-header">🧪 Pending Labs</div>
                                            ${(patient.labs || []).filter(l => !l.sectionComplete).length === 0
                                                ? '<div class="labs-empty">No pending labs</div>'
                                                : (patient.labs || []).filter(l => !l.sectionComplete).map(lab => {
                                                    const allChecked = isLabComplete(lab);
                                                    return `
                                                    <div class="labs-item ${allChecked ? 'all-complete' : ''}">
                                                        <div class="labs-item-header">
                                                            <span class="labs-item-name">${lab.name}</span>
                                                            <span class="labs-item-timestamp">${lab.timestamp}</span>
                                                            <button class="labs-item-delete" onclick="deleteLab(${patient.id}, ${lab.id})">✕</button>
                                                        </div>
                                                        <div class="labs-item-body">
                                                            <div class="labs-item-left">
                                                                <input type="checkbox" class="labs-main-checkbox" ${lab.mainComplete ? 'checked' : ''}
                                                                    onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'mainComplete', this.checked)"
                                                                    title="Main checkbox">
                                                                <span style="font-weight: 500; font-size: 0.9em;">${lab.name}</span>
                                                            </div>
                                                            <div class="labs-item-right">
                                                                <label class="labs-sub-checkbox ${lab.distributed ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.distributed ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'distributed', this.checked)">
                                                                    Distributed
                                                                </label>
                                                                <label class="labs-sub-checkbox ${lab.drawn ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.drawn ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'drawn', this.checked)">
                                                                    Drawn
                                                                </label>
                                                                <label class="labs-sub-checkbox ${lab.orderInNextGen ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.orderInNextGen ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'orderInNextGen', this.checked)">
                                                                    Order in NextGen
                                                                </label>
                                                                <div class="labs-result-input">
                                                                    <span>Result:</span>
                                                                    <input type="text" value="${lab.resultText || ''}"
                                                                        onchange="updateLabResultText(${patient.id}, ${lab.id}, this.value)"
                                                                        placeholder="Enter result...">
                                                                </div>
                                                                <label class="labs-sub-checkbox ${lab.resultsSentEmail ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.resultsSentEmail ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'resultsSentEmail', this.checked)">
                                                                    Results sent via Email
                                                                </label>
                                                                <label class="labs-sub-checkbox ${lab.resultsEnteredRenvio ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.resultsEnteredRenvio ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'resultsEnteredRenvio', this.checked)">
                                                                    Results entered in Renvio
                                                                </label>
                                                                <label class="labs-sub-checkbox ${lab.actionTaken ? 'checked' : ''}">
                                                                    <input type="checkbox" ${lab.actionTaken ? 'checked' : ''}
                                                                        onchange="toggleLabCheckbox(${patient.id}, ${lab.id}, 'actionTaken', this.checked)">
                                                                    Action taken if out of parameters
                                                                </label>
                                                                ${allChecked ? `
                                                                <label class="labs-complete-checkbox" style="margin-left: auto;">
                                                                    <input type="checkbox" ${lab.sectionComplete ? 'checked' : ''}
                                                                        onchange="toggleLabSectionComplete(${patient.id}, ${lab.id}, this.checked)">
                                                                    Mark Complete
                                                                </label>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                `}).join('')
                                            }
                                        </div>

                                        <!-- Completed Labs -->
                                        <div class="labs-list">
                                            <div class="labs-list-header">✅ Completed Labs</div>
                                            ${(patient.labs || []).filter(l => l.sectionComplete).length === 0
                                                ? '<div class="labs-empty">No completed labs</div>'
                                                : (patient.labs || []).filter(l => l.sectionComplete).map(lab => `
                                                    <div class="labs-item labs-item-completed" id="completedLab_${patient.id}_${lab.id}" onclick="toggleCompletedLabExpand(${patient.id}, ${lab.id}, event)">
                                                        <div class="labs-item-header">
                                                            <label class="labs-complete-checkbox" onclick="event.stopPropagation()">
                                                                <input type="checkbox" checked
                                                                    onchange="toggleLabSectionComplete(${patient.id}, ${lab.id}, this.checked)">
                                                            </label>
                                                            <span class="labs-item-name">${lab.name}</span>
                                                            <span class="labs-expand-icon">▼</span>
                                                            <span class="labs-item-timestamp">${lab.timestamp}</span>
                                                            <button class="labs-item-delete" onclick="event.stopPropagation(); deleteLab(${patient.id}, ${lab.id})">✕</button>
                                                        </div>
                                                        <div class="labs-item-details">
                                                            <div class="labs-detail-row">
                                                                <span class="labs-detail-item ${lab.distributed ? 'checked' : ''}">✓ Distributed</span>
                                                                <span class="labs-detail-item ${lab.drawn ? 'checked' : ''}">✓ Drawn</span>
                                                                <span class="labs-detail-item ${lab.orderInNextGen ? 'checked' : ''}">✓ Order in NextGen</span>
                                                            </div>
                                                            <div class="labs-detail-row">
                                                                <span class="labs-detail-item ${lab.resultsSentEmail ? 'checked' : ''}">✓ Results sent via Email</span>
                                                                <span class="labs-detail-item ${lab.resultsEnteredRenvio ? 'checked' : ''}">✓ Results entered in Renvio</span>
                                                            </div>
                                                            <div class="labs-detail-row">
                                                                <span class="labs-detail-item ${lab.actionTaken ? 'checked' : ''}">✓ Action taken if out of parameters</span>
                                                            </div>
                                                            ${lab.resultText ? '<div class="labs-detail-result">Result: ' + lab.resultText + '</div>' : ''}
                                                        </div>
                                                    </div>
                                                `).join('')
                                            }
                                        </div>
                                        </div><!-- End labs-content -->
                                    </div>
                                </div><!-- End todo-labs-grid -->
                            </div>
                        </div>
                    </div>

                    <!-- Assignment - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="assignment" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header ${state.collapsedSections[`${patient.id}_assignment`] ? 'collapsed' : ''}" data-section="${patient.id}_assignment" onclick="toggleSection(${patient.id}, 'assignment')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            👤 Assignment (Tech/Pod/Chair)
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content ${state.collapsedSections[`${patient.id}_assignment`] ? 'collapsed' : ''}">
                            <div class="field-grid">
                                <div class="field-group">
                                    <label class="field-label">Section</label>
                                    <select class="field-input" onchange="updatePatientAssignment(${patient.id}, 'section', this.value)">
                                        ${Object.keys(state.sections).map(key => 
                                            `<option value="${key}" ${patient.section === key ? 'selected' : ''}>${state.sections[key].name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Technician ✏️</label>
                                    <select class="field-input" onchange="onTechSelectedInCard(${patient.id}, this.value)">
                                        <option value="">Select Tech...</option>
                                        ${state.technicians.map(tech => 
                                            `<option value="${tech.name}" ${patient.technician === tech.name ? 'selected' : ''}>${tech.name} (Pod ${tech.pod})</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Pod (auto-assigned)</label>
                                    <input type="text" class="field-input ${patient.pod ? 'auto-filled' : ''}" 
                                        value="${patient.pod ? 'Pod ' + patient.pod : ''}" 
                                        placeholder="Auto-fills from tech" disabled readonly>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Chair # ✏️</label>
                                    <select class="field-input" onchange="updatePatientAssignment(${patient.id}, 'chair', this.value)">
                                        <option value="">Select Chair...</option>
                                        ${getChairsForSection(patient.section).map(chair => 
                                            `<option value="${chair}" ${patient.chair === String(chair) ? 'selected' : ''}>Chair ${chair}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Treatment Orders - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="orders" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header ${state.collapsedSections[`${patient.id}_orders`] ? 'collapsed' : ''}" data-section="${patient.id}_orders" onclick="toggleSection(${patient.id}, 'orders')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            📋 Treatment Orders
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content ${state.collapsedSections[`${patient.id}_orders`] ? 'collapsed' : ''}">
                            <div class="field-grid">
                                <div class="field-group">
                                    <label class="field-label">Patient Name</label>
                                    <input type="text" class="field-input" value="${patient.name}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Shift ✏️</label>
                                    <select class="field-input" onchange="updatePatient(${patient.id}, 'shift', this.value)">
                                        <option value="1st" ${patient.shift === '1st' ? 'selected' : ''}>1st Shift</option>
                                        <option value="2nd" ${patient.shift === '2nd' ? 'selected' : ''}>2nd Shift</option>
                                    </select>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Rx Time (h:mm) ✏️</label>
                                    <input type="text" class="field-input" value="${patient.rxTime}" 
                                        placeholder="03:30" onchange="updatePatient(${patient.id}, 'rxTime', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Dialyzer</label>
                                    <input type="text" class="field-input" value="${patient.dialyzer}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Bi</label>
                                    <input type="text" class="field-input" value="${patient.bi}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Profile</label>
                                    <input type="text" class="field-input" value="${patient.profile}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">NA</label>
                                    <input type="text" class="field-input" value="${patient.na}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">K ✏️</label>
                                    <input type="text" class="field-input" value="${patient.k}" 
                                        onchange="updatePatient(${patient.id}, 'k', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">CA</label>
                                    <input type="text" class="field-input" value="${patient.ca}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">DFR</label>
                                    <input type="text" class="field-input" value="${patient.dfr}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">BFR</label>
                                    <input type="text" class="field-input" value="${patient.bfr}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Arterial Needle Gauge</label>
                                    <input type="text" class="field-input" value="${patient.arterialNeedleGauge}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Venous Needle Gauge</label>
                                    <input type="text" class="field-input" value="${patient.venousNeedleGauge}" disabled>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Temp</label>
                                    <input type="text" class="field-input" value="${patient.temp}" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weight Management - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="weight" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header" data-section="${patient.id}_weight" onclick="toggleSection(${patient.id}, 'weight')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            ⚖️ Weight & UF Management
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content">
                            ${renderWheelchairSection(patient)}
                            <div class="field-grid">
                                <div class="field-group">
                                    <label class="field-label">Dry Weight (kg) ✏️</label>
                                    <input type="number" step="0.1" class="field-input" value="${patient.dryWeight}"
                                        onchange="updatePatient(${patient.id}, 'dryWeight', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Pre Weight (kg) ✏️</label>
                                    <input type="number" step="0.1" class="field-input ${preWeightClass}" value="${patient.preWeight}"
                                        onchange="updatePatient(${patient.id}, 'preWeight', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Goal UF (kg) ✏️</label>
                                    <input type="number" step="0.1" class="field-input ${goalUFClass}" value="${patient.goalUF || ''}" 
                                        placeholder="Enter goal" onchange="updatePatient(${patient.id}, 'goalUF', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Post Weight (kg) ✏️</label>
                                    <input type="number" step="0.1" class="field-input ${postWeightClass} ${weightAlert ? 'calculated-field danger' : ''}" 
                                        value="${patient.postWeight}" onchange="updatePatient(${patient.id}, 'postWeight', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">📊 Actual UF (kg)</label>
                                    <input type="text" class="field-input calculated-field" value="${actualUF}" readonly tabindex="-1" placeholder="Auto">
                                </div>
                            </div>
                            
                            <!-- UF Calculations for Documentation -->
                            <div class="field-grid" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                                <div class="field-group">
                                    <label class="field-label">📊 Pre Over DW (kg)</label>
                                    <input type="text" class="field-input calculated-field" value="${calcPreOverDW(patient.preWeight, patient.dryWeight)}" readonly tabindex="-1" placeholder="Auto">
                                </div>
                                <div class="field-group">
                                    <label class="field-label click-to-copy-label">📊 Target Weight (kg) <span class="click-to-copy-hint">📋 Click to copy</span></label>
                                    <input type="text" class="field-input calculated-field click-to-copy" value="${calcTargetWeight(patient.preWeight, patient.goalUF)}" readonly tabindex="-1" placeholder="Auto" onclick="copyTargetWeight(this)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">📊 Post vs DW (kg)</label>
                                    <input type="text" class="field-input calculated-field ${weightAlert ? 'danger' : ''}" value="${calcPostVsDW(patient.postWeight, patient.dryWeight)}" readonly tabindex="-1" placeholder="Auto">
                                </div>
                            </div>

                            ${weightAlert ? `
                            <div class="alert-box">
                                <h4>⚠️ Weight Alert: Post weight is ±1.5kg from dry weight</h4>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="weightEmail_${patient.id}" 
                                        onchange="updatePatient(${patient.id}, 'weightEmailSent', this.checked)">
                                    <label for="weightEmail_${patient.id}">Added to end of shift email</label>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- UF Documentation Snippets - Side by Side -->
                            <div class="snippet-sections-container">
                                <!-- Pre Dialysis Documentation Snippet -->
                                <div class="snippet-section ${patient.preDialysisComplete ? 'completed' : ''}">
                                    <div class="snippet-section-header">
                                        <input type="checkbox" class="complete-checkbox" 
                                            ${patient.preDialysisComplete ? 'checked' : ''}
                                            onchange="updatePatient(${patient.id}, 'preDialysisComplete', this.checked)">
                                        <h3 style="margin: 0;">📋 Pre Dialysis</h3>
                                        ${patient.preDialysisComplete ? '<span style="color: #27ae60; font-weight: bold; margin-left: auto;">✓ COMPLETE</span>' : ''}
                                    </div>
                                    
                                    <div class="snippet-content">
                                        <div class="snippet-box" id="preSnippetBox_${patient.id}">
                                            ${generatePreDialysisSnippet(patient).html || '<span style="color: #a0aec0; font-style: italic;">Enter Goal UF to generate pre-dialysis documentation</span>'}
                                        </div>
                                        
                                        <h3 style="margin-top: 15px; font-size: 0.9em;">UF Goal Reason (Click to Add)</h3>
                                        
                                        <div class="snippet-options-container">
                                            <div class="snippet-option ${patient.selectedPreSnippets && patient.selectedPreSnippets.includes('pt-request') ? 'selected' : ''}" 
                                                onclick="togglePreSnippet(${patient.id}, 'pt-request')">
                                                per pt request
                                            </div>
                                            
                                            <div class="snippet-option ${patient.selectedPreSnippets && patient.selectedPreSnippets.includes('pt-tolerance') ? 'selected' : ''}" 
                                                onclick="togglePreSnippet(${patient.id}, 'pt-tolerance')">
                                                per pt tolerance
                                            </div>
                                        </div>
                                        
                                        <button class="copy-snippet-btn" onclick="copyPreSnippet(${patient.id})" 
                                            ${!generatePreDialysisSnippet(patient).text ? 'disabled' : ''}>
                                            📋 Copy Snippet
                                        </button>
                                        
                                        ${patient.selectedPreSnippets && patient.selectedPreSnippets.length > 0 ? `
                                        <button class="clear-snippet-btn" onclick="clearPreSnippetSelections(${patient.id})">
                                            Clear
                                        </button>
                                        ` : ''}
                                        
                                        <div class="copy-feedback" id="copyPreFeedback_${patient.id}">✓ Copied!</div>
                                    </div>
                                </div>
                                
                                <!-- Post Dialysis Documentation Snippet -->
                                <div class="snippet-section ${patient.postDialysisComplete ? 'completed' : ''}">
                                    <div class="snippet-section-header">
                                        <input type="checkbox" class="complete-checkbox" 
                                            ${patient.postDialysisComplete ? 'checked' : ''}
                                            onchange="updatePatient(${patient.id}, 'postDialysisComplete', this.checked)">
                                        <h3 style="margin: 0;">📋 Post Dialysis</h3>
                                        ${patient.postDialysisComplete ? '<span style="color: #27ae60; font-weight: bold; margin-left: auto;">✓ COMPLETE</span>' : ''}
                                    </div>
                                    
                                    <div class="snippet-content">
                                        <div class="snippet-box" id="snippetBox_${patient.id}">
                                            ${generateCompleteSnippet(patient).html || '<span style="color: #a0aec0; font-style: italic;">Enter all weight values to generate documentation snippet</span>'}
                                        </div>
                                        
                                        <h3 style="margin-top: 15px; font-size: 0.9em;">Additional Documentation (Click to Add)</h3>
                                        
                                        <div class="snippet-options-container">
                                            <div class="snippet-option ${patient.selectedSnippets.includes('offered') ? 'selected' : ''}" 
                                                onclick="toggleSnippet(${patient.id}, 'offered')">
                                                Pt offered extra tx to remove excess fluid.
                                            </div>
                                            
                                            <div class="snippet-option ${patient.selectedSnippets.includes('refused') ? 'selected' : ''}" 
                                                onclick="toggleSnippet(${patient.id}, 'refused')">
                                                Pt refused.
                                            </div>
                                            
                                            <div class="snippet-option ${patient.selectedSnippets.includes('agreeable') ? 'selected' : ''}">
                                                <div onclick="toggleSnippet(${patient.id}, 'agreeable')">
                                                    Pt agreeable to extra tx. NP Kline approved. Pt to come in [day] on [side] side at [time].
                                                </div>
                                                <div class="snippet-input-group ${patient.selectedSnippets.includes('agreeable') ? 'show' : ''}">
                                                    <input type="text" class="snippet-input" placeholder="Day (e.g., Monday)" 
                                                        value="${patient.extraTxDay || ''}" 
                                                        onchange="updateSnippetInput(${patient.id}, 'extraTxDay', this.value)"
                                                        onclick="event.stopPropagation()">
                                                    <input type="text" class="snippet-input" placeholder="Side (A/B)" maxlength="1" 
                                                        value="${patient.extraTxSide || ''}" 
                                                        onchange="updateSnippetInput(${patient.id}, 'extraTxSide', this.value)"
                                                        onclick="event.stopPropagation()">
                                                    <input type="text" class="snippet-input" placeholder="Time (e.g., 1400)" 
                                                        value="${patient.extraTxTime || ''}" 
                                                        onchange="updateSnippetInput(${patient.id}, 'extraTxTime', this.value)"
                                                        onclick="event.stopPropagation()">
                                                </div>
                                            </div>
                                            
                                            <div class="snippet-option ${patient.selectedSnippets.includes('transport-arranged') ? 'selected' : ''}" 
                                                onclick="toggleSnippet(${patient.id}, 'transport-arranged')">
                                                Transportation arranged.
                                            </div>
                                            
                                            <div class="snippet-option ${patient.selectedSnippets.includes('self-transport') ? 'selected' : ''}" 
                                                onclick="toggleSnippet(${patient.id}, 'self-transport')">
                                                Pt self transports.
                                            </div>
                                        </div>
                                        
                                        <button class="copy-snippet-btn" onclick="copySnippet(${patient.id})" 
                                            ${!generateCompleteSnippet(patient).text ? 'disabled' : ''}>
                                            📋 Copy Snippet
                                        </button>
                                        
                                        ${patient.selectedSnippets.length > 0 ? `
                                        <button class="clear-snippet-btn" onclick="clearSnippetSelections(${patient.id})">
                                            Clear
                                        </button>
                                        ` : ''}
                                        
                                        <div class="copy-feedback" id="copyFeedback_${patient.id}">✓ Copied!</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Tracking - COLLAPSIBLE -->
                    <div class="collapsible-section" data-section-id="time" draggable="true"
                         ondragstart="handleSectionDragStart(event, ${patient.id})"
                         ondragend="handleSectionDragEnd(event)"
                         ondragover="handleSectionDragOver(event)"
                         ondragleave="handleSectionDragLeave(event)"
                         ondrop="handleSectionDrop(event, ${patient.id})">
                        <div class="section-header" data-section="${patient.id}_time" onclick="toggleSection(${patient.id}, 'time')">
                            <span class="section-drag-handle" onclick="event.stopPropagation()">⋮⋮</span>
                            ⏱️ Treatment Time Tracking
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="section-content">
                            <div class="field-grid">
                                <div class="field-group">
                                    <label class="field-label">Start Time (24hr) ✏️</label>
                                    <input type="text" class="field-input ${startTimeClass}" value="${patient.startTime || ''}" 
                                        placeholder="HHMM (e.g., 0800)"
                                        onchange="updatePatient(${patient.id}, 'startTime', this.value)"
                                        onblur="updatePatient(${patient.id}, 'startTime', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">
                                        End Time (24hr) ✏️
                                        ${calcEstimatedEndTime(patient.startTime, patient.rxTime) ? `
                                        <span style="font-size: 0.85em; color: #667eea; font-weight: 600; margin-left: 8px;">
                                            📍 Est: ${calcEstimatedEndTime(patient.startTime, patient.rxTime)}
                                        </span>
                                        ` : ''}
                                    </label>
                                    <input type="text" class="field-input ${endTimeClass}" value="${patient.endTime || ''}" 
                                        placeholder="HHMM (e.g., 1130)"
                                        onchange="updatePatient(${patient.id}, 'endTime', this.value)"
                                        onblur="updatePatient(${patient.id}, 'endTime', this.value)">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">📊 Actual Duration</label>
                                    <input type="text" class="field-input calculated-field" value="${actualDuration}" readonly placeholder="Auto">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">⚠️ Time +/- Rx</label>
                                    <input type="text" class="field-input calculated-field ${timeCheck.cssClass}" 
                                        value="${timeCheck.shortfall}" readonly placeholder="Auto">
                                </div>
                                ${timeCheck.percentage ? `
                                <div class="field-group">
                                    <label class="field-label">📊 % of Scheduled Time</label>
                                    <input type="text" class="field-input calculated-field" 
                                        style="font-weight: 700; font-size: 1.1em; color: ${getPercentageColor(timeCheck.percentage)};" 
                                        value="${timeCheck.percentage}%" readonly placeholder="Auto">
                                </div>
                                ` : ''}
                            </div>

                            ${timeCheck.isShort ? `
                            <div class="alert-box">
                                <h4>⚠️ Treatment Time Alert: More than 15 minutes short</h4>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="ettSigned_${patient.id}" 
                                        ${patient.ettSigned ? 'checked' : ''} 
                                        onchange="updatePatient(${patient.id}, 'ettSigned', this.checked)">
                                    <label for="ettSigned_${patient.id}">ETT Signed</label>
                                </div>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="timeEmail_${patient.id}" 
                                        onchange="updatePatient(${patient.id}, 'timeEmailSent', this.checked)">
                                    <label for="timeEmail_${patient.id}">Added to end of shift email</label>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Treatment Time Documentation Snippet -->
                            <div class="time-snippet-section" style="margin-top: 15px;">
                                <h3>📋 Treatment Time Documentation</h3>
                                <div class="snippet-box" id="timeSnippetBox_${patient.id}">
                                    ${generateCompleteTimeSnippet(patient).html || '<span style="color: #a0aec0; font-style: italic;">Enter start time, end time, and Rx time to generate documentation</span>'}
                                </div>
                                
                                ${timeCheck.isShort ? `
                                <h3 style="margin-top: 15px;">Early Termination Reason (Click to Add)</h3>
                                
                                <div class="snippet-options-container">
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('patient-request') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'patient-request')">
                                        Patient requested early termination.
                                    </div>
                                    
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('hypotension') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'hypotension')">
                                        Treatment ended early due to hypotension.
                                    </div>
                                    
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('cramping') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'cramping')">
                                        Treatment ended early due to cramping.
                                    </div>
                                    
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('nausea') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'nausea')">
                                        Treatment ended early due to nausea/vomiting.
                                    </div>
                                    
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('patient-unstable') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'patient-unstable')">
                                        Patient became unstable, treatment discontinued.
                                    </div>
                                    
                                    <div class="snippet-option ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.includes('ett-signed') ? 'selected' : ''}" 
                                        onclick="toggleTimeSnippet(${patient.id}, 'ett-signed')">
                                        ETT signed by patient.
                                    </div>
                                </div>
                                ` : ''}
                                
                                <button class="copy-snippet-btn" onclick="copyTimeSnippet(${patient.id})" 
                                    ${!generateCompleteTimeSnippet(patient).text ? 'disabled' : ''}>
                                    📋 Copy Time Documentation
                                </button>
                                
                                ${patient.selectedTimeSnippets && patient.selectedTimeSnippets.length > 0 ? `
                                <button class="clear-snippet-btn" onclick="clearTimeSnippetSelections(${patient.id})">
                                    Clear Selections
                                </button>
                                ` : ''}
                                
                                <div class="copy-feedback" id="copyTimeFeedback_${patient.id}">✓ Copied to clipboard!</div>
                            </div>
                        </div>
                    </div>

                    </div><!-- End Sections Container -->

                    <!-- Delete Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-danger" onclick="removePatient(${patient.id})">
                            🗑️ Delete ${patient.name}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTabContents() {
            const container = document.getElementById('tabContents');
            container.innerHTML = state.patients.map(p => {
                const active = p.id === state.activePatientId ? 'active' : '';
                return `<div class="tab-content ${active}" id="tab_${p.id}">
                    ${renderPatientCard(p)}
                </div>`;
            }).join('');
            // Apply saved section order after rendering
            reorderSectionsInDOM();
        }

        function renderAssignmentInfo() {
            const container = document.getElementById('assignmentInfoBar');
            const activePatient = state.patients.find(p => p.id === state.activePatientId);
            
            if (!activePatient || (!activePatient.section && !activePatient.technician && !activePatient.pod && !activePatient.chair)) {
                container.classList.remove('visible');
                return;
            }
            
            let html = '';
            
            if (activePatient.section) {
                html += `
                    <div class="assignment-info-item">
                        <span class="assignment-info-label">🏥 Section:</span>
                        <span class="assignment-info-value section">${activePatient.section}</span>
                    </div>
                `;
            }
            
            if (activePatient.technician) {
                html += `
                    <div class="assignment-info-item">
                        <span class="assignment-info-label">👤 Technician:</span>
                        <span class="assignment-info-value tech">${activePatient.technician}</span>
                    </div>
                `;
            }
            
            if (activePatient.pod) {
                html += `
                    <div class="assignment-info-item">
                        <span class="assignment-info-label">📍 Pod:</span>
                        <span class="assignment-info-value pod">Pod ${activePatient.pod}</span>
                    </div>
                `;
            }
            
            if (activePatient.chair) {
                html += `
                    <div class="assignment-info-item">
                        <span class="assignment-info-label">💺 Chair:</span>
                        <span class="assignment-info-value chair">Chair ${activePatient.chair}</span>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            container.classList.add('visible');
        }

        function renderAll() {
            renderSummary();
            renderTabs();
            renderTabContents();
        }
        
        // ===== DRAWER CONTROL FUNCTIONS =====
        let drawerState = {
            bfr: 350,
            ufGoal: 2.0,
            generatedSnippet: '',
            selectedOptions: new Set(),
            openCategory: null
        };
        
        function toggleDrawer() {
            const overlay = document.getElementById('drawerOverlay');
            const panel = document.getElementById('drawerPanel');

            overlay.classList.toggle('open');
            panel.classList.toggle('open');

            // When drawer opens, render tag filters and auto-fill data
            if (panel.classList.contains('open')) {
                // Render tag filters
                renderDrawerTags();

                // Render dynamic snippets from snippetState
                renderDrawerSnippetsFromState();

                // Auto-fill BFR and UF Goal from active patient data
                if (state.activePatientId) {
                    const patient = state.patients.find(p => p.id === state.activePatientId);
                    if (patient) {
                        // Auto-fill BFR if patient has bfr data
                        if (patient.bfr) {
                            const bfrValue = parseFloat(patient.bfr);
                            if (!isNaN(bfrValue)) {
                                drawerState.bfr = bfrValue;
                                document.getElementById('bfrValue').textContent = bfrValue;
                                const bfrSlider = document.querySelector('#category-treatment input[type="range"]');
                                if (bfrSlider) bfrSlider.value = bfrValue;
                            }
                        }
                        // Auto-fill UF Goal if patient has goalUF data
                        if (patient.goalUF) {
                            const ufValue = parseFloat(patient.goalUF);
                            if (!isNaN(ufValue)) {
                                drawerState.ufGoal = ufValue;
                                document.getElementById('ufGoalValue').textContent = ufValue + ' kg';
                                const ufSlider = document.querySelectorAll('#category-treatment input[type="range"]')[1];
                                if (ufSlider) ufSlider.value = ufValue;
                            }
                        }
                    }
                }
            }
        }
        
        function toggleCategory(categoryName) {
            const categories = document.querySelectorAll('.snippet-category-body');
            const headers = document.querySelectorAll('.snippet-category-header');
            const targetCategory = document.getElementById(`category-${categoryName}`);
            const targetHeader = document.querySelector(`[data-category="${categoryName}"]`);
            
            // Close all categories
            categories.forEach(cat => cat.classList.remove('open'));
            headers.forEach(header => header.classList.remove('active'));
            
            // Open selected category if it wasn't already open
            if (drawerState.openCategory !== categoryName) {
                targetCategory.classList.add('open');
                targetHeader.classList.add('active');
                drawerState.openCategory = categoryName;
            } else {
                drawerState.openCategory = null;
            }
        }
        
        function toggleSnippetOption(optionText) {
            if (drawerState.selectedOptions.has(optionText)) {
                drawerState.selectedOptions.delete(optionText);
            } else {
                drawerState.selectedOptions.add(optionText);
            }
            updateGeneratedSnippet();
            updateSnippetUI();
        }
        
        function updateSlider(type, value) {
            drawerState[type] = parseFloat(value);
            document.getElementById(`${type}Value`).textContent = type === 'bfr' ? value : `${value} kg`;
            updateGeneratedSnippet();
        }
        
        function updateGeneratedSnippet() {
            const snippets = Array.from(drawerState.selectedOptions);
            
            // Add BFR and UF info if relevant options are selected
            let finalSnippet = snippets.join(' ');
            
            // Replace placeholders with actual values
            finalSnippet = finalSnippet.replace(/\[BFR\]/g, drawerState.bfr);
            finalSnippet = finalSnippet.replace(/\[UF Goal\]/g, drawerState.ufGoal);
            
            drawerState.generatedSnippet = finalSnippet;
            document.getElementById('generatedSnippetText').textContent = finalSnippet || 'Select options to build your charting note...';
        }
        
        function updateSnippetUI() {
            const options = document.querySelectorAll('.snippet-builder-option');
            options.forEach(option => {
                const text = option.textContent.trim();
                if (drawerState.selectedOptions.has(text)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }
        
        function copyDrawerSnippet() {
            if (!drawerState.generatedSnippet) {
                alert('No snippet to copy! Select some options first.');
                return;
            }
            
            navigator.clipboard.writeText(drawerState.generatedSnippet).then(() => {
                const btn = document.getElementById('copyDrawerBtn');
                const originalText = btn.textContent;
                btn.textContent = '✓ Copied!';
                btn.style.background = '#48bb78';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            });
        }
        
        function clearDrawerSnippet() {
            drawerState.selectedOptions.clear();
            drawerState.generatedSnippet = '';
            updateGeneratedSnippet();
            updateSnippetUI();
        }
        
        function updateDrawerWeights() {
            const preWeight = parseFloat(document.getElementById('drawerPreWeight').value) || 0;
            const dryWeight = parseFloat(document.getElementById('drawerDryWeight').value) || 0;

            if (preWeight > 0 && dryWeight > 0) {
                // Calculate Pre Over DW
                const preOverDW = preWeight - dryWeight;
                document.getElementById('drawerPreOverDW').value = preOverDW.toFixed(1) + ' kg';

                // Calculate UF Goal (Pre Over DW + 0.4)
                const ufGoal = preOverDW + 0.4;
                document.getElementById('drawerUFGoal').value = ufGoal.toFixed(1) + ' kg';

                // Calculate Target Weight (Pre Weight - UF Goal)
                const targetWeight = preWeight - ufGoal;
                document.getElementById('drawerTargetWeight').value = targetWeight.toFixed(1) + ' kg';
            } else {
                document.getElementById('drawerPreOverDW').value = '';
                document.getElementById('drawerUFGoal').value = '';
                document.getElementById('drawerTargetWeight').value = '';
            }
        }

        // ========== DRAWER TAG FILTER FUNCTIONS ==========

        // Render tag filter list in drawer
        function renderDrawerTags() {
            const container = document.getElementById('drawerTagsList');
            const clearBtn = document.getElementById('drawerTagClearBtn');
            if (!container) return;

            // Load snippet data if not already loaded
            if (snippetState.configurations.length === 0) {
                const saved = localStorage.getItem('hd_snippet_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    snippetState.configurations = data.configurations || [];
                    snippetState.activeConfigId = data.activeConfigId || null;
                }
            }

            updateAllTags();

            if (snippetState.allTags.length === 0) {
                container.innerHTML = '<span style="color: #94a3b8; font-style: italic; font-size: 12px;">No tags defined yet. Add tags in Operations > Snippets.</span>';
                return;
            }

            container.innerHTML = snippetState.allTags.map(tag => `
                <span class="drawer-tag-filter ${snippetState.selectedTags.has(tag) ? 'active' : ''}"
                    onclick="toggleDrawerTagFilter('${tag}')">${tag}</span>
            `).join('');

            // Show/hide clear button
            if (clearBtn) {
                clearBtn.style.display = snippetState.selectedTags.size > 0 ? 'inline' : 'none';
            }
        }

        // Toggle a tag filter in the drawer
        function toggleDrawerTagFilter(tag) {
            if (snippetState.selectedTags.has(tag)) {
                snippetState.selectedTags.delete(tag);
            } else {
                snippetState.selectedTags.add(tag);
            }
            renderDrawerTags();
            filterDrawerSnippetsByTags();
        }

        // Clear all tag filters
        function clearDrawerTagFilter() {
            snippetState.selectedTags.clear();
            renderDrawerTags();
            filterDrawerSnippetsByTags();
        }

        // Filter snippets in drawer based on selected tags
        function filterDrawerSnippetsByTags() {
            const selectedTags = Array.from(snippetState.selectedTags);
            const allOptions = document.querySelectorAll('.drawer-body .snippet-builder-option');

            // If no tags selected, show all snippets
            if (selectedTags.length === 0) {
                allOptions.forEach(option => {
                    option.style.display = '';
                });
                // Show all categories
                document.querySelectorAll('.drawer-body .snippet-category').forEach(cat => {
                    cat.style.display = '';
                });
                return;
            }

            // Get snippets that match selected tags
            const config = getActiveSnippetConfig();
            if (!config) return;

            const matchingTexts = new Set();
            config.sections.forEach(section => {
                section.snippets.forEach(snippet => {
                    const snippetTags = snippet.tags || [];
                    const hasMatchingTag = selectedTags.some(tag => snippetTags.includes(tag));
                    if (hasMatchingTag) {
                        matchingTexts.add(snippet.text);
                    }
                });
            });

            // Hide/show snippet options based on tag match
            allOptions.forEach(option => {
                const text = option.textContent.trim();
                const shouldShow = matchingTexts.has(text);
                option.style.display = shouldShow ? '' : 'none';
            });

            // Hide categories that have no visible snippets
            document.querySelectorAll('.drawer-body .snippet-category').forEach(cat => {
                const visibleOptions = cat.querySelectorAll('.snippet-builder-option:not([style*="display: none"])');
                cat.style.display = visibleOptions.length > 0 ? '' : 'none';
            });
        }

        // Dynamically render drawer snippets from snippetState
        function renderDrawerSnippetsFromState() {
            // Load snippet data if not already loaded
            if (snippetState.configurations.length === 0) {
                const saved = localStorage.getItem('hd_snippet_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    snippetState.configurations = data.configurations || [];
                    snippetState.activeConfigId = data.activeConfigId || null;
                }
            }

            const config = getActiveSnippetConfig();
            if (!config) {
                console.log('No active snippet configuration found');
                return;
            }

            // Find the drawer body container where dynamic snippets should be rendered
            const drawerBody = document.querySelector('.drawer-body');
            if (!drawerBody) return;

            // Find the tag filter section - we'll insert dynamic categories after it
            const tagFilter = document.getElementById('drawerTagsFilter');
            if (!tagFilter) return;

            // Remove all existing dynamically-generated snippet categories (but keep the static elements)
            const existingDynamicCategories = drawerBody.querySelectorAll('.snippet-category.dynamic-category');
            existingDynamicCategories.forEach(cat => cat.remove());

            // Sort sections by order
            const sortedSections = [...config.sections].sort((a, b) => a.order - b.order);

            // Generate HTML for each section
            sortedSections.forEach(section => {
                // Sort snippets within each section
                const sortedSnippets = [...section.snippets].sort((a, b) => a.order - b.order);

                if (sortedSnippets.length === 0) return; // Skip empty sections

                // Create category container
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'snippet-category dynamic-category';

                // Generate a safe category ID from section name
                const categoryId = `dynamic-${section.id}`;

                // Create header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'snippet-category-header';
                headerDiv.setAttribute('data-category', categoryId);
                headerDiv.onclick = () => toggleCategory(categoryId);
                headerDiv.innerHTML = `
                    <span>${section.icon || '📝'} ${section.name}</span>
                    <span>▼</span>
                `;

                // Create body
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'snippet-category-body';
                bodyDiv.id = `category-${categoryId}`;

                // Add snippets to body
                sortedSnippets.forEach(snippet => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'snippet-builder-option';
                    optionDiv.textContent = snippet.text;
                    optionDiv.onclick = function() {
                        toggleSnippetOption(this.textContent.trim());
                    };

                    // Store tags as data attribute for filtering
                    if (snippet.tags && snippet.tags.length > 0) {
                        optionDiv.setAttribute('data-tags', JSON.stringify(snippet.tags));
                    }

                    bodyDiv.appendChild(optionDiv);
                });

                categoryDiv.appendChild(headerDiv);
                categoryDiv.appendChild(bodyDiv);

                // Append to drawer body after tag filter
                drawerBody.appendChild(categoryDiv);
            });

            // Apply any active tag filters
            filterDrawerSnippetsByTags();
        }

        // Auto-update countdown timers every 30 seconds
        setInterval(() => {
            if (state.patients.length > 0) {
                renderTabs();
            }
        }, 30000);
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            loadTheme(); // Load theme first to avoid flash
            loadShifts(); // Load selected shifts
            loadTechnicians();
            loadSection();
            loadSectionOrder(); // Load saved section order
            initFloatingNav(); // Initialize floating navigation sidebar
            showImportModal(); // Show import modal with section selector on page load
            // Auto-save is OFF by default - user must enable it to prevent overwriting from other sessions

            // Check if we're returning from a refresh (auto-load from server)
            const pendingServerLoad = localStorage.getItem('hd_pending_server_load');
            if (pendingServerLoad === 'true') {
                // Clear the flag first
                localStorage.removeItem('hd_pending_server_load');
                // Auto-load data from server (skip import modal)
                const loaded = await autoLoadFromServer();
                if (!loaded) {
                    // If auto-load fails, show import modal as fallback
                    showImportModal();
                }
            } else {
                showImportModal(); // Show import modal with section selector on page load
            }

            startAutoSave(); // Start auto-save (every 60 seconds)
        });
    </script>
    
    <!-- Floating Buttons -->
    <div class="floating-buttons">
        <button class="floating-btn" onclick="toggleDrawer()">
            📋 Charting
        </button>
        <button class="floating-btn" onclick="openBulkAssign()">
            👥 Quick Assign
        </button>
        <button class="floating-btn" onclick="openQuickNotes()">
            📝 Quick Notes
        </button>
        <button class="floating-btn" onclick="saveAll()">
            💾 Save All
        </button>
    </div>

    <!-- Bottom Center Floating Button -->
    <button class="floating-btn-bottom" onclick="openTimestampModal()">
        🩺 HD Flowsheet Quick Notes
    </button>

    <!-- Timestamp Modal -->
    <div class="timestamp-modal-overlay" id="timestampModal">
        <div class="timestamp-modal">
            <div class="timestamp-modal-header">
                <div>
                    <div class="timestamp-modal-title">🩺 HD Flowsheet Quick Notes</div>
                    <div class="timestamp-modal-time" id="timestampCurrentTime">Current Time: --:-- PM (Phoenix, AZ)</div>
                </div>
                <button class="timestamp-modal-close" onclick="closeTimestampModal()">×</button>
            </div>
            <div class="timestamp-modal-body">
                <div class="timestamp-section-title">Select Patient:</div>
                <div class="timestamp-patient-grid" id="timestampPatientGrid">
                    <!-- Populated by JS -->
                </div>

                <div class="timestamp-selected-display" id="timestampSelectedDisplay">
                    Selected: <span id="timestampSelectedText">None</span>
                </div>

                <div class="timestamp-section-title">Event (click to timestamp):</div>
                <div class="timestamp-event-grid" id="timestampEventGrid">
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Hypotension')" disabled>Hypotension</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Hypertension')" disabled>Hypertension</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Imodium')" disabled>Imodium</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Tylenol')" disabled>Tylenol</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Midodrine')" disabled>Midodrine</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('UF min')" disabled>UF min</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Temp up')" disabled>Temp up</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Temp down')" disabled>Temp down</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('100 ml bolus')" disabled>100 ml bolus</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('BP drop > 20')" disabled>BP drop > 20</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('Cramping')" disabled>Cramping</button>
                    <button class="timestamp-event-btn" onclick="logTimestampEvent('UF goal increase')" disabled>UF goal increase</button>
                </div>

                <div class="timestamp-log-section">
                    <div class="timestamp-section-title">📋 Timestamp Log:</div>
                    <div class="timestamp-log-list" id="timestampLogList">
                        <div class="timestamp-log-empty">No timestamps logged yet</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div class="drawer-overlay" id="drawerOverlay" onclick="toggleDrawer()"></div>
    
    <!-- Drawer Panel -->
    <div class="drawer-panel" id="drawerPanel">
        <div class="drawer-header">
            <div class="drawer-header-content">
                <div class="drawer-title">📋 Charting Snippet Builder</div>
                <button class="drawer-close-btn" onclick="toggleDrawer()">×</button>
            </div>
        </div>
        
        <div class="drawer-body">
            <!-- Generated Snippet Display (Sticky) -->
            <div class="generated-snippet-display">
                <div class="generated-snippet-title">Generated Note:</div>
                <div class="generated-snippet-text" id="generatedSnippetText">
                    Select options below to build your charting note...
                </div>
                <div class="generated-snippet-actions">
                    <button class="drawer-btn-primary" id="copyDrawerBtn" onclick="copyDrawerSnippet()">
                        📋 Copy to Clipboard
                    </button>
                    <button class="drawer-btn-secondary" onclick="clearDrawerSnippet()">
                        🗑️ Clear
                    </button>
                </div>

                <!-- Quick Access Snippet - Always Visible -->
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e2e8f0;">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())"
                        style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: 600; text-align: center;">
                        Access visible and secure. Care ongoing.
                    </div>
                </div>
            </div>

            <!-- Tag Filter Section -->
            <div class="drawer-tags-filter" id="drawerTagsFilter">
                <div class="drawer-tags-filter-title">
                    Filter by Tags
                    <span class="drawer-tag-clear" onclick="clearDrawerTagFilter()" id="drawerTagClearBtn" style="display: none;">Clear All</span>
                </div>
                <div class="drawer-tags-filter-list" id="drawerTagsList">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Weight & UF Management Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="weight" onclick="toggleCategory('weight')">
                    <span>⚖️ Weight & UF Management</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-weight">
                    <div style="margin-bottom: 15px;">
                        <label class="snippet-slider-label">Pre Weight (kg)</label>
                        <input type="number" id="drawerPreWeight" step="0.1" placeholder="Pre Weight" 
                            style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;"
                            oninput="updateDrawerWeights()">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="snippet-slider-label">Dry Weight (kg)</label>
                        <input type="number" id="drawerDryWeight" step="0.1" placeholder="Dry Weight" 
                            style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;"
                            oninput="updateDrawerWeights()">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="snippet-slider-label">Pre Over DW</label>
                        <input type="text" id="drawerPreOverDW" readonly class="locked-calc-field"
                            style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;"
                            placeholder="Auto-calculated">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="snippet-slider-label">UF Goal (kg)</label>
                        <input type="text" id="drawerUFGoal" readonly class="locked-calc-field"
                            style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;"
                            placeholder="Pre Over DW + 0.4">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="snippet-slider-label">Target Weight (kg)</label>
                        <input type="text" id="drawerTargetWeight" readonly class="locked-calc-field"
                            style="width: 100%; padding: 8px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 0.9em;"
                            placeholder="Pre Weight - UF Goal">
                    </div>
                    
                    <div style="padding: 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 6px; font-size: 0.85em; color: #1e40af; margin-top: 15px;">
                        <strong>Auto-Calculations:</strong><br>
                        • Pre Over DW = Pre Weight - Dry Weight<br>
                        • UF Goal = Pre Over DW + 0.4 kg<br>
                        • Target Weight = Pre Weight - UF Goal
                    </div>
                    
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())" style="margin-top: 15px;">
                        Pt denies any pains / SOB. No other voiced concerns.
                    </div>
                </div>
            </div>
            
            <!-- Pre Dialysis Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="predialysis" onclick="toggleCategory('predialysis')">
                    <span>🏥 Pre Dialysis</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-predialysis">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Weight and goal reviewed and verified with pt.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt denies any pains / SOB. No other voiced concerns.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        5 mg Midodrine given for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        T to 36.5 for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        T to 36.0 for BP support.
                    </div>
                </div>
            </div>

            <!-- Treatment Initiated Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="treatment" onclick="toggleCategory('treatment')">
                    <span>💉 Treatment Initiated</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-treatment">
                    <div class="snippet-slider-group">
                        <label class="snippet-slider-label">
                            Blood Flow Rate: <span class="snippet-slider-value" id="bfrValue">350</span>
                        </label>
                        <input type="range" class="snippet-slider" min="200" max="500" step="10" value="350" 
                            oninput="updateSlider('bfr', this.value)">
                    </div>
                    
                    <div class="snippet-slider-group">
                        <label class="snippet-slider-label">
                            UF Goal: <span class="snippet-slider-value" id="ufGoalValue">2.0 kg</span>
                        </label>
                        <input type="range" class="snippet-slider" min="0" max="6" step="0.1" value="2.0" 
                            oninput="updateSlider('ufGoal', this.value)">
                    </div>
                    
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Treatment initiated per orders. BFR [BFR], UF goal [UF Goal].
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt tolerated treatment initiation without complaint.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Access cannulated without difficulty.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Good arterial/venous flow noted.
                    </div>
                </div>
            </div>

            <!-- During Treatment Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="duringtreatment" onclick="toggleCategory('duringtreatment')">
                    <span>⏱️ During Treatment</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-duringtreatment">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt experiencing cramping.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        UF to minimum.
                    </div>
                </div>
            </div>

            <!-- Hypertension Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="hypertension" onclick="toggleCategory('hypertension')">
                    <span>🔴 Hypertension Management</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-hypertension">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt BP elevated.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt denies any chest pain, SOB, dizziness or headache.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt reports taking his BP meds before tx.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        0.1 mg clonidine given for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        BP stabilized after intervention.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Will continue to monitor BP closely.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        T to 37 for BP support.
                    </div>
                </div>
            </div>

            <!-- Hypotension Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="hypotension" onclick="toggleCategory('hypotension')">
                    <span>🔵 Hypotension Management</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-hypotension">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt experiencing hypotension during treatment.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt BP low side.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt experienced > 20 pt SBP drop.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt experiencing side effects d/t hypotension - dizzy / light headedness.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt denies any s/s of hypotension such as light headedness, chest pain or SOB.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        5 mg Midodrine given for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        100mL NS bolus given for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        BP stabilized, treatment continued.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        UF to min for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        T to 36.5 for BP support.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        T already at 36.0.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        MAP remains > 70.
                    </div>
                </div>
            </div>

            <!-- No Changes Needed Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="nochanges" onclick="toggleCategory('nochanges')">
                    <span>✅ No Changes / Stable</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-nochanges">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt stable throughout treatment.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        No complaints voiced.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Tolerating treatment well without intervention.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        VS within normal limits.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        No changes / Stable.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt resting comfortably in chair watching TV.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt resting comfortably in chair playing with phone.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt sleeping comfortably with head back and legs elevated. Chest rising and falling appropriately. No signs of distress.
                    </div>
                </div>
            </div>

            <!-- Access/Lines Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="access" onclick="toggleCategory('access')">
                    <span>🩸 Access & Lines</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-access">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Fistula assessment: good thrill and bruit noted.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Graft assessment: patent, no signs of infection.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Catheter site clean, dry, intact.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Dressing changed per protocol.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        No signs of bleeding or hematoma at access site.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Good hemostasis achieved post-treatment.
                    </div>
                </div>
            </div>
            
            <!-- Fluid Overload Category -->
            <div class="snippet-category">
                <div class="snippet-category-header" data-category="fluid" onclick="toggleCategory('fluid')">
                    <span>💧 Fluid Management</span>
                    <span>▼</span>
                </div>
                <div class="snippet-category-body" id="category-fluid">
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        IDWG within acceptable range.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Significant IDWG noted, fluid restriction education reinforced.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        UF goal met without difficulty.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Pt reports improved adherence to fluid restriction.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Dietitian consult recommended for fluid management.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Signs/symptoms of fluid overload: SOB, edema, JVD.
                    </div>
                    <div class="snippet-builder-option" onclick="toggleSnippetOption(this.textContent.trim())">
                        Post-treatment weight at/near dry weight.
                    </div>
                </div>
            </div>
            
        </div>
        <!-- Settings Modal -->
        <div class="settings-modal-overlay" id="settingsModal">
            <div class="settings-modal">
                <div class="modal-header">
                    <span>⚙️ Settings</span>
                    <button class="modal-close" onclick="closeSettingsModal()">×</button>
                </div>
                
                <!-- Theme Selector Section -->
                <div class="theme-selector-section">
                    <div class="theme-selector-title">🎨 Color Theme</div>
                    <div class="theme-grid">
                        <div class="theme-option" data-theme-value="clinical-blue" onclick="setTheme('clinical-blue')">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);"></div>
                            <div class="theme-option-name">Clinical Blue</div>
                        </div>
                        <div class="theme-option" data-theme-value="slate" onclick="setTheme('slate')">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #475569 0%, #334155 100%);"></div>
                            <div class="theme-option-name">Slate Professional</div>
                        </div>
                        <div class="theme-option" data-theme-value="ultra-light" onclick="setTheme('ultra-light')">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #2a7de1 0%, #1c5ab0 100%);"></div>
                            <div class="theme-option-name">Ultra-Light Clinical</div>
                        </div>
                        <div class="theme-option" data-theme-value="warm" onclick="setTheme('warm')">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #a8a29e 0%, #78716c 100%);"></div>
                            <div class="theme-option-name">Warm Neutral</div>
                        </div>
                        <div class="theme-option" data-theme-value="navy" onclick="setTheme('navy')">
                            <div class="theme-preview" style="background: linear-gradient(135deg, #2563eb 0%, #1e3a5f 100%);"></div>
                            <div class="theme-option-name">Navy Professional</div>
                        </div>
                    </div>
                </div>

                <!-- Data Management Section -->
                <div class="theme-selector-section">
                    <div class="theme-selector-title">💾 Data Management</div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn-add" onclick="saveAll()" style="flex: 1; padding: 12px;">
                            💾 Save All
                        </button>
                        <button class="btn-add" onclick="loadFromServer()" style="flex: 1; padding: 12px; background: #10b981;">
                            📂 Load from Server
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn-add" onclick="exportToFile()" style="flex: 1; padding: 12px; background: #6366f1;">
                            📥 Export to File
                        </button>
                        <button class="btn-add" onclick="document.getElementById('importFile').click()" style="flex: 1; padding: 12px; background: #8b5cf6;">
                            📤 Import from File
                        </button>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importFromFile(event)">
                    </div>
                    <div id="saveStatus" style="text-align: center; font-size: 0.85em; color: #6b7280; min-height: 20px;"></div>
                </div>

                <!-- Technicians Section -->
                <div class="theme-selector-title">👤 Manage Technicians</div>
                
                <button class="btn-clear-all" onclick="clearAllTechs()">🗑️ Clear All Techs</button>
                
                <div class="tech-list" id="techList">
                    <!-- Populated by JS -->
                </div>
                
                <div class="add-tech-section">
                    <div class="add-tech-title">➕ Add New Technician</div>
                    <div class="add-tech-form">
                        <input type="text" id="newTechName" class="add-tech-input" placeholder="Technician name (e.g., Lisa K.)">
                        <div class="form-row">
                            <select id="newTechPod" class="add-tech-select">
                                <option value="">Assign to Pod...</option>
                                <option value="1">Pod 1</option>
                                <option value="2">Pod 2</option>
                                <option value="3">Pod 3</option>
                                <option value="4">Pod 4</option>
                                <option value="5">Pod 5</option>
                                <option value="6">Pod 6</option>
                            </select>
                            <button class="btn-add" onclick="addTechnician()">+ Add Tech</button>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <div class="info-box-title">💡 Tech-Pod Assignment:</div>
                    <ul>
                        <li><strong>Each tech is assigned to ONE pod</strong></li>
                        <li>When you assign patient → tech, the pod auto-fills</li>
                        <li>Edit tech to change their pod assignment</li>
                        <li>Delete removes tech from system</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Bulk Assign Modal -->
        <div class="bulk-assign-overlay" id="bulkAssignModal">
            <div class="bulk-assign-modal">
                <div class="bulk-assign-header">
                    <div class="bulk-assign-title">👥 Quick Assign - Tech & Chair</div>
                    <button class="bulk-assign-close" onclick="closeBulkAssign()">×</button>
                </div>
                
                <!-- Shift Tabs in Bulk Assign -->
                <div class="bulk-assign-shift-tabs" id="bulkAssignShiftTabs">
                    <!-- Populated by JS -->
                </div>
                
                <div class="quick-fill-section">
                    <div class="quick-fill-title">🪄 Quick Fill Selected Patients:</div>
                    <div class="quick-fill-row">
                        <div class="quick-fill-group">
                            <span class="quick-fill-label">Tech:</span>
                            <select class="quick-fill-select" id="quickFillTech">
                                <option value="">Select Tech...</option>
                            </select>
                        </div>
                        <div class="quick-fill-group">
                            <span class="quick-fill-label">Chair Start:</span>
                            <select class="quick-fill-select" id="quickFillChairStart">
                                <option value="">Select Chair...</option>
                            </select>
                        </div>
                        <button class="quick-fill-btn primary" onclick="applyQuickFill()">✓ Apply to Selected</button>
                        <button class="quick-fill-btn secondary" onclick="selectAllPatients()">Select All</button>
                        <button class="quick-fill-btn secondary" onclick="clearAllSelections()">Clear All</button>
                    </div>
                </div>
                
                <div class="bulk-assign-body">
                    <table class="patient-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">☑</th>
                                <th style="width: 100px;">Patient</th>
                                <th>Technician</th>
                                <th style="width: 80px;">Pod</th>
                                <th>Chair</th>
                            </tr>
                        </thead>
                        <tbody id="bulkAssignTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="bulk-assign-footer">
                    <div class="bulk-assign-stats">
                        <span id="selectedCount">0</span> selected | <strong id="assignedCount">0</strong> assigned
                    </div>
                    <div class="bulk-assign-actions">
                        <button class="btn-cancel-bulk" onclick="closeBulkAssign()">Cancel</button>
                        <button class="btn-save-all" onclick="saveBulkAssignments()">💾 Save All Changes</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Notes Modal -->
        <div class="quick-notes-overlay" id="quickNotesModal">
            <div class="quick-notes-modal">
                <div class="quick-notes-header">
                    <div>
                        <div class="quick-notes-title">📝 Quick Notes</div>
                        <div class="quick-notes-patient" id="quickNotesPatient">Patient Name</div>
                    </div>
                    <button class="quick-notes-close" onclick="closeQuickNotes()">×</button>
                </div>
                <div class="quick-notes-body">
                    <textarea class="quick-notes-textarea" id="quickNotesText" placeholder="Jot down notes for this patient...&#10;&#10;Examples:&#10;• Patient requested early pickup&#10;• Family member called - update contact info&#10;• Check lab results next visit&#10;• Access site looks irritated - monitor"></textarea>
                </div>
                <div class="quick-notes-footer">
                    <span class="quick-notes-hint">💡 Notes are saved per patient</span>
                    <button class="quick-notes-save" onclick="saveQuickNotes()">💾 Save Notes</button>
                </div>
            </div>
        </div>
        
        <!-- Quick Chart Modal -->
        <div class="quick-chart-overlay" id="quickChartModal">
            <div class="quick-chart-modal">
                <div class="quick-chart-header">
                    <div>
                        <div class="quick-chart-title">⚡ Quick Chart</div>
                        <div class="quick-chart-patient" id="quickChartPatient">Patient Name</div>
                    </div>
                    <button class="quick-chart-close" onclick="closeQuickChart()">×</button>
                </div>
                <div class="quick-chart-body">
                    <!-- Weights Section -->
                    <div class="quick-chart-section">
                        <div class="quick-chart-section-title">⚖️ Weights</div>
                        <div class="quick-chart-grid four-col">
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">Dry Weight (kg)</label>
                                <input type="text" class="quick-chart-input" id="qc_dryWeight" placeholder="kg">
                            </div>
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">Pre Weight (kg)</label>
                                <input type="text" class="quick-chart-input" id="qc_preWeight" placeholder="kg">
                            </div>
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">Goal UF (kg)</label>
                                <input type="text" class="quick-chart-input" id="qc_goalUF" placeholder="kg">
                            </div>
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">Post Weight (kg)</label>
                                <input type="text" class="quick-chart-input" id="qc_postWeight" placeholder="kg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Times Section -->
                    <div class="quick-chart-section">
                        <div class="quick-chart-section-title">⏱️ Times</div>
                        <div class="quick-chart-grid">
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">Start Time (24hr)</label>
                                <input type="text" class="quick-chart-input" id="qc_startTime" placeholder="HHMM">
                            </div>
                            <div class="quick-chart-field">
                                <label class="quick-chart-label">End Time (24hr)</label>
                                <input type="text" class="quick-chart-input" id="qc_endTime" placeholder="HHMM">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Checklist Section -->
                    <div class="quick-chart-section">
                        <div class="quick-chart-section-title">✓ Checklist</div>
                        <div class="quick-chart-checks">
                            <label class="quick-chart-check" id="qc_preCheck_label">
                                <input type="checkbox" id="qc_preCheck" onchange="toggleQuickChartCheck('preCheck')">
                                Pre Check
                            </label>
                            <label class="quick-chart-check" id="qc_thirtyMinCheck_label">
                                <input type="checkbox" id="qc_thirtyMinCheck" onchange="toggleQuickChartCheck('thirtyMinCheck')">
                                30 Min Check
                            </label>
                            <label class="quick-chart-check" id="qc_medsComplete_label">
                                <input type="checkbox" id="qc_medsComplete" onchange="toggleQuickChartCheck('medsComplete')">
                                Meds Complete
                            </label>
                            <label class="quick-chart-check" id="qc_abxIDPN_label">
                                <input type="checkbox" id="qc_abxIDPN" onchange="toggleQuickChartCheck('abxIDPN')">
                                Abx/IDPN
                            </label>
                            <label class="quick-chart-check" id="qc_statLabs_label">
                                <input type="checkbox" id="qc_statLabs" onchange="toggleQuickChartCheck('statLabs')">
                                STAT Labs
                            </label>
                            <label class="quick-chart-check" id="qc_missedTx_label">
                                <input type="checkbox" id="qc_missedTx" onchange="toggleQuickChartCheck('missedTx')">
                                Missed Tx
                            </label>
                            <label class="quick-chart-check" id="qc_whiteboard_label">
                                <input type="checkbox" id="qc_whiteboard" onchange="toggleQuickChartCheck('whiteboard')">
                                Whiteboard
                            </label>
                            <label class="quick-chart-check" id="qc_labsPrep_label">
                                <input type="checkbox" id="qc_labsPrep" onchange="toggleQuickChartCheck('labsPrep')">
                                Labs Prep
                            </label>
                            <label class="quick-chart-check" id="qc_ettSigned_label">
                                <input type="checkbox" id="qc_ettSigned" onchange="toggleQuickChartCheck('ettSigned')">
                                ETT Signed
                            </label>
                        </div>
                    </div>
                </div>
                <div class="quick-chart-footer">
                    <button class="quick-chart-btn cancel" onclick="closeQuickChart()">Cancel</button>
                    <button class="quick-chart-btn save" onclick="saveQuickChart()">💾 Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
